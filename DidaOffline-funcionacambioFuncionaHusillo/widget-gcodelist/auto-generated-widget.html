<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <title>Widget / Gcode v8</title>

    <!-- ChiliPeppr is based on bootstrap CSS. -->
    <link rel="stylesheet" type="text/css" href="//localhost/DidaOffline//css/bootstrap.min.css">

    <script type='text/javascript' src="//i2dcui.appspot.com/js/require.js"></script>

    <style type='text/css'>
        #root .btn:active,
        #root .btn.active {
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.425);
        }
        
        #com-chilipeppr-widget-gcodeviewer {}
        
        .gcode-sent {
            color: #E6D8BB;
            /* #faebcc; */
            background-color: #fcf8e3;
        }
        
        .gcode-queued {
            color: #BED0D9;
            /* #faebcc; */
            background-color: #d9edf7;
        }
        
        .gcode-written {
            color: #BBCCAD;
            /* #d6e9c6; */
            background-color: #dff0d8;
        }
        
        .gcode-completed {
            color: #000000;
        }
        
        .gcode-error {
            color: #000000;
            background-color: pink;
        }
        
        .gcode-executed {
            color: #000000;
            background-color: silver;
        }
        
        #com-chilipeppr-widget-gcodeviewer-popover-steps {
            font-size: 10px;
            /* min-width:300px; */
        }
        
        #com-chilipeppr-widget-gcodeviewer-popover-steps tr {
            vertical-align: top;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords-wrapper {
            position: relative;
            /* z-index:998; */
        }
        
        #com-chilipeppr-ws-gcode-wrapper #com-chilipeppr-widget-gcode-body.gcode-short-mode {
            height: 80px;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords {
            position: absolute;
            /* left: 0; */
            background: white;
            box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            z-index: 999;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords span {
            display: inline-block;
            padding: 0 6px;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords .coords-lbl {
            width: 45px;
            background: #d5d5d5;
            padding: 0 3px;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords .coords-axis {
            width: 15px;
            background: #f5f5f5;
            padding: 0 3px;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords-start {
            border-radius: 4px;
            border: 1px solid #adadad;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .com-chilipeppr-widget-gcodeviewer-coords-end {
            border-radius: 4px;
            border: 1px solid #adadad;
            border-top-width: 0;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        #com-chilipeppr-widget-gcodeviewer .btn-group {
            padding-left: 0;
        }
        
        #com-chilipeppr-widget-gcodeviewer .panel-heading {
            /* overflow-x: hidden; */
        }
        
        #com-chilipeppr-widget-gcode-body {
            padding: 0;
            margin: 0;
            height: 200px;
            overflow: scroll;
            overflow-x: hidden;
            position: inherit;
        }
        
        #com-chilipeppr-widget-gcode-feedrate {
            padding: 0;
            padding-top: 10px;
        }
        
        #com-chilipeppr-widget-gcode-tbl tr.gcode-rowhilite {
            background-color: #f5f5f5;
        }
        
        #com-chilipeppr-widget-gcode-tbl .gtools {
            position: relative;
        }
        
        #com-chilipeppr-widget-gcode-tbl tr.gcode-rowhilite:hover {
            background-color: #d5d5d5;
        }
        
        #com-chilipeppr-widget-gcode-tbl .feedrate-adjust {
            color: blue;
        }
        
        #com-chilipeppr-widget-gcode-body .popover {
            max-width: 450px;
            width: 450px;
        }
        
        .com-chilipeppr-widget-gcode .btn-group {
            padding-left: 6px;
        }
        
        .com-chilipeppr-widget-gcode .popover .popover-content {
            font-size: 10px;
        }
        
        .com-chilipeppr-widget-gcode .g {
            word-wrap: break-word;
            word-break: break-all;
        }
        
        .com-chilipeppr-widget-gcode .gcode-comment {
            color: silver;
            /* max-width:150px; */
            word-wrap: break-word;
            word-break: break-all;
            /* display: block; */
            text-overflow: ellipsis;
        }
        
        .com-chilipeppr-gcode-tip {
            background-color: #e9e9e9;
            padding: 3px;
            border-radius: 6px;
        }
        
        .com-chilipeppr-widget-gcode .btn .glyphicon-play {
            /* width: 50px; */
        }
        
        .com-chilipeppr-widget-gcode .btn .glyphicon-stop {
            /* width: 30px; */
        }
        
        #com-chilipeppr-widget-gcode-tbl .glyphicon-ok {
            color: #dddddd;
        }
        
        #com-chilipeppr-widget-gcode-feedrate .glyphicon {
            padding: 0;
            margin: 0;
        }
        
        #com-chilipeppr-widget-gcode-feedrate .btn {
            /* padding:2px; */
            /* margin:0; */
        }
        
        #com-chilipeppr-widget-gcode-footer .stats-hdr {
            font-size: 10px;
            /* font-weight:bold; */
        }
        
        #com-chilipeppr-widget-gcode-footer .stats-val {
            font-size: 10px;
            font-weight: bold;
        }
        
        #com-chilipeppr-widget-gcode-body-wrapper {
            position: relative;
            /* border:1px solid green; */
            /* height:100%; */
        }
        
        #com-chilipeppr-widget-gcode-body-jumpscroll-wrapper {}
        
        #com-chilipeppr-widget-gcode-body-jumpscroll {
            /* position: absolute; */
            border: 1px solid red;
            /* display: table-cell; */
            right: 0;
            /* top:0; */
            height: 100%;
            width: 20px;
            background-color: silver;
        }
        
        .paginator {
            width: 20px;
            height: 20%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        
        .paginator-first,
        .paginator-last {
            position: absolute;
            height: 24px;
        }
        
        .paginator-first {
            top: 0;
        }
        
        .paginator-last {
            bottom: 0;
        }
        
        .jumpbtn {
            padding: 0;
            margin: 0;
        }
        
        .com-chilipeppr-gcode-jumpscroll .btn {
            border-radius: 0;
            padding: 0;
            margin: 0;
            /* padding:1px 8px; */
            width: 20px;
            background-color: none;
            border: 0;
            height: 100%;
        }
        
        .com-chilipeppr-gcode-jumpscroll .glyphicon-minus {
            /* color: #fdfdfd; */
            color: rgba(255, 255, 255, 0);
        }
        
        #com-chilipeppr-widget-gcode-footer {
            overflow-x: hidden;
        }
        
        #com-chilipeppr-widget-gcodeviewer .btnIconBlue {
            color: #428bca;
        }
        
        #com-chilipeppr-widget-gcodeviewer .btnIconWarning {
            color: #f0ad4e;
        }
        
        #com-chilipeppr-widget-gcodeviewer .plannerpauseindicator {
            cursor: none;
        }
        
        #com-chilipeppr-widget-gcode-modal .options-heading {
            font-size: larger;
            padding: 10px 0 0 0;
            margin-bottom: 0;
        }
    </style>

    <script type='text/javascript'>
        //variables DETECAP
        const serialPort = "COM3"; // 
        const serialPort2 = "COM4"; // 
        var contadordelinea = 0;
        var ultimom6 = 0;
        var entrabajo = 0;
        var aentrabajo = 0;
        var temp = 0;
        var yentrabajo = 0;
        var errora = 0;
        var errory = 0;
        var toolausar = 0;
        var objetodah = 0;
        var ultimopausa = 0;

        var ocupado = 0;
        var sigespecial = 0;
        //<![CDATA[
        // Load additional files via Chilipeppr's require.js
        requirejs.config({
            paths: {

                jqueryui: '//localhost/DidaOffline//ui/jquery.ui.core',
                jqueryuiWidget: '//localhost/DidaOffline//ui/jquery.ui.widget',
                jqueryuiMouse: '//localhost/DidaOffline//ui/jquery.ui.mouse',
                jqueryuiResizeable: '//localhost/DidaOffline//ui/jquery.ui.resizable',
                waypoints: 'http://localhost/DidaOffline//waypoints.min',

            },
            shim: {
                //jqueryWaypointsInfinite: ['waypoints']
                //jqueryui: ['jquery'],
                jqueryuiWidget: ['jqueryui'],
                jqueryuiMouse: ['jqueryuiWidget'],
                jqueryuiResizeable: ['jqueryui', 'jqueryuiMouse']
            }
        });

        // Test this element. This code is auto-removed by the chilipeppr.load()
        cprequire_test(["inline:com-chilipeppr-widget-gcode"], function(gcode) {
            console.log("test running of " + gcode.id);



            // add flash msg
            chilipeppr.load(
                "http://fiddle.jshell.net/chilipeppr/90698kax/show/light",
                function() {
                    cprequire(
                        ['inline:com-chilipeppr-elem-flashmsg'],
                        function(flash) {
                            flash.init();
                            //chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "title from pub no dismiss", "body from pub", 1000, true);
                        }
                    );
                }
            );


            chilipeppr.load("dragdrop",
                "http://fiddle.jshell.net/jlauer/Z9F6G/show/light/",
                function() {
                    require(["inline:com-chilipeppr-elem-dragdrop"], function(dd) {
                        console.log("inside require of dragdrop");
                        dd.init();
                        dd.bind("body", null);
                        //$(".com-chilipeppr-elem-dragdrop").popover('show');
                        //dd.bind("#pnlWorkspace", null);
                        console.log(dd);
                    });
                });

            var testPlannerPause = function() {
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                    }, 5000);
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                    }, 10000);
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                    }, 15000);
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                    }, 20000);
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                    }, 25000);
                    setTimeout(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                    }, 30000);
                }
                //testPlannerPause();

            // mimic recving 3dobject
            chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/request3dObject", function() {
                var obj = {
                    userData: {
                        lines: [{
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 2,
                                "y": 0,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "arci": null,
                                "arcj": -2,
                                "arck": null,
                                "arcr": null,
                                "arc": true,
                                "clockwise": true,
                                "g2": true
                            },
                            "args": {
                                "cmd": "G2",
                                "text": "G2  X2 Y0  I0 J-2.0",
                                "origtext": "G02 X2Y0 I0J-2.0",
                                "indx": 1,
                                "isComment": false,
                                "x": 2,
                                "y": 0,
                                "i": 0,
                                "j": -2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }, {
                            "p2": {
                                "x": 0,
                                "y": 234.234245,
                                "z": 0,
                                "e": 0,
                                "f": 0,
                                "g0": true,
                                timeMinsSum: 68.42445
                            },
                            "args": {
                                "cmd": "G0",
                                "text": "G0  X0 Y2",
                                "origtext": "G0 X0Y2",
                                "indx": 0,
                                "isComment": false,
                                "x": 0,
                                "y": 2
                            }
                        }]
                    }
                };
                chilipeppr.publish("/com-chilipeppr-widget-3dviewer/recv3dObject", obj);
            });
            gcode.init();

            var numerobroca = "no";

            var testOnQueue = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/onQueue", {
                        Id: "g2"
                    });
                }, 2000);
            };
            var testOnWrite = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/onWrite", {
                        Id: "g2"
                    });
                }, 3000);
            };
            var testOnComplete = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/onComplete", {
                        Id: "g2"
                    });
                }, 4000);
            };
            var testOnExecute = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/onExecute", {
                        line: 2
                    });
                }, 5000);
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/onExecute", {
                        line: 4
                    });
                }, 6000);
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/onComplete", {
                        Id: "g3"
                    });
                }, 7000);
            };
            var testOnError = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/onError", {
                        Id: "g3"
                    });
                }, 7000);
            }


            var testPublishGcode = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/requestGcode", "");
                }, 5000);
            }


            var testJumpToLine = function() {
                setTimeout(function() {
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/jumpToLine", 5);
                }, 6000);
            }

            $('#com-chilipeppr-widget-gcodeviewer').css('width', '350px');
            $('body').css('padding', '20px');

            // test out the /onPlay and interrupting it
            var testOnPlayInterrupt = function() {
                var isDoInterrupt = true;
                chilipeppr.subscribe("/com-chilipeppr-widget-gcode/onplay", this, function(event) {
                    console.log("got onPlay pubsub test for interrupt. event: ", event);

                    if (isDoInterrupt) {

                        console.log("onPlay pubsub test. CANCELLING EVENT.");
                        // then send a new /play about 5 seconds later to mimic an async interrupt
                        setTimeout(function() {

                            chilipeppr.publish("/com-chilipeppr-widget-gcode/play", event);
                        }, 5000);

                        // set to false so next time in, we don't cancel
                        isDoInterrupt = false;

                        // return false to cancel all subsequent calls
                        return false;
                    } else {


                        console.log("onPlay pubsub test. Now allowing play to continue on.")
                        return true;
                    }
                });
            };
            // testOnPlayInterrupt();

        } /*end_test*/ );


        cpdefine("inline:com-chilipeppr-widget-gcode", ["chilipeppr_ready", "waypoints", "jqueryuiResizeable", "jquerycookie"], function() {
            return {
                id: "com-chilipeppr-widget-gcode",
                url: "http://raw.githubusercontent.com/jamador47/widget-gcodelist/master/auto-generated-widget.html", // The final URL of the working widget as a single HTML file with CSS and Javascript inlined. You can let runme.js auto fill this if you are using Cloud9.
                fiddleurl: "http://ide.c9.io/eaclaya/widget-gcode-list", // The edit URL. This can be auto-filled by runme.js in Cloud9 if you'd like, or just define it on your own to help people know where they can edit/fork your widget
                githuburl: "http://github.com/jamador47/widget-gcodelist", // The backing github repo
                testurl: "http://widget-gcode-list-eaclaya.c9users.io/widget.html", // The standalone working widget so can view it working by itself
                name: "Widget / Gcode v8",
                desc: "The Gcode widget shows you the Gcode loaded into your workspace, lets you send it to the serial port, get back per line status, see an estimated length of time to execute the Gcode, navigate to the XYZ position of a specific line, and much more.",
                publish: {
                    // '/onplay': "When user hits play button",
                    '/onplay': "When user hits play button. This is fired before this widget starts playing to give subscribers a chance to cancel the play, or delay it, or interrupt it. Payload contains {gcodeLines:(array of gcode lines)}. For example, the Cayenn widget listens for this signal and interrupts you if there are Cayenn commands in your Gcode so it can send a ResetCtr to all Cayenn devices. The Cayenn widget needs to send all the resets before ChiliPeppr is allowed to play to make sure everything is in sync. Return a false from your subscribe callback to cancel the play.",
                    '/onpause': "When user hits pause button. The payload is a true/false boolean indicating whether it is a pause or an unpause. This event also fires if a pause is triggered for a different reason like from an M6 command. In that case the 2nd paramater of the payload contains a string of \"m6\".",
                    '/onstop': "When user hits stop button",
                    '/resize': "When we resize in case any other widget wants to listen to that so it can resize itself.",
                    '/done': "When we are done sending all gcode. We send a payload of how many lines sent and time for job.",
                    '/recvGcode': 'We publish this signal after you send in a /requestGcode signal. We will send you the Gcode in this widget including metadata. The payload contains { lines: [(your lines as a 0-based array)], metadata: [{isSent: bool, isQueued: bool, isWritten: bool, isComplete: bool}] }. The lines are a 0-based array so if you are trying to line them up with the numbers in the Gcode widget, line 1 corresponds to lines[0] in the array. The metadata is an array that matches the lines array but contains data on the send state of each line. You are being sent an exact reference to that array so if you modify it, you are modifying the actual Gcode and Metadata in this widget. You have been warned.',
                    '/onChiliPepprPause': 'This event is published during the play operation when the chilipeppr_pause string is found inside the Gcode. You can place a chilipeppr_pause string anywhere in the Gcode inside a comment and it will tell ChiliPeppr to pause sending when it hits that line. <br><br>The pause acts much like the M6 tool change pause but it is a pause just for ChiliPeppr to interpret and not the CNC controller. This technique was implemented for synchronizing a secondary microcontroller that could trigger an out-of-band event like a laser solderer, or a solder paste dispenser, or some other control that had to trigger at a specific Gcode line. This specific event is not very helpful to subscribe to because it does not have as much meaning as onChiliPepprPauseOnComplete or onChiliPepprPauseOnExecute. Those two events are triggered when the CNC controller actually gets to the specifically paused line and that is where you would synchronize from. <br><br>The onChiliPepprPauseOnComplete is triggered by all CNC controllers but is not a very accurate event as most controllers have a planner buffer which means this line is not really what is being executed but will be executed in the very near future at an unknown time. The onChiliPepprPauseOnExecute is a highly accurate event currently only available from TinyG that tells you the CNC controller is exactly executing this line at this moment.<br><br>A sample macro is available that shows how to use the onChiliPepprPause events.',
                    '/onChiliPepprPauseOnExecute': 'This event is published when the line that contained the chilipeppr_pause command inside a comment has actually executed in the CNC controller. This is currently supported by TinyG. Grbl does not support this.<br><br>The payload of the event includes the line number and the line of gcode that was just executed like { line: 8, gcode: "(chilipeppr_pause solder drop 4)" }',
                    '/onChiliPepprPauseOnComplete': 'This event is published when the line that contained the chilipeppr_pause command inside a comment has been actually sent to the CNC controller. If your controller supports onExecute events then it is recommended you use onChiliPepprPauseOnExecute instead because it is much more accurate.<br><br>To help explain the difference between onChiliPepprPauseOnExecute and onChiliPepprPauseOnComplete, for the onChiliPepprPauseOnComplete event if 1000 lines were buffered to SPJS and this is the 1000th line that this event will only trigger as the 1000th line is dished up to the CNC controller. This gives an event that can be pivoted off of. If the CNC controller has a planner buffer that can hold around 8 moves, you will get this event only when this line of gcode enters the planner buffer. So you are getting the event 8 moves ahead. To make this work in the real world you should likely pause by a length of time to ensure all commands are done or issue a double check command to your CNC controller that sends you back a response where you can ensure the controller is in the correct state.<br><br>The payload of the event includes the line number and the line of gcode that was just completed like { line: 8, gcode: "(chilipeppr_pause solder drop 4)" }'
                },
                subscribe: {
                    '/requestGcode': 'Send in this signal and we will publish back out a /recvGcode signal. See /recvGcode for further info.',
                    '/stop': 'Send in this signal to stop the gcode playing. Equivalent to hitting the stop button.',
                    '/play': 'Send in this signal to play the gcode. Equivalent to hitting the play button.',
                    '/pause': 'Send in this signal to pause/unpause the gcode. Equivalent to hitting the pause button.',
                    '/jumpToLine': "Send in an integer of what line to jump to in the Gcode widget. The index you send it should match what visually shows in the Gcode widget, i.e. line 1 should be sent as a 1 (even though the backing array is index 0).",
                },
                foreignSubscribe: {
                    "/com-chilipeppr-elem-dragdrop/ondropped": "We watch for a drag drop event of the Gcode file. The payload of the signal contains the localStorage object which is just the string representing the entire Gcode file.",
                    '/com-chilipeppr-interface-cnccontroller/plannerpause': "We need to pause when planner tells us.",
                    '/com-chilipeppr-interface-cnccontroller/plannerresume': "We need to resume when planner tells us.",
                    "/com-chilipeppr-interface-cnccontroller/feedhold": "We need to place a manual pause if we see the e-stop hit. That way user can start where they left off.",
                    "/com-chilipeppr-interface-cnccontroller/onExecute": "This signal is sent to us by the CNC controller widget. The payload looks like { line: 234 }. It is ONLY sent if the CNC controller widget is able to determine an executed state. Please refer to your CNC controller's publish documenation to determine if this signal will be published and thus whether this Gcode widget will see these events."
                },
                foreignPublish: {
                    '/com-chilipeppr-widget-3dviewer/gcodeline': "When a user clicks a line of gcode. We'll send the gcode and the line number so the subscriber can sync to what we're sending, i.e. a 3D viewer that wants to hilite the line representing this command. The format of the signal data is something like {line: 12, gcode: \"G1 F300.0 Z0.0\"}.",
                    "/com-chilipeppr-elem-flashmsg/flashmsg": "Send a flash message on certain events. In particular, we send a flash message when a comment line is hit. We also send a flash message when the gcode is done sending."
                },
                fileLines: [], // contains the gcode file as array per line
                metaLines: [], // stores meta data related to each line in fileLines
                metaObj: { // Default meta data object
                    isSent: false,
                    isQueued: false,
                    isWritten: false,
                    isCompleted: false, // whether onComplete has processed it
                    isError: false,
                    isExecuted: false, // whether onExecute has processed it
                    isDisplayed: false // whether onComplete or onExecute has reacted to it
                },
                linesComplete: [],
                linesToShow: 50, // how many lines to show in the infinite scroll area
                linesToShowMax: 200, // how many max before we start unloading
                delayPerLine: 1000, // ms delay between the send of each line to serial port
                lineNumbersOnByDefault: false,
                isDirtyUnits: false, //track if user had to specify a unit of measurement and whether we need to reload the gcode file to add a UOM.
                init: function(settings) {
                    console.log("init called. settings:", settings);

                    // You can pass in a settings object. Supported settings are:
                    /*
                    {lineNumbersOnByDefault: true})
                    */

                    if (settings && 'lineNumbersOnByDefault' in settings) {
                        console.log("init called. we were passed in settings");
                        // the workspace wants lineNumbersOnByDefault
                        this.lineNumbersOnByDefault = settings.lineNumbersOnByDefault;
                        if (this.lineNumbersOnByDefault) {
                            console.log("init called. showing default msg. el:", $('.com-chilipeppr-widget-gcode-option-addlinenums-default'));
                            $('.com-chilipeppr-widget-gcode-option-addlinenums-default').removeClass('hidden');
                        }

                    }


                    chilipeppr.subscribe("/com-chilipeppr-widget-gcode/onplay", this, this.onPlayAfter, 11);

                    this.setupOptionsModal();

                    // this is async, so hopefully it completes before the user drags a file
                    // this loads all our tooltip popout info
                    // to describe the g commands
                    this.gcodeLoad();

                    // subscribe to all callback events from serial port widget
                    // so we know when our gcode is executed by spjs
                    this.setupOnQueueWriteCompletePubSub();

                    // load jquery-ui css, but make sure nobody else loaded it
                    if (!$("link[href='//localhost/DidaOffline//smoothness/jquery-ui.css']").length)
                        $('<link>')
                        .appendTo('head')
                        .attr({
                            type: 'text/css',
                            rel: 'stylesheet'
                        })
                        .attr('href', '//localhost/DidaOffline//smoothness/jquery-ui.css');

                    // load local file
                    //localStorage.removeItem('last-imported');
                    var lastImported = localStorage.getItem('last-imported');
                    var lastLoaded = localStorage.getItem('last-loaded');
                    if (lastImported) {
                        console.log("loading text from local storage");
                        this.onFileLoaded(lastImported);
                    } else {
                        console.log("gcode viewer loading from path lastLoaded or 15mm_cube.gcode");
                        var that = this;
                        if (!lastLoaded) lastLoaded = 'http://localhost/DidaOffline//nc/chilipepprlogo.nc';
                        $.get(lastLoaded, null, function(data) {
                                localStorage.setItem('last-loaded', lastLoaded);
                                localStorage.removeItem('last-imported');
                                // load gcode file, true: skip local store cuz i want a path
                                // stored instead for default file so it reloads when i change it
                                that.onFileLoaded(data, null, true);
                            }, 'text')
                            .error(function() {
                                console.log("error loading default file");
                            });
                    }

                    chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondropped", this, this.onFileLoaded, 9);

                    // subscribe to pause/resume events
                    chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerpause", this, this.onPlannerPause);
                    chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerresume", this, this.onPlannerResume);
                    chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/feedhold", this, this.onFeedhold);

                    // setup buttons in top toolbar
                    this.btnSetup();

                    // get a trigger per row so we can hilite it
                    this.setupRowTrigger();
                    //this.createGcodeDesc();
                    //console.log(gcode);
                    this.parseGcode();
                    //console.log(window.location);

                    // Make widget resizeable
                    this.setupResizeable();

                    this.setupFeedrateAdjust();
                    this.forkSetup();
                    this.setupToolChangeModal();

                    // setup pubsub for sending users our gcode
                    this.setupSendGcodePubSub();

                    //this.showToolChangeModal();

                    this.setupPlayPauseStopPubSub();

                    // setup subscribe to jumpToLine
                    chilipeppr.subscribe("/" + this.id + "/jumpToLine", this, this.gotoLine);

                    // setup popover for status items
                    this.setupStatusSteps();

                    this.setupJumpToLine();

                    this.setupSecondaryButtons();


                    setTimeout(this.getEstimates.bind(this), 5000);

                    console.log(this.name + " done loading.");
                },

                setupSecondaryButtons: function() {

                    // setup Feed Rate Override to toggle the actual region
                    $('.com-chilipeppr-widget-gcode-showfr').click(this.onToggleShowFeedRateOverride.bind(this));
                },
                onToggleShowFeedRateOverride: function() {
                    var btnEl = $('.com-chilipeppr-widget-gcode-showfr');
                    var regionEl = $('#com-chilipeppr-widget-gcode-feedrate');
                    if (btnEl.hasClass("active")) {
                        // it's showing, so hide it
                        regionEl.addClass("hidden");
                        // remove our active tag
                        btnEl.removeClass("active");
                    } else {
                        // it's hidden, so show it
                        regionEl.removeClass("hidden");
                        // show us as pressed in
                        btnEl.addClass("active");
                    }
                },

                toolChanges: {},
                toolChangesKeys: [], // need to store keys in own array cuz keys in javascript are strings and we wants ints
                toolComments: {},
                setupToolChanges: function() {



                    console.log("about to look for tool changes in this.fileLines. lines:", this.fileLines.length);

                    this.toolComments = {};
                    this.toolChanges = {};
                    this.toolChangesKeys = [];

                    for (var i = 0; i < this.fileLines.length; i++) {
                        var line = this.fileLines[i];


                        if (line.match(/\(T(\d+)\s+(.*)\)/i)) {
                            var toolNum = parseInt(RegExp.$1);
                            var toolComment = "T" + toolNum + " " + RegExp.$2;
                            console.log("found tool comment. lineNum:", i, "toolNum:", toolNum, "comment:", toolComment, "line:", line);
                            this.toolComments[toolNum] = {
                                lineNum: i + 1,
                                toolNum: toolNum,
                                toolComment: toolComment,
                            }
                        }

                        // look for M6 line
                        if (line.match(/M6|M06|M006/i)) {
                            var toolNum;
                            if (line.match(/T(\d+)/i)) {
                                toolNum = parseInt(RegExp.$1);
                            }
                            this.toolChanges[(i + 1)] = {
                                lineNum: i + 1,
                                toolNum: toolNum,
                            };
                            this.toolChangesKeys.push(i + 1);
                            console.log("found tool change. lineNum:", i, "line:", line);
                        }
                    }

                    console.log("this.toolComments:", this.toolComments);
                    console.log("this.toolChanges:", this.toolChanges);


                    var keys = this.toolChangesKeys; //Object.keys(this.toolChanges).sort();
                    console.log("looking for comments above m6 to get a label for this tool change. keys:", keys);
                    for (var i = 0; i < keys.length; i++) {
                        var toolChangeLineNum = keys[i];
                        var lookBackToLineNum = toolChangeLineNum - 10;
                        if (lookBackToLineNum < 1) lookBackToLineNum = 1; // first line

                        // now look backwards until we've seen just 1 comment
                        for (var lineNum = toolChangeLineNum; lineNum >= lookBackToLineNum; lineNum--) {
                            var line = this.fileLines[lineNum - 1]; // index of array is 1 less than lineNum
                            console.log("looking at lineNum:", lineNum, "line:", line);
                            // see if comment
                            if (line.match(/\((.*?)\)/) || line.match(/;(.*)/)) {
                                var comment = RegExp.$1;
                                console.log("found comment:", comment);

                                // stick comment into toolChanges
                                this.toolChanges[toolChangeLineNum].sectionComment = comment;

                                // break since we found one
                                break;
                            }
                        }
                    }

                    console.log("after adding section comments. this.toolChanges:", this.toolChanges);

                    // now populate the pulldown
                    var keys = this.toolChangesKeys; //Object.keys(this.toolChanges).sort();
                    var ddEl = $('.com-chilipeppr-widget-gcode-menuToolChange');

                    // wipe menu
                    ddEl.html('<li role="presentation" class="dropdown-header com-chilipeppr-widget-gcode-toolchanges-hdr">Click the item below to jump to the line in the Gcode so you can start playing from there.</li>');

                    if (keys.length == 0) {
                        // insert that no tool changes
                        var menuEl = $('<li role="presentation" class="dropdown-header com-chilipeppr-widget-gcode-toolchanges-hdr">(No Tool Changes in Gcode)</li>');

                        ddEl.append(menuEl);
                    }

                    for (var i = 0; i < keys.length; i++) {
                        var toolChange = this.toolChanges[keys[i]];
                        var tool = this.toolComments[toolChange.toolNum];

                        var str = "";

                        if ('sectionComment' in toolChange) {
                            str = str + '<span class="small" style="font-weight:bold;">' + toolChange.sectionComment + '</span><br>';
                        }


                        str = str + "Tool " + toolChange.toolNum + " on line " + toolChange.lineNum;

                        if (tool != null) {
                            str = str + "<br>" + tool.toolComment;
                        }


                        var menuEl = $('<li><a class="" style="cursor:pointer;">' + str + '</a></li>');
                        menuEl.click(toolChange, this.onToolChangesSelectMenu.bind(this));
                        ddEl.append(menuEl);
                        console.log("added Tool Changes menu item:", menuEl);
                    }

                },
                /**
                 * Called when user clicks a Tool Changes menu item. They want to jump to that line.
                 */
                onToolChangesSelectMenu: function(data) {
                    console.log("got click on Tool Changes menu. data:", data.data);
                    var toolInfo = data.data;
                    // u get data like: {lineNum: 11, toolNum: 1}
                    this.jumpToLine(toolInfo.lineNum);

                },
                /**
                 * This method is called after the Gcode file is loaded so you can do some post-processing.
                 */
                onAfterGcodeFileLoaded: function() {
                    this.setupToolChanges();
                },
                setupJumpToLine: function() {
                    $('#com-chilipeppr-widget-gcode-jumptoline').click(this.onJumpToLine.bind(this));

                },
                onJumpToLine: function(evt) {
                    console.log("got onJumpToLine. evt:", evt);
                    console.log("this.lastLineMarkedExecuted:", this.lastLineMarkedExecuted);

                    var lastLine = "";
                    if (this.lastLineMarkedExecuted && this.lastLineMarkedExecuted > 0)
                        lastLine = this.lastLineMarkedExecuted;

                    var line = prompt("Please enter the line number to jump to.", lastLine);
                    var lineNum = parseInt(line);
                    if (lineNum > 0)
                        chilipeppr.publish("/com-chilipeppr-widget-gcode/jumpToLine", lineNum);
                    else
                        chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Error on Line Jump", "We had a problem parsing the line number you gave us.", 1000, true);
                },
                getEstimates: function() {
                    var that = this;
                    this.get3dObj(function() {
                        // when we get this callback, we should have a 3dobj
                        console.log("getEstimates got obj3d:", this.obj3d);
                        if (this.obj3d && this.obj3d.userData && this.obj3d.userData.lines) {
                            var lastLine = this.obj3d.userData.lines[this.obj3d.userData.lines.length - 1];
                            if ('p2' in lastLine && 'timeMinsSum' in lastLine.p2) {
                                console.log("we got a timeMinsSum:", lastLine.p2.timeMinsSum);
                                var estDurMins = lastLine.p2.timeMinsSum;
                                var str = this.toHHMMSS(estDurMins * 60); // expect seconds
                                $('#com-chilipeppr-widget-gcodeviewer #gcode-time-est').text(str);
                            }
                        }
                    });
                },
                setupStatusSteps: function() {
                    var html =
                        "<div id=\"com-chilipeppr-widget-gcodeviewer-popover-steps\" >Your Gcode moves through 5 steps from ChiliPeppr all the way through execution." +
                        "<table class=\"table table-condensed table-striped\"><tr><th>Step&nbsp;</th><th>Status</th><th>Description</th></tr>" +
                        "<tr><td>1</td><td><span class=\"glyphicon glyphicon-ok gcode-sent\"></span> Sent</td><td>Your Gcode has been sent to the Serial Port JSON Server by the Serial Port Widget.</td></tr>" +
                        "<tr><td>2</td><td><span class=\"glyphicon glyphicon-ok gcode-queued\"></span> Queued</td><td>Gcode is queued inside the Serial Port JSON Server and waiting to be sent to the CNC controller's serial buffer.</td></tr>" +
                        "<tr><td>3</td><td><span class=\"glyphicon glyphicon-ok gcode-written\"></span> Written</td><td>Gcode has been written to the serial buffer of your CNC controller and removed from SPJS's buffer. </td></tr>" +
                        "<tr><td>4</td><td><span class=\"glyphicon glyphicon-ok gcode-completed\"></span>&nbsp;Completed&nbsp;</td><td>Gcode is completed when the CNC controller tells us it read the Gcode from its serial buffer and placed the Gcode into its planner buffer (this means the Gcode may only get executed seconds into the future as the planner buffer works its way through lines.) </td></tr>" +
                        "<tr><td>5</td><td><span class=\"glyphicon glyphicon-ok gcode-executed\"></span> Executed</td><td>Optional. The CNC controller tells us that your Gcode was actually executed. This is the final step. On controllers like TinyG this data only comes back if line numbers are in your Gcode.</td></tr>" +
                        "<tr><td>6</td><td><span class=\"glyphicon glyphicon-ok gcode-error\"></span> Error/Unsupported Command</td><td>Optional. The CNC controller failed to execute the line of gcode.  This could indicate a problem with your gcode syntax, or that your CNC controller does not understand a particular gcode command.</td></tr>" +
                        "</table></div>";
                    $("#com-chilipeppr-widget-gcodeviewer .stats-hdr").popover({
                            content: html
                        })
                        .on("show.bs.popover", function() {
                            $(this).data("bs.popover").tip().css("max-width", "600px");
                        });
                },
                setupPlayPauseStopPubSub: function() {
                    var that = this;

                    chilipeppr.subscribe("/" + this.id + "/play", this, function() {
                        that.onPlay({});
                    });
                    chilipeppr.subscribe("/" + this.id + "/pause", this, function() {
                        that.onPause({});
                    });
                    chilipeppr.subscribe("/" + this.id + "/stop", this, function() {
                        that.onStop({});
                    });

                },
                setupSendGcodePubSub: function() {
                    chilipeppr.subscribe("/" + this.id + "/requestGcode", this, this.publishGcode);
                },
                publishGcode: function() {
                    var gcode = {
                        lines: this.fileLines,
                        metadata: this.metaLines
                    }
                    chilipeppr.publish("/" + this.id + "/recvGcode", gcode);
                },

                options: null,
                setupOptionsModal: function() {
                    console.log("setupOptionsModal");
                    // read vals from cookies
                    var options = $.cookie('com-chilipeppr-widget-gcode-options');

                    if (true && options) {
                        options = $.parseJSON(options);
                        console.log("just evaled options: ", options);
                        if (!('removeemptylines' in options))
                            options.removeemptylines = true;
                        // only addlinenumbs by default if workspace asked us to
                        if (this.lineNumbersOnByDefault) {
                            if (!('addlinenums' in options))
                                options.addlinenums = true;
                        }
                        // Default new options for backwards compatibility
                        if (!('sendOnM6' in options)) {
                            options.sendOnM6 = "";
                        }
                        if (!('sendOffM6' in options)) {
                            options.sendOffM6 = "";
                        }
                        if (!('probeCmd' in options)) {
                            options.probeCmd = "G28.2 Z0";
                        }

                    } else {
                        options = {
                            whenPlay: "serial",
                            perRow: "3d",
                            perRow3dType: "goto",
                            delayPerLine: this.delayPerLine,
                            pauseOnM6: true,
                            preUpload: 'none',
                            multiLineMode: 'yes',
                            multiLines: 50,
                            ppsOnPlayFlush: false,
                            ppsOnStopFeedhold: false,
                            ppsOnPauseFeedhold: false,
                            ppsOnUnpauseResume: false,
                            removeemptylines: true,
                            addlinenums: true,
                            sendOnM6: "",
                            sendOffM6: "",
                            probeCmd: "G28.2 Z0"
                        };
                    }
                    this.options = options;
                    console.log("options:", options);

                    // setup the correct radio buttons in dialog
                    if (this.options.whenPlay == "serial")
                        $('#com-chilipeppr-widget-gcode-option-whenplay-serial').prop('checked', true);
                    else
                        $('#com-chilipeppr-widget-gcode-option-whenplay-3d').prop('checked', true);
                    if (this.options.perRow == "serial")
                        $('#com-chilipeppr-widget-gcode-option-perrow-serial').prop('checked', true);
                    else
                        $('#com-chilipeppr-widget-gcode-option-perrow-3d').prop('checked', true);
                    if (this.options.perRow3dType == "goto")
                        $('#com-chilipeppr-widget-gcode-option-perrow-3d-goto').prop('checked', true);
                    else
                        $('#com-chilipeppr-widget-gcode-option-perrow-3d-anim').prop('checked', true);

                    if (this.options.pauseOnM6) {
                        $('#com-chilipeppr-widget-gcode-option-pauseOnM6').prop('checked', true);
                        $('#com-chilipeppr-widget-gcode-option-pauseOnM6-alt').prop('checked', true);
                    }
                    $('#com-chilipeppr-widget-gcode-option-sendonM6').val(this.options.sendOnM6);
                    $('#com-chilipeppr-widget-gcode-option-sendoffM6').val(this.options.sendOffM6);
                    $('#com-chilipeppr-widget-gcode-option-probe-cmd').val(this.options.probeCmd);

                    if (this.options.preUpload) {
                        var opt = ["none", "100", "1000", "10000", "20000"];
                        var that = this;
                        opt.forEach(function(item, indx) {
                            console.log("indx:", indx, "item:", item, "preUpload:", that.options.preUpload);
                            if (that.options.preUpload == item) {
                                $('#com-chilipeppr-widget-gcode-option-upload-' + item).prop('checked', true);
                            } else {
                                $('#com-chilipeppr-widget-gcode-option-upload-' + item).prop('checked', false);
                            }
                        });
                    }

                    if (this.options.multiLineMode) {
                        if (this.options.multiLineMode == "yes") {
                            $('#com-chilipeppr-widget-gcode-option-multilinemode-yes').prop('checked', true);
                            this.isInMultiLineMode = false;
                        } else {
                            $('#com-chilipeppr-widget-gcode-option-multilinemode-no').prop('checked', true);
                            this.isInMultiLineMode = false;
                        }
                        this.options.multiLines = parseInt(this.options.multiLines);
                        if (this.options.multiLines < 1) this.options.multiLines = 1;
                        $('#com-chilipeppr-widget-gcode-option-multiline').val(this.options.multiLines);
                        this.multiLines = this.options.multiLines;
                    }

                    // setup play/pause/stop options
                    if (this.options.ppsOnPlayFlush)
                        $('#com-chilipeppr-widget-gcode-option-ppsOnPlayFlush').prop('checked', true);
                    if (this.options.ppsOnStopFeedhold)
                        $('#com-chilipeppr-widget-gcode-option-ppsOnStopFeedhold').prop('checked', true);
                    if (this.options.ppsOnPauseFeedhold)
                        $('#com-chilipeppr-widget-gcode-option-ppsOnPauseFeedhold').prop('checked', true);
                    if (this.options.ppsOnUnpauseResume)
                        $('#com-chilipeppr-widget-gcode-option-ppsOnUnpauseResume').prop('checked', true);


                    // setup delay per line
                    if (this.options.delayPerLine) {
                        this.delayPerLine = parseInt(this.options.delayPerLine);
                        $('#com-chilipeppr-widget-gcode-option-delayPerLine').val(this.delayPerLine);
                    }

                    if (this.options.removeemptylines) {
                        $('#com-chilipeppr-widget-gcode-option-removeemptylines').prop('checked', true);
                    }
                    if (this.options.addlinenums) {
                        $('#com-chilipeppr-widget-gcode-option-addlinenums').prop('checked', true);
                    }

                    // setup "save changes" button
                    var that = this;
                    $("#com-chilipeppr-widget-gcode-modal .optionsbtnsave").click(function(evt) {
                        console.log("Got save changes on gcode options dialog. evt:", evt);
                        that.saveOptionsModal();
                        that.hideOptionsModal();
                    });

                    // also, if ANYTHING is clicked, just go ahead and save all options
                    $("#com-chilipeppr-widget-gcode-modal input").click(function(evt) {
                        console.log("got click on evt:", evt);
                        that.saveOptionsModal();
                    });
                    $("#com-chilipeppr-widget-gcode-modal #com-chilipeppr-widget-gcode-option-multiline").blur(function(evt) {
                        console.log("got blur on evt:", evt);
                        that.saveOptionsModal();
                    });
                    $("#com-chilipeppr-widget-gcode-modal #com-chilipeppr-widget-gcode-option-delayPerLine").blur(function(evt) {
                        console.log("got blur on evt:", evt);
                        that.saveOptionsModal();
                    });

                    // not the best place, but since this is reading the options settings, might
                    // as well decide whether to show body here or not
                    if (!this.options.showBody) {
                        that.hideBody();
                    }

                    // attach event to onhide
                    $('#com-chilipeppr-widget-gcode-modal').on('hidden.bs.modal', function() {
                        // publish flash msgs that changes saved. Allow immediate dismiss.
                        // do with delay to perform after modal hide animation
                        setTimeout(function() {
                            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Options Saved", "Gcode Widget Options Saved", 1000, true);
                        }, 10);
                    });
                },
                saveOptionsModal: function() {
                    var that = this;
                    console.log("saveOptionsModal");

                    var whenPlay, perRow, perRow3dType, delayPerLine, pauseOnM6, sendOnM6, sendOffM6, probeCmd, showBody, preUpload, multiLineMode, multiLines, ppsOnPlayFlush, ppsOnStopFeedhold, ppsOnPauseFeedhold, ppsOnUnpauseResume, removeemptylines, addlinenums;
                    if ($('#com-chilipeppr-widget-gcode-option-whenplay-serial').is(':checked'))
                        whenPlay = "serial";
                    else if ($('#com-chilipeppr-widget-gcode-option-whenplay-3d').is(':checked'))
                        whenPlay = "3d";
                    if ($('#com-chilipeppr-widget-gcode-option-perrow-serial').is(':checked'))
                        perRow = "serial";
                    else if ($('#com-chilipeppr-widget-gcode-option-perrow-3d').is(':checked'))
                        perRow = "3d";
                    if ($('#com-chilipeppr-widget-gcode-option-perrow-3d-goto').is(':checked'))
                        perRow3dType = "goto";
                    else if ($('#com-chilipeppr-widget-gcode-option-perrow-3d-anim').is(':checked'))
                        perRow3dType = "anim";
                    if ($('#com-chilipeppr-widget-gcode-option-pauseOnM6').is(':checked'))
                        pauseOnM6 = true;
                    else
                        pauseOnM6 = false;
                    sendOnM6 = $('#com-chilipeppr-widget-gcode-option-sendonM6').val();
                    sendOffM6 = $('#com-chilipeppr-widget-gcode-option-sendoffM6').val();
                    probeCmd = $('#com-chilipeppr-widget-gcode-option-probe-cmd').val();

                    if ($('#com-chilipeppr-widget-gcode-option-removeemptylines').is(':checked'))
                        removeemptylines = true;
                    else
                        removeemptylines = false;
                    if ($('#com-chilipeppr-widget-gcode-option-addlinenums').is(':checked'))
                        addlinenums = true;
                    else
                        addlinenums = false;

                    // on play/pause/stop
                    ppsOnPlayFlush = ppsOnStopFeedhold = ppsOnPauseFeedhold = ppsOnUnpauseResume = false;
                    if ($('#com-chilipeppr-widget-gcode-option-ppsOnPlayFlush').is(':checked')) ppsOnPlayFlush = true;
                    if ($('#com-chilipeppr-widget-gcode-option-ppsOnStopFeedhold').is(':checked')) ppsOnStopFeedhold = true;
                    if ($('#com-chilipeppr-widget-gcode-option-ppsOnPauseFeedhold').is(':checked')) ppsOnPauseFeedhold = true;
                    if ($('#com-chilipeppr-widget-gcode-option-ppsOnUnpauseResume').is(':checked')) ppsOnUnpauseResume = true;

                    // pre-Upload
                    preUpload = $("#com-chilipeppr-widget-gcode-modal input:radio[name ='grpUpload']:checked").val();

                    // multi line mode
                    multiLineMode = $("#com-chilipeppr-widget-gcode-modal input:radio[name ='grpMultiLineMode']:checked").val();
                    multiLines = parseInt($('#com-chilipeppr-widget-gcode-option-multiline').val());
                    if (multiLines < 1) {
                        multiLines = 1;
                    }
                    this.isInMultiLineMode = multiLineMode == "yes" ? true : false;
                    that.multiLines = multiLines;

                    // delay per line
                    that.delayPerLine = parseInt($('#com-chilipeppr-widget-gcode-option-delayPerLine').val());

                    // show body
                    showBody = !($('#com-chilipeppr-widget-gcode-body-2col').hasClass('hidden'));

                    var options = {
                        whenPlay: whenPlay,
                        perRow: perRow,
                        perRow3dType: perRow3dType,
                        delayPerLine: that.delayPerLine,
                        pauseOnM6: pauseOnM6,
                        sendOnM6: sendOnM6,
                        sendOffM6: sendOffM6,
                        probeCmd: probeCmd,
                        showBody: showBody,
                        preUpload: preUpload,
                        multiLineMode: multiLineMode,
                        multiLines: multiLines,
                        ppsOnPlayFlush: ppsOnPlayFlush,
                        ppsOnStopFeedhold: ppsOnStopFeedhold,
                        ppsOnPauseFeedhold: ppsOnPauseFeedhold,
                        ppsOnUnpauseResume: ppsOnUnpauseResume,
                        removeemptylines: removeemptylines,
                        addlinenums: addlinenums
                    };
                    var optionsStr = JSON.stringify(options);
                    console.log("saving options:", options, "json.stringify:", optionsStr);
                    // store cookie
                    $.cookie('com-chilipeppr-widget-gcode-options', optionsStr, {
                        expires: 365 * 10,
                        path: '/'
                    });
                    that.options = options;

                    // publish flash msgs that changes saved. Allow immediate dismiss.
                    chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Options Saved", "Gcode Widget Options Saved", 1000, true);

                },
                showOptionsModal: function() {
                    $('#com-chilipeppr-widget-gcode-modal').modal('show');
                },
                hideOptionsModal: function() {
                    $('#com-chilipeppr-widget-gcode-modal').modal('hide');
                    // publish flash msgs that changes saved. Allow immediate dismiss.
                    // do with delay to perform after modal hide animation
                    //setTimeout(function() { chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Options Saved", "Gcode Widget Options Saved", true); }, 500);
                },
                setupToolChangeModal: function() {
                    var that = this;
                    $('#com-chilipeppr-widget-gcode-toolchange-modal').on('hidden.bs.modal', function() {
                        // save the setting. mimic click of save in main options modal
                        if ($('#com-chilipeppr-widget-gcode-option-pauseOnM6-alt').is(':checked'))
                            $('#com-chilipeppr-widget-gcode-option-pauseOnM6').prop('checked', true);
                        else
                            $('#com-chilipeppr-widget-gcode-option-pauseOnM6').prop('checked', false);
                        //$('#com-chilipeppr-widget-gcode-modal .optionsbtnsave').trigger( "click" );
                        that.saveOptionsModal();
                        // unpause the sending
                        //that.onPlayNextLine();
                    });

                    // attach to buttons in tool change div
                    // '/com-chilipeppr-interface-cnccontroller/energizeMotors'
                    $('.com-chilipeppr-widget-gcode-toolchange-energize').click(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/energizeMotors', "");
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-unenergize').click(function() {
                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/unEnergizeMotors', "");
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-probe').click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", that.options.probeCmd + '\n');
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-sendgcode').click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", that.toolChangeRepositionCmd + '\n');
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-g43').click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", that.toolChangeCmd + '\n');
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-spindlestop').click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", 'M5\n');
                    });
                    $('.com-chilipeppr-widget-gcode-toolchange-spindlestart').click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", 'M3\n');
                    });

                    // close btn
                    $('.com-chilipeppr-widget-gcode-toolchange .close').click(this.hideToolChangeDiv.bind(this, false));

                },
                isInToolChangeMode: false, // track whether we're showing tool change div
                toolChangeRepositionCmd: null, // gcode to reposition to prior location before tool change (in case they jog)
                toolChangeCmd: null, // G43 command to change tool length offset
                showToolChangeModal: function(linegcode, source) {

                    var toolNumber = linegcode.match(/T\d+/ig)[0]
                    console.log("Switching to tool ", toolNumber);
                    if (!toolNumber) {
                        toolNumber = "Unknown Tool";
                        this.toolChangeCmd = "G49";
                    } else {
                        this.toolChangeCmd = "G43 " + toolNumber.replace("T", "H");
                    }
                    $('#com-chilipeppr-widget-gcode-toolnumber1').text(toolNumber);
                    $('#com-chilipeppr-widget-gcode-toolnumber2').text(toolNumber);
                    $('#com-chilipeppr-widget-gcode-g43-cmd').text(this.toolChangeCmd);


                    if ($('#com-chilipeppr-widget-gcode-option-pauseOnM6').is(':checked'))
                        $('#com-chilipeppr-widget-gcode-option-pauseOnM6-alt').prop('checked', true);
                    else
                        $('#com-chilipeppr-widget-gcode-option-pauseOnM6-alt').prop('checked', false);

                    if (false)
                        $('#com-chilipeppr-widget-gcode-toolchange-debug').text("Source: " + source);

                    $('#com-chilipeppr-widget-gcode-toolchange-modal').modal('show');

                    // setup div in main widget for when modal dismisses
                    this.isInToolChangeMode = true;
                    //gcode-short-mode
                    $('#com-chilipeppr-widget-gcode-body').addClass('gcode-short-mode');
                    $('.com-chilipeppr-widget-gcode-toolchange').removeClass('hidden');
                    $(window).trigger('resize');

                    // get active coords system and last position
                    var line = this.currentLine;
                    this.getXyzCoordsForLine(line, function(pos) {
                        console.log("getXyzCoordsForLine returned pos ", pos);

                        this.getCoordFromController(function(coords) {
                            console.log("getCoordFromController returned coords ", coords);

                            // now assemble the reposition command
                            if (coords.coord) {
                                this.toolChangeRepositionCmd = coords.coord;
                            } else {
                                this.toolChangeRepositionCmd = "";
                            }
                            this.toolChangeRepositionCmd = this.toolChangeRepositionCmd + " G0 X" + pos.x + " Y" + pos.y + " Z" + pos.z;

                            $('.com-chilipeppr-widget-gcode-toolchange-reposition1').text(this.toolChangeRepositionCmd);
                            $('.com-chilipeppr-widget-gcode-toolchange-reposition2').text(this.toolChangeRepositionCmd);

                            // Send gcode if defined
                            var sendOnM6 = $('#com-chilipeppr-widget-gcode-option-sendonM6').val();
                            if (sendOnM6) {
                                console.log("SendOnM6: ", sendOnM6);
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", sendOnM6 + '\n');
                            }
                        });
                    });

                    // get the current motor config, when we get callback, setup the "set motors to prev setting" btn

                },
                hideToolChangeModal: function() {
                    $('#com-chilipeppr-widget-gcode-toolchange-modal').modal('hide');
                    $(window).trigger('resize');
                },
                hideToolChangeDiv: function(wasPaused) {
                    console.log("hideToolChangeDiv");
                    if (this.isInToolChangeMode) {
                        console.log("was in toolChangeMode");
                        this.isInToolChangeMode = false;

                        if (wasPaused) {
                            // Send gcode if defined
                            // @todo Should NOT do this if we stopped rather than paused
                            var sendOffM6 = $('#com-chilipeppr-widget-gcode-option-sendoffM6').val();
                            if (sendOffM6) {
                                console.log("SendOffM6: ", sendOffM6);
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", sendOffM6 + '\n');
                            }
                        }

                        $('#com-chilipeppr-widget-gcode-body').removeClass('gcode-short-mode');
                        $('.com-chilipeppr-widget-gcode-toolchange').addClass('hidden');
                        $(window).trigger('resize');
                    }
                },
                //shows/hides the units of measurements modal when no units are found in the gcode file.
                showUOMModal: function(txt, info, skipLocalStore) {
                    console.log("showUOMModal");
                    that = this;
                    $('#com-chilipeppr-widget-gcode-uom-modal #inches-button').click(function() {
                        that.setUOM(txt, info, skipLocalStore, "inches")
                    });
                    $('#com-chilipeppr-widget-gcode-uom-modal #mm-button').click(function() {
                        that.setUOM(txt, info, skipLocalStore, "mm")
                    });
                    $('#com-chilipeppr-widget-gcode-uom-modal').modal('show');
                    $(window).trigger('resize');
                },
                hideUOMModal: function() {
                    console.log("hideUOMModal");
                    $('#com-chilipeppr-widget-gcode-uom-modal').modal('hide');
                    $(window).trigger('resize');
                },
                setUOM: function(txt, info, skipLocalStore, units) {
                    this.hideUOMModal();
                    if (units === "inches")
                        txt = "G20\n" + txt; //add G20 to first line of gcode file
                    else if (units === "mm")
                        txt = "G21\n" + txt; //add G21 to first line of gcode file
                    this.isDirtyUnits = true;
                    this.onFileLoaded(txt, info, skipLocalStore); //send new txt to onFileLoaded
                },
                getCoordFromControllerRecvCallback: null,
                getCoordFromController: function(callback) {
                    this.getCoordFromControllerRecvCallback = callback;
                    console.log("getCoordFromController");

                    chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/coords",
                        this, this.getCoordFromControllerRecv);
                    chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/requestCoords", "");
                },
                getCoordFromControllerRecv: function(coords) {
                    // unsub so we don't get anymore callbacks on this
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-cnccontroller/coords",
                        this.getCoordFromControllerRecv);

                    if (this.getCoordFromControllerRecvCallback) {
                        // call the callback and then null it so we only call it once
                        console.log("getCoordFromControllerRecv ", coords);
                        this.getCoordFromControllerRecvCallback(coords);
                        this.getCoordFromControllerRecvCallback = null;
                    } else {
                        console.log("GetCoordFromControllerRecv called with null callback... shouldn't happen")
                    }
                },
                getMotorConfigCallback: function(data) {},
                getXyzCoordsForLineRecv3dObjCallback: null,
                getXyzCoordsForLineRecv3dObjLine: null,
                obj3d: null,
                getXyzCoordsForLine: function(line, callback) {
                    console.log("getXyzCoordsForLine. line:", line);
                    this.getXyzCoordsForLineRecv3dObjLine = line;
                    this.getXyzCoordsForLineRecv3dObjCallback = callback;
                    chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.getXyzCoordsForLineRecv3dObj);
                    chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");
                },
                getXyzCoordsForLineRecv3dObj: function(obj3d) {
                    this.obj3d = obj3d;
                    var x, y, z;
                    var indx = this.getXyzCoordsForLineRecv3dObjLine - 1;
                    x = obj3d.userData.lines[indx].p2.x;
                    y = obj3d.userData.lines[indx].p2.y;
                    z = obj3d.userData.lines[indx].p2.z;

                    // unsub so we don't get anymore callbacks on this
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this.getXyzCoordsForLineRecv3dObj);

                    this.getXyzCoordsForLineRecv3dObjCallback({
                        index: indx,
                        x: x,
                        y: y,
                        z: z
                    });
                },

                btnSetup: function() {

                    // chevron hide body
                    var that = this;
                    $('#com-chilipeppr-widget-gcodeviewer .hidebody').click(function(evt) {
                        console.log("hide/unhide body");
                        if ($('#com-chilipeppr-widget-gcode-body-2col').hasClass('hidden')) {
                            // it's hidden, unhide
                            that.showBody(evt);
                        } else {
                            // hide
                            that.hideBody(evt);
                        }
                    });

                    // setup buttons
                    $('#com-chilipeppr-widget-gcode-play').click(this.onPlay.bind(this));
                    $('#salirpausa').click(this.salirpausa.bind(this));

                    $('#salirpausa2').click(this.salirpausa2.bind(this));


                    $('#com-chilipeppr-widget-gcode-pause').click(this.onPause.bind(this));
                    $('#com-chilipeppr-widget-gcode-stop').click(this.onStop.bind(this));
                    $('#com-chilipeppr-widget-gcode-stepback').click(this.onStepBack.bind(this));
                    $('#com-chilipeppr-widget-gcode-stepfwd').click(this.onStepFwd.bind(this));
                    $('#com-chilipeppr-widget-gcode-btnoptions').click(this.showOptionsModal.bind(this));

                    // setup planner indicator icon
                    $('#com-chilipeppr-widget-gcodeviewer div.plannerpause').popover({
                        html: true,
                        delay: 200,
                        animation: true,
                        trigger: 'hover',
                        placement: 'auto',
                        container: 'body'
                    });
                },
                onFeedhold: function() {
                    if (!(this.isPaused)) {
                        this.onPause();
                    }
                    //this.isPaused = true;
                },
                pauseBtnIcon: null,
                onPlannerPause: function() {
                    console.log("gcode being asked to pause.");
                    if (this.pauseBtnIcon == null)
                        this.pauseBtnIcon = $('#com-chilipeppr-widget-gcodeviewer div.plannerpause');

                    if (!this.isPausedByPlanner) {
                        // we are not paused, so go ahead and pause
                        this.onPauseByPlanner();
                        // visuall indicate we were paused by planner, not by a human
                        this.pauseBtnIcon.addClass('btnIconWarning');
                    } else {
                        console.log("got planner pause, but we're already paused");
                    }
                },
                onPlannerResume: function() {
                    console.log("gcode being asked to resume.");
                    if (this.pauseBtnIcon == null)
                        this.pauseBtnIcon = $('#com-chilipeppr-widget-gcodeviewer div.plannerpause');

                    if (this.isPausedByPlanner) {
                        // we are currently paused, so calling onPause will unpause (as if the user was toggling
                        // pause button)
                        this.onPauseByPlanner();
                        this.pauseBtnIcon.removeClass('btnIconWarning');
                    } else {
                        console.log("got planner resume, but we're already resumed which is weird. maybe user did it.");
                    }
                },
                isBodyShowing: true,
                showBody: function(evt) {
                    $('#com-chilipeppr-widget-gcode-body-2col').removeClass('hidden');
                    $('#com-chilipeppr-widget-gcode-feedrate').removeClass('hidden');
                    $('#com-chilipeppr-widget-gcode-footer').removeClass('hidden');
                    $('#com-chilipeppr-widget-gcodeviewer .hidebody span').addClass('glyphicon-chevron-up');
                    $('#com-chilipeppr-widget-gcodeviewer .hidebody span').removeClass('glyphicon-chevron-down');
                    if (!(evt == null)) {
                        this.options.showBody = true;
                        this.saveOptionsModal();
                    }
                    this.isBodyShowing = true;
                    $(window).trigger('resize');
                },
                hideBody: function(evt) {
                    $('#com-chilipeppr-widget-gcode-body-2col').addClass('hidden');
                    $('#com-chilipeppr-widget-gcode-feedrate').addClass('hidden');
                    $('#com-chilipeppr-widget-gcode-footer').addClass('hidden');
                    $('#com-chilipeppr-widget-gcodeviewer .hidebody span').removeClass('glyphicon-chevron-up');
                    $('#com-chilipeppr-widget-gcodeviewer .hidebody span').addClass('glyphicon-chevron-down');
                    if (!(evt == null)) {
                        this.options.showBody = false;
                        this.saveOptionsModal();
                    }
                    this.isBodyShowing = false;
                    $(window).trigger('resize');
                },
                forkSetup: function() {
                    var topCssSelector = '#com-chilipeppr-widget-gcodeviewer';

                    $(topCssSelector + ' .panel-title').popover({
                        title: this.name,
                        content: this.desc,
                        html: true,
                        delay: 200,
                        animation: true,
                        trigger: 'hover',
                        placement: 'auto'
                    });

                    // load the pubsub viewer / fork element which decorates our upper right pulldown
                    // menu with the ability to see the pubsubs from this widget and the forking links
                    var that = this;
                   /*chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function() {
                        require(['inline:com-chilipeppr-elem-pubsubviewer'], function(pubsubviewer) {
                            pubsubviewer.attachTo($(topCssSelector + ' .panel-heading .pubsub-dropdown-menu'), that);
                        });
                    });*/

                },
                setupResizeable: function() {
                    //$( "#com-chilipeppr-widget-gcode-body" ).resizable({
                    var that = this;
                    $("#com-chilipeppr-widget-gcodeviewer").resizable({
                        //alsoResize: "#com-chilipeppr-widget-gcode-body-2col > td:first"
                        alsoResize: "#com-chilipeppr-widget-gcode-body",
                        //ndex:1
                        //handles: "s",

                        //maxHeight:1000,
                        resize: function(evt) {
                            console.log("resize resize", evt);
                            //$( "#com-chilipeppr-widget-gcodeviewer" ).removeAttr("style");
                            $("#com-chilipeppr-widget-gcodeviewer").css('height', 'initial');
                            $('#com-chilipeppr-widget-gcode-body').css('width', 'initial');
                        },
                        start: function(evt) {
                            console.log("resize start", evt);
                        },
                        stop: function(evt) {
                            console.log("resize stop", evt);
                            //$( "#com-chilipeppr-widget-gcodeviewer" ).removeAttr("style");
                            $("#com-chilipeppr-widget-gcodeviewer").css('height', 'initial');
                            $('#com-chilipeppr-widget-gcode-body').css('width', 'initial');
                            // publish that we just resized ourselves in case any other widget cares
                            chilipeppr.publish("/" + that.id + "/resize", "");
                        }
                    });
                },
                setupFeedrateAdjust: function() {
                    $('#com-chilipeppr-widget-gcode-feedrate-up').click(this.feedrateUp.bind(this));
                    $('#com-chilipeppr-widget-gcode-feedrate-down').click(this.feedrateDown.bind(this));
                    $('#com-chilipeppr-widget-gcode-feedrate-reset').click(this.feedrateReset.bind(this));
                    $('#com-chilipeppr-widget-gcode-feedrate-adjust').click(this.feedrateAdjust.bind(this));

                    // attach to any keypress
                    $('#com-chilipeppr-widget-gcode-feedrate-val').keyup(this.feedrateAdjust.bind(this));
                    //this.feedrateDisable();
                    //setTimeout(this.feedrateEnable, 5000);
                    ////alert("fr disable");
                },
                feedrateDisable: function() {
                    $('#com-chilipeppr-widget-gcode-feedrate').attr('disabled', true);
                    $('#com-chilipeppr-widget-gcode-feedrate-up').attr('disabled', true);
                    $('#com-chilipeppr-widget-gcode-feedrate-down').attr('disabled', true);
                    $('#com-chilipeppr-widget-gcode-feedrate-reset').attr('disabled', true);
                    $('#com-chilipeppr-widget-gcode-feedrate-adjust').attr('disabled', true);
                    $('#com-chilipeppr-widget-gcode-feedrate-val').attr('disabled', true);

                },
                feedrateEnable: function() {
                    $('#com-chilipeppr-widget-gcode-feedrate').attr('disabled', false);
                    $('#com-chilipeppr-widget-gcode-feedrate-up').attr('disabled', false);
                    $('#com-chilipeppr-widget-gcode-feedrate-down').attr('disabled', false);
                    $('#com-chilipeppr-widget-gcode-feedrate-reset').attr('disabled', false);
                    $('#com-chilipeppr-widget-gcode-feedrate-adjust').attr('disabled', false);
                    $('#com-chilipeppr-widget-gcode-feedrate-val').attr('disabled', false);

                },
                feedrateUp: function() {
                    //console.log("feed up", this);
                    var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    frdom.val((parseFloat(frdom.val()) + 0.1).toFixed(2));
                    this.feedrateUpdateDom();
                },
                feedrateDown: function() {
                    //console.log("feed down", this);
                    var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    var val = (parseFloat(frdom.val()));

                    if (val <= 0.01) return;
                    if (val <= 0.1) val -= 0.01;
                    else val -= 0.1;
                    frdom.val(val.toFixed(2));
                    this.feedrateUpdateDom();
                },
                feedrateReset: function() {
                    console.log("feed reset", this);
                    var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    frdom.val("1.00");
                    this.feedrateUpdateDom();
                },
                feedrateAdjust: function() {
                    console.log("feed adjust", this);
                    //var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    //frdom.val("1.00");
                    this.feedrateUpdateDom();
                },
                feedrateUpdateDom: function() {
                    var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    var val = parseFloat(frdom.val());
                    if (isNaN(val)) frdom.addClass("alert-danger");
                    else frdom.removeClass("alert-danger");
                    var that = this;
                    $('#com-chilipeppr-widget-gcode-tbl .g').each(function(index, td) {
                        //console.log("i:", i, "td:", td);
                        var origline = that.fileLines[index];
                        var tdDom = $(td);
                        origline = that.getFeedrateMarkup(origline);
                        origline = that.getCommentMarkup(origline);

                        tdDom.html(origline);

                    });
                },
                onRecv3dObjectPerRowTd: null, // this is set before calling onRecv3dObjectPerRow()
                //obj3d: null,
                isShowingCoords: false, // boolean to track if we're showing coords right now
                isInsideCoords: false, // bool of whether user mouse is inside coords to not hide it
                onRecv3dObjectPerRow: function(obj3d) {
                    console.log("got onRecv3dObjectPerRow. obj3d:", obj3d, "onRecv3dObjectPerRowTd:", this.onRecv3dObjectPerRowTd);



                    var that = this;
                    this.isShowingCoords = true;
                    //var td = this.onRecv3dObjectPerRowTd;
                    var tr = this.onRecv3dObjectPerRowTd.parent();
                    var td = tr.find('.gtools');
                    var indx = parseInt(tr.find(".indx").text());
                    //console.log("td:", td, "tr:", tr, "indx:", indx);

                    var x, y, z, a, x2, y2, z2, a2;
                    if (indx - 2 < 0) {
                        x = y = z = a = 0;
                    } else {
                        x = obj3d.userData.lines[indx - 2].p2.x;
                        y = obj3d.userData.lines[indx - 2].p2.y;
                        z = obj3d.userData.lines[indx - 2].p2.z;
                    }
                    x2 = obj3d.userData.lines[indx - 1].p2.x;
                    y2 = obj3d.userData.lines[indx - 1].p2.y;
                    z2 = obj3d.userData.lines[indx - 1].p2.z;
                    //var offset = td.offset();
                    var offset = td.position();
                    var coordsEl = $(
                        '<div class="com-chilipeppr-widget-gcodeviewer-coords-wrapper" style="left:' + (offset.left - 10) + 'px;top:' + offset.top + 'px;">' +
                        '<div class="com-chilipeppr-widget-gcodeviewer-coords">' +
                        '<div class="com-chilipeppr-widget-gcodeviewer-coords-start">' +
                        '<span class="coords-lbl">Start</span><span class="coords-axis">X</span><span>' + x + '</span><span class="coords-axis">Y</span><span>' + y + '</span><span class="coords-axis">Z</span><span>' + z + '</span>' +
                        '</div>' +
                        '<div class="com-chilipeppr-widget-gcodeviewer-coords-end">' +
                        '<span class="coords-lbl">End</span><span class="coords-axis">X</span><span>' + x2 + '</span><span class="coords-axis">Y</span><span>' + y2 + '</span><span class="coords-axis">Z</span><span>' + z2 + '</span>' +
                        '</div>' +
                        '<div class="btnMoveToThisPos">' +
                        '</div>' +
                        '</div>' +
                        '</div>'
                    );
                    // send to btn
                    var btnEl = $('<div><button class="btn btn-xs btn-default" style="width:100%">Send Gcode to Move to This Position</button></div>')
                    btnEl.click(function() {
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "G0 X" + x2 + " Y" + y2 + " Z" + z2 + "\n");
                    });
                    coordsEl.find('.btnMoveToThisPos').append(btnEl);

                    // new start pos
                    btnEl = $('<div><button class="btn btn-xs btn-default" style="width:100%">Set as New Start Position</button></div>')
                    btnEl.click(function(evt) {

                        // call our method that will correctly set new start position
                        that.setNewStartPosition(indx, tr);
                    });
                    coordsEl.find('.btnMoveToThisPos').append(btnEl);

                    $('#com-chilipeppr-widget-gcode-body-wrapper').prepend(coordsEl);
                    coordsEl.on('mouseover', function(evt) {
                        console.log("isInsideCoords mouseenter");
                        that.isInsideCoords = true;
                    });
                    coordsEl.on('mouseleave', function(evt) {
                        console.log("isInsideCoords mouseleave");
                        that.isInsideCoords = false;
                        $('.com-chilipeppr-widget-gcodeviewer-coords-wrapper').remove();
                        that.isShowingCoords = false;
                    });

                    // unsubscribe from receiving pubsub again
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.onRecv3dObjectPerRow);
                },
                setNewStartPosition: function(indx, tr) {

                    console.group("gcode widget - setNewStartPosition");
                    //console.log("new start pos indx:", indx, "evt.target:", evt.target);
                    console.log("new start pos indx:", indx);


                    this.resetMetaDataQueueWriteComplete(indx);

                    console.log("tr:", tr);
                    // remove other hilites
                    //tr.parent().find('td').removeClass('alert-danger').css('background-color', 'none');
                    tr.find('.glyphicon-ok').css('color', '#a94442').parent().css('background-color', '#f2dede');
                    this.currentLine = indx - 1;
                    this.contadordelinea = this.currentLine;
                    localStorage.setItem('currentLine', this.currentLine);
                    console.groupEnd();

                },
                showXyzCoordsForRow: function(td) {
                    if (!this.isShowingCoords) {
                        this.onRecv3dObjectPerRowTd = td;

                        // see if we have cached 3d object
                        chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.onRecv3dObjectPerRow);
                        chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");
                    }
                },
                setupRowTrigger: function() {
                    var that = this;
                    $('#com-chilipeppr-widget-gcode-tbl')
                        .on("mouseover", 'tr', function(evt) {
                            //stuff to do on mouseover
                            var td = $(evt.currentTarget).children(".g");
                            //console.log("got mouseover on tr:", evt, evt.currentTarget, td);
                            if (td.hasClass("g")) {
                                //console.log("calling parse");
                                that.parseGcodeForDomElem(td, true);

                                // show xyz value
                                $('.com-chilipeppr-widget-gcodeviewer-coords-wrapper').remove();
                                that.isShowingCoords = false;
                                that.showXyzCoordsForRow(td);
                            }
                        });


                    $('#com-chilipeppr-widget-gcode-tbl')
                        .on("mouseout", 'tr', function(evt) {
                            console.log("got mouseout on tr");

                        });



                    $('#com-chilipeppr-widget-gcode-tbl')
                        .on("mouseleave", function(evt) {
                            console.log("got mouseout on table");
                            //$('.com-chilipeppr-widget-gcodeviewer-coords-wrapper').remove();
                            //that.isShowingCoords = false;
                            setTimeout(function() {
                                if (that.isShowingCoords && !that.isInsideCoords) {
                                    $('.com-chilipeppr-widget-gcodeviewer-coords-wrapper').remove();
                                    that.isShowingCoords = false;
                                }
                            }, 5);
                        });



                    $('#com-chilipeppr-widget-gcode-tbl')
                        .on("click", 'tr', function(evt) {
                            //stuff to do on click
                            console.log("got click on tr:", evt);
                            var tr = $(evt.currentTarget);
                            if (tr.hasClass("gcode-rowhilite")) tr.removeClass("gcode-rowhilite");
                            else tr.addClass("gcode-rowhilite");


                            var rowind = tr.children('.indx').text();
                            var indx = parseInt(rowind) - 1;
                            var gcode = that.fileLines[indx];
                            console.log("rowindex:", rowind, "indx:", indx, "gcode is:", gcode);

                            // publish to other widgets that a gcode line got hit so, for example,
                            // the 3D viewer could jump the toolhead to this point and hilite the line
                            if (that.options.perRow == "serial") {
                                // send this command to serial port instead
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", gcode);
                            } else {
                                // send this command to 3d viewer
                                chilipeppr.publish("/com-chilipeppr-widget-3dviewer/gotoline", {
                                    line: indx - 1,
                                    //gcode: gcode,
                                    anim: that.options.perRow3dType
                                });
                            }
                        });

                },
                timeStart: null,
                timeEnd: null,
                isPlayStep: false,
                isPlaying: false,
                isPaused: false,
                isPausedByPlanner: false,
                preUploadRemainder: 0,
                currentLine: null, // 0-based index of what gcode line we're playing
                onPauseByPlanner: function(event) {
                    if (this.isPausedByPlanner) {
                        console.log("onPauseByPlanner. was previously paused by planner, unpausing");
                        //this.isPaused = false;
                        this.isPausedByPlanner = false;
                        if (this.isInMultiLineMode) {
                            console.log("in multi line send mode");
                            this.onPlayNextLine();
                        } else {
                            // do single line mode
                            this.onPlayNextLine();
                        }
                        //this.onPlayNextLine();
                    } else {
                        console.log("onPauseByPlanner. was previously unpaused by planner, pausing from planner");
                        //this.isPaused = true;
                        this.isPausedByPlanner = true;
                    }
                },
                onStepBack: function(evt) {
                    console.log("onStepBack. ");
                    if (evt) this.hideToolChangeDiv(false);
                    this.currentLine = this.currentLine - 2;
                    if (this.currentLine < 0) this.currentLine = 0;
                    localStorage.setItem('currentLine', this.currentLine);
                    this.isPlayStep = true;
                    this.onPlayNextLine();
                },
                onStepFwd: function(evt) {
                    console.log("onStepFwd");
                    if (evt) this.hideToolChangeDiv(false);
                    this.isPlayStep = true;
                    this.onPlayNextLine();
                },
                onPause: function(event, isFromM6, isFromCpPause) {

                    if (localStorage.getItem('index') && this.isPaused) {

                        macro.status("incrementar");

                        var index = localStorage.getItem('index');
                        index++;
                        console.log(index);
                        localStorage.setItem('index', index);
                    }

                    if (this.isPaused) {
                        console.log("onPause. was previously paused by user, unpausing");
                        this.isPaused = false;

                        if (event) this.hideToolChangeDiv(true);

                        if (event)
                            var cmd = "~";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                        $('#com-chilipeppr-widget-gcode-pause').removeClass("active");

                        if (this.isInMultiLineMode) {
                            console.log("in multi line send mode");
                            this.onPlayNextLine();
                        } else if (this.preUploadRemainder > 0) {
                            this.onPreUpload(this.preUploadRemainder);
                        } else {
                            // do single line mode
                            this.onPlayNextLine();
                        }
                        //this.onPlayNextLine();
                    } else {
                        console.log("onPause. pausing at request of user");
                        console.log(event);
                        this.isPaused = true;
                        $('#com-chilipeppr-widget-gcode-pause').addClass("active");

                        if (event)
                            var cmd = "!";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                    }

                    // fire off pubsub signal for others to watch the pause btn
                    var metaData = null;
                    if (isFromM6) metaData = "m6";
                    if (isFromCpPause) metaData = "chilipeppr_pause";
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onpause", this.isPaused, metaData);

                },
                // pass in 0-based array index cuz this is manipulating array meta data
                resetMetaDataQueueWriteComplete: function(indexToStartAfter) {
                    console.group("gcode widget - resetMetaDataQueueWriteComplete");
                    console.log("indexToStartAfter:", indexToStartAfter);
                    var that = this;
                    var indx = 0;
                    if (indexToStartAfter != null && indexToStartAfter > 0) indx = indexToStartAfter;
                    for (; indx < this.metaLines.length; indx++) {
                        if (that.metaLines[indx] != null) {
                            console.log("found metaLine. resetting. indx:", indx);
                            that.metaLines[indx] = $.extend({}, that.metaObj);
                            // this will update the UI, but only for showing lines
                            that.updateRowQueueStats(indx + 1);
                        }
                    }
                    console.groupEnd();
                },
                onStop: function(event) {

                    var cmd = "!%";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                    localStorage.setItem('index', 0);


                    if (event && ('viaOnExecute' in event || 'viaOnComplete' in event)) {
                        // this was triggered after seeing the last onExecute cmd
                        $('#com-chilipeppr-widget-gcode-play').prop("disabled", false);
                        $('#com-chilipeppr-widget-gcode-stop').prop("disabled", true);
                        $('#com-chilipeppr-widget-gcode-pause').prop("disabled", true);
                        this.hideToolChangeDiv(false);

                        this.isPlaying = false;
                        this.isPaused = false;
                        this.currentLine = 0;
                        localStorage.setItem('currentLine', this.currentLine);
                        this.isResetMetaBeforePlay = true;
                    } else {

                        if (event) {
                            $('#com-chilipeppr-widget-gcode-play').prop("disabled", false);
                            $('#com-chilipeppr-widget-gcode-stop').prop("disabled", true);
                            $('#com-chilipeppr-widget-gcode-pause').prop("disabled", true);
                            this.hideToolChangeDiv(false);
                        }

                        this.isPlaying = false;

                        if (event)
                            this.isResetMetaBeforePlay = true;

                        if (event) {
                            this.currentLine = 0;
                            localStorage.setItem('currentLine', this.currentLine);
                        }
                        // wipe metadata of isQueue,isWritten,isComplete
                        if (event)
                            this.resetMetaDataQueueWriteComplete();
                        // update UI?

                        if (event && this.options.ppsOnStopFeedhold)
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "!");


                        // fire off pubsub signal for others to watch the stop btn
                        var meta = {
                            isStopByUser: event ? true : false
                        };
                        chilipeppr.publish("/com-chilipeppr-widget-gcode/onstop", meta);
                    }

                    this.feedrateEnable();

                },

                bajartstopsBtnClick: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/bajarstops/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }
                        var theurl = 'http://192.168.0.83/arduino/bajarstops/1';
                        var client = new HttpClient();
                        client.get(theurl, function(response) {

                            chilipeppr.publish(
                                '/com-chilipeppr-elem-flashmsg/flashmsg',
                                "Mesas",
                                "Posicionadores Abajo",
                                2000
                            );

                            document.getElementById("sa1f1").className = "led-off";
                            document.getElementById("sa1f2").className = "led-off";
                            document.getElementById("sa1l1").className = "led-off";
                            document.getElementById("sa2f1").className = "led-off";
                            document.getElementById("sa2f2").className = "led-off";
                            document.getElementById("sa2l1").className = "led-off";
                            document.getElementById("sa2l2").className = "led-off";
                            document.getElementById("sy1f1").className = "led-off";
                            document.getElementById("sy1f2").className = "led-off";
                            document.getElementById("sy1l1").className = "led-off";
                            document.getElementById("sy2f1").className = "led-off";
                            document.getElementById("sy2f2").className = "led-off";
                            document.getElementById("sy2l1").className = "led-off";
                            document.getElementById("sy2l2").className = "led-off";

                        });
                    });
                },


                bajarstopa1f1: function(evt) {





                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/28/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 frontal 1 inactivo",
                            2000
                        );

                        document.getElementById("sa1f1").className = "led-off";

                    });
                },

                encenderblower: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.80/arduino/digital/9/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {});

                },


                onm7: function(evt) {

                    var HttpClient = function() {

                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.98/geth';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var valorzsumado = 200
                        var obj = JSON.parse(response);
                        for (var i = 0; i < 17; i++) {
                            if (parseInt(obj[i]['enhusillo']) == 1) {
                                // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                valorzsumado = parseFloat(obj[i]['longitud']);;

                            }
                        }

                        var HttpClient = function() {

                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }
                        var theurl = 'http://192.168.0.98/api/origenesactivos/';
                        var client = new HttpClient();
                        client.get(theurl, function(response) {

                            var obj2 = JSON.parse(response);

                            var valorx = obj2['x'];
                            var valory = obj2['y'];
                            var valorz = parseFloat(obj2['z']);
                            var valora = obj2['a'];

                            valorz = valorz + valorzsumado;
                            valorz = valorz.toString();

                            var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);

                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");

                            var cmd = "~";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);




                        });



                    });


                },


                apagarblower: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.80/arduino/digital/9/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {});

                },


                bajarstopa1f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/30/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 frontal 2 desactivado",
                            2000
                        );

                        document.getElementById("sa1f2").className = "led-off";

                    });

                },
                bajarstopa1l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/12/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 lateral 1 desactivado",
                            2000
                        );

                        document.getElementById("sa1l1").className = "led-off";

                    });

                },
                bajarstopa2f1: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/31/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 frontal 1 desactivado",
                            2000
                        );

                        document.getElementById("sa2f1").className = "led-off";

                    });

                },
                bajarstopa2f2: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/29/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 frontal 2 desactivado",
                            2000
                        );

                        document.getElementById("sa2f2").className = "led-off";

                    });

                },
                bajarstopa2l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/15/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 lateral 1 desactivado",
                            2000
                        );

                        document.getElementById("sa2l1").className = "led-off";

                    });

                },
                bajarstopa2l2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/14/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 lateral 2 desactivado",
                            2000
                        );

                        document.getElementById("sa2l2").className = "led-off";

                    });

                },
                bajarstopy1f1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/6/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 frontal 1 desactivado",
                            2000
                        );

                        document.getElementById("sy1f1").className = "led-off";

                    });

                },
                bajarstopy1f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/7/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 frontal 2 desactivado",
                            2000
                        );

                        document.getElementById("sy1f2").className = "led-off";

                    });
                },
                bajarstopy1l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/45/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 lateral 1 desactivado",
                            2000
                        );

                        document.getElementById("sy1l1").className = "led-off";

                    });


                },
                bajarstopy2f1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/8/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 frontal 1 desactivado",
                            2000
                        );

                        document.getElementById("sy2f1").className = "led-off";

                    });

                },
                bajarstopy2f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/9/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 frontal 2 desactivado",
                            2000
                        );

                        document.getElementById("sy2f2").className = "led-off";

                    });
                },
                bajarstopy2l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/46/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 lateral 1 desactivado",
                            2000
                        );

                        document.getElementById("sy2l1").className = "led-off";

                    });

                },
                bajarstopy2l2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/44/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 lateral 2 desactivado",
                            2000
                        );

                        document.getElementById("sy2l2").className = "led-off";

                    });
                },

                /***********************************************************/

                activarm3: function(evt) {

                    //ENCENDER VENTILADORA
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/31/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) { console.log("Ventiladora Encendida")});

setTimeout(function(){
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var res = response.split("Pin A5 reads analog ");

                        response = parseInt(res[1]);

                        if (response > 850) {

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.80/arduino/digital/11';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {
                                var res = response.split("Pin D11 set to ");

                                response = parseInt(res[1]);

                                if (response == 0) {

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }
                                    var theurl = 'http://192.168.0.86/arduino/digital/27/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                        setTimeout(function() {
                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }
                                            var theurl = 'http://192.168.0.86/arduino/digital/36/1';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {
                                                setTimeout(function() {
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }
                                                    var theurl = 'http://192.168.0.86/arduino/digital/32/1';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {
                                                        document.getElementById("indicadorhusillo").className = "led-green";
                                                        chilipeppr.publish(
                                                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                                                            "Estado del Husillo",
                                                            "Husillo Activado ",
                                                            2000 /* show for 2 second */
                                                        );


                                                    });
                                                }, 1000)
                                            });
                                        }, 2000)

                                    });





                                } else {
                                    chilipeppr.publish(
                                        '/com-chilipeppr-elem-flashmsg/flashmsg',
                                        "Estado del Husillo",
                                        "El husillo no está desbloqueado (I.99) ",
                                        2000 /* show for 2 second */
                                    );

                                    var alarmasexistentes = document.getElementById("textoalarmas").value;

                                    document.getElementById("indicadoralarma").className = "led-yellow";
                                    alarmasexistentes = alarmasexistentes.concat("\\\n\\\n");

                                    alarmasexistentes = alarmasexistentes.concat("El husillo no está desbloqueado (I.99).");

                                    document.getElementById("textoalarmas").value = alarmasexistentes;
                                }
                            });
                        } else {
                            chilipeppr.publish(
                                '/com-chilipeppr-elem-flashmsg/flashmsg',
                                "Estado del Husillo",
                                "El Husillo no está desocupado (I.19) ",
                                2000 /* show for 2 second */
                            );

                            var alarmasexistentes = document.getElementById("textoalarmas").value;
                            document.getElementById("indicadoralarma").className = "led-yellow";
                            alarmasexistentes = alarmasexistentes.concat("\\\n\\\n");

                            alarmasexistentes = alarmasexistentes.concat("El Husillo no está desocupado (I.19)");

                            document.getElementById("textoalarmas").value = alarmasexistentes;
                        }
                    });


                },1500);

                },



                activarm5: function(evt) {

                                        //APAGAR VENTILADORA
                                        var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/31/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var response1 = JSON.parse(response);
                    });

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/32/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var response1 = JSON.parse(response);
                    });


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/36/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var response1 = JSON.parse(response);
                    });

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/27/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var response1 = JSON.parse(response);
                    });

                    document.getElementById("indicadorhusillo").className = "led-off";
                    chilipeppr.publish(
                        '/com-chilipeppr-elem-flashmsg/flashmsg',
                        "Estado del Husillo",
                        "Husillo Desactivado ",
                        2000 /* show for 2 second */
                    );



                },

                subirstopa1f1: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/28/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 frontal 1 accionado",
                            2000
                        );

                        document.getElementById("sa1f1").className = "led-green";

                    });
                },

                subirstopa1f2: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/30/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 frontal 2 accionado",
                            2000
                        );

                        document.getElementById("sa1f2").className = "led-green";

                    });

                },
                subirstopa1l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/12/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A1 lateral 1 accionado",
                            2000
                        );

                        document.getElementById("sa1l1").className = "led-green";

                    });
                },
                subirstopa2f1: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/31/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 frontal 1 accionado",
                            2000
                        );

                        document.getElementById("sa2f1").className = "led-green";

                    });

                },
                subirstopa2f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/29/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 frontal 2 accionado",
                            2000
                        );

                        document.getElementById("sa2f2").className = "led-green";

                    });



                },
                subirstopa2l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/15/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 lateral 1 accionado",
                            2000
                        );

                        document.getElementById("sa2l1").className = "led-green";

                    });



                },
                subirstopa2l2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.82/arduino/digital/14/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa A2 lateral 2 accionado",
                            2000
                        );

                        document.getElementById("sa2l2").className = "led-green";

                    });
                },
                subirstopy1f1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/6/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 frontal 1 accionado",
                            2000
                        );

                        document.getElementById("sy1f1").className = "led-green";

                    });
                },
                subirstopy1f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/7/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 frontal 2 accionado",
                            2000
                        );

                        document.getElementById("sy1f2").className = "led-green";

                    });
                },
                subirstopy1l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/45/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y1 lateral 1 accionado",
                            2000
                        );

                        document.getElementById("sy1l1").className = "led-green";

                    });

                },
                subirstopy2f1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/8/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 frontal 1 accionado",
                            2000
                        );

                        document.getElementById("sy2f1").className = "led-green";

                    });
                },
                subirstopy2f2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/9/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 frontal 2 accionado",
                            2000
                        );

                        document.getElementById("sy2f2").className = "led-green";

                    });

                },
                subirstopy2l1: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/46/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 lateral 1 accionado",
                            2000
                        );

                        document.getElementById("sy2l1").className = "led-green";

                    });
                },
                subirstopy2l2: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.83/arduino/digital/44/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Mesas",
                            "Posicionador mesa Y2 lateral 2 accionado",
                            2000
                        );

                        document.getElementById("sy2l2").className = "led-green";

                    });
                },

                salirpausa2: function(event) {


                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                    document.getElementById("salirpausa2").style = " background-color:gray"

                    document.getElementById("salirpausa2").disabled = true;

                },
                salirpausa: function(event) {


                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                    setTimeout(function() {

                        var cmd = "~";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);
                    }, 100);
                    setTimeout(function() {

                        var cmd = "~";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);
                    }, 110);
                    setTimeout(function() {

                        var cmd = "~";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);
                    }, 120);
                    setTimeout(function() {

                        var cmd = "~";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);
                    }, 130);
                    document.getElementById("salirpausa").style = " background-color:gray"

                    document.getElementById("salirpausa").disabled = true;


                },


                onPlay: function(event) {
                    entrabajo = 0;
                    // chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 g");
                    //chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM3 G28.2 Z0");
                    var esto = this;


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    var theurl = 'http://192.168.0.83/arduino/digital/32';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D32 set to ");
                        response = parseInt(res[1]);

                        if (response == 1) {


                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            var theurl = 'http://192.168.0.83/arduino/digital/29';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D29 set to ");
                                response = parseInt(res[1]);

                                if (response == 1) {


                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    var theurl = 'http://192.168.0.82/arduino/digital/41';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                        var res = response.split("Pin D41 set to ");
                                        response = parseInt(res[1]);

                                        if (response == 1) {



                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.82/arduino/digital/40';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {

                                                var res = response.split("Pin D40 set to ");
                                                response = parseInt(res[1]);

                                                if (response == 1) {





                                                    var cmd = "!%";
                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);

                                                    esto.getGcode();
                                                    console.log("got onPlay. esto:", esto, "event:", event);




                                                    // indicate we're starting play in the UI
                                                    $('.com-chilipeppr-widget-gcode-startindicator').removeClass("hidden");

                                                    // fire off pubsub signal for others to watch the play btn
                                                    var meta = {
                                                        isPlayByUser: event ? true : false
                                                    };
                                                    meta.gcodeLines = esto.fileLines;


                                                    //hacer cambio de herramienta previa si esta en modoh.********************************

                                                    //ELIMINARESTO
                                                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);



                                                    var HttpClient = function() {

                                                        esto.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    var theurl = 'http://192.168.0.98/geth';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var obj = JSON.parse(response);


                                                        var modoh = obj[0]['modoh'];
                                                        // SI ES MODO H:
                                                        if (modoh) {
                                                            var HttpClient = function() {

                                                                esto.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }
                                                            var theurl = 'http://192.168.0.98/geth';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {

                                                                var obj = JSON.parse(response);
                                                                window.objetodah = obj;
                                                            });


                                                            var largodecodigo = esto.fileLines.length;
                                                            var valorsiguientetool = 1000;

                                                            for (var n = 0; n < largodecodigo; n++) {

                                                                var gcodetemporal = esto.fileLines[n];

                                                                if (gcodetemporal.match(/\bM6\b/i)) {

                                                                    var linean = "N" + (n + 1);
                                                                    var lineatemporal = gcodetemporal.replace('M6', "").trim();
                                                                    lineatemporal = lineatemporal.replace('M7', "").trim();
                                                                    lineatemporal = lineatemporal.replace('T', "").trim();
                                                                    lineatemporal = lineatemporal.replace(linean, "").trim();
                                                                    var valorstool = parseInt(lineatemporal);
                                                                    n = 100000;

                                                                }
                                                            }

                                                            for (var i = 0; i < 17; i++) {
                                                                if (parseInt(obj[i]['herramienta']) == valorstool) {
                                                                    // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                    var indexher = i;
                                                                    valorsiguientetool = i + 1;
                                                                }
                                                            }
                                                            //si existe alguna siguiente tool hacer rotacion. si no, no hacer nada.

                                                            if (valorsiguientetool != 1000) {

                                                                setTimeout(function() {

                                                                    cmd = "i" + valorsiguientetool;
                                                                    //alert(cmd);
                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd + "\n");
                                                                    //Cambio brazo en la tabla.
                                                                    var HttpClient = function() {

                                                                        esto.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }
                                                                    var theurl = 'http://192.168.0.98/rotarcar/' + valorsiguientetool;
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {

                                                                    });



                                                                }, 1000);

                                                            }

                                                        }
                                                    });
                                                    //



                                                    esto.bajartstopsBtnClick();
                                                    setTimeout(function() {
                                                        var self = esto;





                                                        var HttpClient = function() {
                                                            esto.get = function(aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function() {
                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                        aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                            }
                                                        }


                                                        var theurl = 'http://192.168.0.82/arduino/digital/45';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D45 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {
                                                                var HttpClient = function() {
                                                                    esto.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }


                                                                var theurl = 'http://192.168.0.82/arduino/digital/36';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {

                                                                    var res = response.split("Pin D36 set to ");

                                                                    response = parseInt(res[1]);

                                                                    if (response == 1) {


                                                                        var HttpClient = function() {
                                                                            esto.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }


                                                                        var theurl = 'http://192.168.0.83/arduino/digital/27';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {

                                                                            var res = response.split("Pin D27 set to ");

                                                                            response = parseInt(res[1]);

                                                                            if (response == 1) {

                                                                                var HttpClient = function() {
                                                                                    esto.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }

                                                                                //Arduino 8.
                                                                                var theurl = 'http://192.168.0.83/arduino/digital/28';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var res = response.split("Pin D28 set to ");

                                                                                    response = parseInt(res[1]);

                                                                                    if (response == 1) {


                                                                                        chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);
                                                                                    } else {

                                                                                        // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                        erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                        document.getElementById("textoerrores").value = erroresexistentes;

                                                                                        var cmd = "!";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";

                                                                                    }
                                                                                });

                                                                            } else {

                                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                document.getElementById("textoerrores").value = erroresexistentes;

                                                                                var cmd = "!";
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                            }

                                                                        });

                                                                    } else {

                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                        erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                        document.getElementById("textoerrores").value = erroresexistentes;

                                                                        var cmd = "!";
                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                        // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                    }

                                                                });
                                                            } else {

                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                var cmd = "!%";
                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);

                                                                esto.getGcode();
                                                                console.log("got onPlay. esto:", esto, "event:", event);




                                                                // indicate we're starting play in the UI
                                                                $('.com-chilipeppr-widget-gcode-startindicator').removeClass("hidden");

                                                                // fire off pubsub signal for others to watch the play btn
                                                                var meta = {
                                                                    isPlayByUser: event ? true : false
                                                                };
                                                                meta.gcodeLines = esto.fileLines;


                                                                //hacer cambio de herramienta previa si esta en modoh.********************************

                                                                //ELIMINARESTO
                                                                chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);



                                                                var HttpClient = function() {

                                                                    esto.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                var theurl = 'http://192.168.0.98/geth';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {

                                                                    var obj = JSON.parse(response);


                                                                    var modoh = obj[0]['modoh'];
                                                                    // SI ES MODO H:
                                                                    if (modoh) {
                                                                        var HttpClient = function() {

                                                                            esto.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }
                                                                        var theurl = 'http://192.168.0.98/geth';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {

                                                                            var obj = JSON.parse(response);
                                                                            window.objetodah = obj;
                                                                        });


                                                                        var largodecodigo = esto.fileLines.length;
                                                                        var valorsiguientetool = 1000;

                                                                        for (var n = 0; n < largodecodigo; n++) {

                                                                            var gcodetemporal = esto.fileLines[n];

                                                                            if (gcodetemporal.match(/\bM6\b/i)) {

                                                                                var linean = "N" + (n + 1);
                                                                                var lineatemporal = gcodetemporal.replace('M6', "").trim();
                                                                                lineatemporal = lineatemporal.replace('M7', "").trim();
                                                                                lineatemporal = lineatemporal.replace('T', "").trim();
                                                                                lineatemporal = lineatemporal.replace(linean, "").trim();
                                                                                var valorstool = parseInt(lineatemporal);
                                                                                n = 100000;

                                                                            }
                                                                        }

                                                                        for (var i = 0; i < 17; i++) {
                                                                            if (parseInt(obj[i]['herramienta']) == valorstool) {
                                                                                // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                var indexher = i;
                                                                                valorsiguientetool = i + 1;
                                                                            }
                                                                        }
                                                                        //si existe alguna siguiente tool hacer rotacion. si no, no hacer nada.

                                                                        if (valorsiguientetool != 1000) {

                                                                            setTimeout(function() {

                                                                                cmd = "i" + valorsiguientetool;
                                                                                //alert(cmd);
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd + "\n");
                                                                                //Cambio brazo en la tabla.
                                                                                var HttpClient = function() {

                                                                                    esto.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/rotarcar/' + valorsiguientetool;
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                });



                                                                            }, 1000);

                                                                        }

                                                                    }
                                                                });
                                                                //



                                                                esto.bajartstopsBtnClick();
                                                                setTimeout(function() {
                                                                    var self = esto;





                                                                    var HttpClient = function() {
                                                                        esto.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }


                                                                    var theurl = 'http://192.168.0.82/arduino/digital/45';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {

                                                                        var res = response.split("Pin D45 set to ");

                                                                        response = parseInt(res[1]);

                                                                        if (response == 1) {
                                                                            var HttpClient = function() {
                                                                                esto.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }


                                                                            var theurl = 'http://192.168.0.82/arduino/digital/36';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var res = response.split("Pin D36 set to ");

                                                                                response = parseInt(res[1]);

                                                                                if (response == 1) {


                                                                                    var HttpClient = function() {
                                                                                        esto.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }


                                                                                    var theurl = 'http://192.168.0.83/arduino/digital/27';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        var res = response.split("Pin D27 set to ");

                                                                                        response = parseInt(res[1]);

                                                                                        if (response == 1) {

                                                                                            var HttpClient = function() {
                                                                                                esto.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }

                                                                                            //Arduino 8.
                                                                                            var theurl = 'http://192.168.0.83/arduino/digital/28';
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {

                                                                                                var res = response.split("Pin D28 set to ");

                                                                                                response = parseInt(res[1]);

                                                                                                if (response == 1) {


                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);
                                                                                                } else {

                                                                                                    // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                                                                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                                    erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                                    document.getElementById("textoerrores").value = erroresexistentes;

                                                                                                    var cmd = "!";
                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                                                    document.getElementById("indicadorerrorejec").className = "led-red";

                                                                                                }
                                                                                            });

                                                                                        } else {

                                                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                            erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                            document.getElementById("textoerrores").value = erroresexistentes;

                                                                                            var cmd = "!";
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                            // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                                        }

                                                                                    });

                                                                                } else {

                                                                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                    erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                    document.getElementById("textoerrores").value = erroresexistentes;

                                                                                    var cmd = "!";
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                    // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                                }

                                                                            });
                                                                        } else {

                                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                            erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                            document.getElementById("textoerrores").value = erroresexistentes;

                                                                            var cmd = "!";
                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                                            // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                        }

                                                                    });

                                                                    // CODIGO A PEGAR 
                                                                }, 8000);

                                                                document.getElementById("textoerrores").value = erroresexistentes;

                                                                var cmd = "!";
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + esto.serialPort + " " + cmd);
                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                // MESA A NO ESTA EN POSICION DE TRABAJO

                                                            }

                                                        });

                                                        // CODIGO A PEGAR 
                                                    }, 8000);

                                                    // ACA VA EL CODIGO DE PLAY.


                                                    var cmd = "!%";
                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                    this.getGcode();
                                                    console.log("got onPlay. this:", this, "event:", event);




                                                    // indicate we're starting play in the UI
                                                    $('.com-chilipeppr-widget-gcode-startindicator').removeClass("hidden");

                                                    // fire off pubsub signal for others to watch the play btn
                                                    var meta = {
                                                        isPlayByUser: event ? true : false
                                                    };
                                                    meta.gcodeLines = this.fileLines;


                                                    //hacer cambio de herramienta previa si esta en modoh.********************************

                                                    //ELIMINARESTO
                                                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);



                                                    var HttpClient = function() {

                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    var theurl = 'http://192.168.0.98/geth';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var obj = JSON.parse(response);


                                                        var modoh = obj[0]['modoh'];
                                                        // SI ES MODO H:
                                                        if (modoh) {
                                                            var HttpClient = function() {

                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }
                                                            var theurl = 'http://192.168.0.98/geth';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {

                                                                var obj = JSON.parse(response);
                                                                window.objetodah = obj;
                                                            });


                                                            var largodecodigo = esto.fileLines.length;
                                                            var valorsiguientetool = 1000;

                                                            for (var n = 0; n < largodecodigo; n++) {

                                                                var gcodetemporal = esto.fileLines[n];

                                                                if (gcodetemporal.match(/\bM6\b/i)) {

                                                                    var linean = "N" + (n + 1);
                                                                    var lineatemporal = gcodetemporal.replace('M6', "").trim();
                                                                    lineatemporal = lineatemporal.replace('M7', "").trim();
                                                                    lineatemporal = lineatemporal.replace('T', "").trim();
                                                                    lineatemporal = lineatemporal.replace(linean, "").trim();
                                                                    var valorstool = parseInt(lineatemporal);
                                                                    n = 100000;

                                                                }
                                                            }

                                                            for (var i = 0; i < 17; i++) {
                                                                if (parseInt(obj[i]['herramienta']) == valorstool) {
                                                                    // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                    var indexher = i;
                                                                    valorsiguientetool = i + 1;
                                                                }
                                                            }
                                                            //si existe alguna siguiente tool hacer rotacion. si no, no hacer nada.

                                                            if (valorsiguientetool != 1000) {

                                                                setTimeout(function() {

                                                                    cmd = "i" + valorsiguientetool;
                                                                    //alert(cmd);
                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd + "\n");
                                                                    //Cambio brazo en la tabla.
                                                                    var HttpClient = function() {

                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }
                                                                    var theurl = 'http://192.168.0.98/rotarcar/' + valorsiguientetool;
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {

                                                                    });



                                                                }, 1000);

                                                            }

                                                        }
                                                    });
                                                    //



                                                    this.bajartstopsBtnClick();
                                                    setTimeout(function() {
                                                        var self = this;





                                                        var HttpClient = function() {
                                                            this.get = function(aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function() {
                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                        aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                            }
                                                        }


                                                        var theurl = 'http://192.168.0.82/arduino/digital/45';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D45 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {
                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }


                                                                var theurl = 'http://192.168.0.82/arduino/digital/36';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {

                                                                    var res = response.split("Pin D36 set to ");

                                                                    response = parseInt(res[1]);

                                                                    if (response == 1) {


                                                                        var HttpClient = function() {
                                                                            this.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }


                                                                        var theurl = 'http://192.168.0.83/arduino/digital/27';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {

                                                                            var res = response.split("Pin D27 set to ");

                                                                            response = parseInt(res[1]);

                                                                            if (response == 1) {

                                                                                var HttpClient = function() {
                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }

                                                                                //Arduino 8.
                                                                                var theurl = 'http://192.168.0.83/arduino/digital/28';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var res = response.split("Pin D28 set to ");

                                                                                    response = parseInt(res[1]);

                                                                                    if (response == 1) {


                                                                                        chilipeppr.publish("/com-chilipeppr-widget-gcode/onplay", meta);
                                                                                    } else {

                                                                                        // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                        erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                        document.getElementById("textoerrores").value = erroresexistentes;

                                                                                        var cmd = "!";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";

                                                                                    }
                                                                                });

                                                                            } else {

                                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                                document.getElementById("textoerrores").value = erroresexistentes;

                                                                                var cmd = "!";
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                            }

                                                                        });

                                                                    } else {

                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                        erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                        document.getElementById("textoerrores").value = erroresexistentes;

                                                                        var cmd = "!";
                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                        // MESA A NO ESTA EN POSICION DE TRABAJO

                                                                    }

                                                                });
                                                            } else {

                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                erroresexistentes = erroresexistentes.concat("Pines no lograron bajar, Error de Movimiento");

                                                                document.getElementById("textoerrores").value = erroresexistentes;

                                                                var cmd = "!";
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                // MESA A NO ESTA EN POSICION DE TRABAJO

                                                            }

                                                        });

                                                        // CODIGO A PEGAR 
                                                    }, 8000);




                                                    // TERMINA EL CODIGO DE PLAY




                                                } else {

                                                    alert(
                                                        "Mesa A no está bloqueada"
                                                    );

                                                }
                                            });



                                        } else {

                                            alert(
                                                "Mesa A no está en posición de trabajo"
                                            );

                                        }
                                    });




                                } else {

                                    alert(
                                        "Mesa Y no está bloqueada"
                                    );

                                }
                            });



                        } else {

                            alert(
                                "Mesa Y no está en posición de trabajo"
                            );

                        }
                    });



                    ///TERMINAAAAA




                },
                getGcode: function() {
                    chilipeppr.subscribe("/com-chilipeppr-widget-gcode/recvGcode", this, this.getGcodeCallback);
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/requestGcode", "");
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-gcode/recvGcode", this.getGcodeCallback);
                },
                getGcodeCallback: function(data) {
                    this.gcode = data;
                },
                isResetMetaBeforePlay: false, // this is set to true after a play has been completed and done all the way to the end. usually we reset the meta data when user hits stop, but we want to let the user know all lines were completed after their job was done so we don't reset. however, if they hit play again we need to reset
                isJobDonePubSubSent: false, // track this so that we don't fire the end of job pubsub event more than once. this was needed because you could sleep your laptop after a job done, then unsleep, reconnect to cnc controller, get the line complete status again, and think the job just got done when it clearly didn't

                onPlayAfter: function(event) {
                    // loop thru each line and send gcode
                    console.log("got onPlayAfter. this:", this, "event:", event);
                    //console.log(event);

                    $('.com-chilipeppr-widget-gcode-startindicator').addClass("hidden");


                    if (this.isResetMetaBeforePlay) {
                        this.resetMetaDataQueueWriteComplete();
                        this.isResetMetaBeforePlay = false;
                    }

                    this.isInExecuteScrollToMode = false;

                    // set back to false so we get job done pubsub
                    this.isJobDonePubSubSent = false;

                    // track time for job
                    this.timeStart = new Date().getTime();
                    $('#gcode-time-start').text(new Date().toLocaleTimeString());

                    // configure buttons
                    $('#com-chilipeppr-widget-gcode-play').prop("disabled", true);
                    $('#com-chilipeppr-widget-gcode-pause').prop("disabled", false);
                    $('#com-chilipeppr-widget-gcode-stop').prop("disabled", false);

                    this.feedrateDisable();

                    this.isPlaying = true;
                    this.isPaused = false;


                    if (this.currentLine != null)
                        this.lastLineMarkedExecuted = this.currentLine;
                    else
                        this.lastLineMarkedExecuted = 0;

                    $('#com-chilipeppr-widget-gcode-pause').removeClass("active");

                    if (event && this.options.ppsOnPlayFlush)
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "%\n");


                    if (this.options.preUpload && this.options.preUpload != 'none') {
                        // TODO. double check if in send to 3d viewer mode
                        // to skip this

                        var numToUpload = parseInt(this.options.preUpload);

                        console.log("user wants a preload. N lines:", numToUpload);
                        if (numToUpload > this.fileLines.length) {
                            numToUpload = this.fileLines.length - 1;
                        }

                        chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Pre-Uploading Gcode", "Pre-Uploading " + numToUpload + " lines. This may take a while. This message will dismiss when completed.", 3000);

                        this.onPreUpload(numToUpload);

                    }

                    if (this.isInMultiLineMode) {
                        console.log("in multi line send mode");
                        this.onPlayNextLine();
                    } else {
                        // do single line mode
                        this.onPlayNextLine();
                    }


                    return true;
                },
                isInMultiLineMode: false, // are we in single line play mode or multiline mode?
                multiLines: 1, // how many lines to send each multi call
                onPlayMultiLine: function() {
                    // In this strategy we will play multiple lines at a time
                    // Since we call onPreUpload() which plays as many lines as we went
                    // and uses step mode, there's no auto setTimeout to play next line
                    // so we must mimic that

                    if (this.isPaused) {
                        console.log("onPlayMultiLine. we're now paused by user, so exiting. you can unpause and call me again.");
                        return;
                    }
                    if (!this.isPlaying) {
                        console.log("onPlayMultiLine. we're being asked to stop, so exiting.");
                        return;
                    }

                    if (this.isPausedByPlanner) {
                        console.log("onPlayMultiLine: we are paused by planner, so exiting.");
                        return;
                    }

                    var numToUpload = this.multiLines;
                    console.log("user wants a multiplay of. N lines:", numToUpload);
                    if (numToUpload > this.fileLines.length - this.currentLine) {
                        numToUpload = this.fileLines.length - this.currentLine;
                        console.log("multilines to play is too long. shortening to:", numToUpload);

                        if (numToUpload == 0) {
                            console.log("Done playing multiline. Playing one additional onPlayNextLine() to trigger end.");
                            this.onPlayNextLine();
                            return;
                        }
                    }

                    this.onPreUpload(numToUpload);

                    // Just use the delayPerLine setting for now. Could make this a seperate setting
                    setTimeout(this.onPlayNextLine.bind(this), this.delayPerLine);
                },
                onPreUpload: function(numToUpload) {
                    console.log("inside onPreUpload. user wants N lines uploaded:", numToUpload);

                    // tell onPlayNextLine() to not scroll
                    this.isPlayNextLineNoScroll = true;
                    // let playNextLine() know we're in pre-upload mode
                    // so it can do some intelligent decision making
                    this.isInPreUploadMode = true;

                    this.preUploadGang = ""; // clear preupload string
                    this.preUploadGangArr = []; // clear preupload array
                    // subscribe at priority 1 better than default of 10
                    //chilipeppr.subscribe("/com-chilipeppr-widget-serialport/send", this, this.onPreUploadCallback, 9);
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/jsonSend", this, this.onPreUploadCallback, 1);

                    //set boolean for whether the preload gets cancelled (due to M6) and needs to resume with remaining lines.
                    //var isCancelled = false;

                    for (var ctr = 0; ctr < numToUpload; ctr++) {
                        console.log("ganging line:", ctr);
                        // use step mode as our technique
                        // as if we're stepping thru all these lines
                        // just really fast
                        if (ctr == numToUpload - 1) {
                            // last line, so do want to jump to line in scroll area
                            console.log("onPreUpload. last line so asking to jump to line in scroll area. ctr:", ctr);
                            this.isPlayNextLineNoScroll = false;
                            this.preUploadRemainder = 0; //set to zero once all preupload lines have been sent.
                        }
                        this.isPlayStep = true;
                        var cancelled = this.onPlayNextLine();
                        if (cancelled) {
                            this.preUploadRemainder = (numToUpload - (ctr + 1)); //store the number of lines remaining.
                            console.log("we were cancelled with our preupload by onPlayNextLine(), so exit the preUpload: " + (numToUpload - (ctr + 1)));
                            break;
                        }
                    }

                    // remove step mode
                    this.isPlayStep = false;

                    // unsubscribe
                    //chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/send", this.onPreUploadCallback);
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/jsonSend", this.onPreUploadCallback);

                    // since this can be a slow process, alert the user this will take a while


                    // send actual ganged lines
                    //chilipeppr.publish("/com-chilipeppr-widget-serialport/send", this.preUploadGang);
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/jsonSend", this.preUploadGangArr);

                    //chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Pre-Uploading Gcode", "Done pre-uploading " + amtLinesToUpload + " lines.", 3000);




                    this.statEls.sent.text(this.currentLine);
                    this.statEls.remaining.text(this.fileLines.length - this.currentLine);
                    //this.statEls.timeStart.text(this.timeStart);
                    var dur = new Date().getTime() - this.timeStart;
                    dur = this.toHHMMSS(parseInt(dur / 1000));
                    this.statEls.timeDur.text(dur);

                    // tell onPlayNextLine() to scroll again
                    // only run these commands if the preload was not cancelled due to an M6, otherwise we will re-enter this loop after the pause to complete preload.
                    if (this.preUploadRemainder === 0) {
                        this.isPlayNextLineNoScroll = false;
                        this.isInPreUploadMode = false;
                    }
                },
                preUploadGang: "", // was used for stringing together strings
                preUploadGangArr: [], // now we're using an array since using jsonSend
                onPreUploadCallback: function(data) {
                    console.log("onPreUploadCallback. data:", data);
                    //this.preUploadGang += data;
                    this.preUploadGangArr.push(data);
                    return false; // so other subscribes don't get this
                },
                statEls: null,
                isPlayNextLineNoScroll: false, // whether we scroll (preupload asks us not to)
                onPlayNextLine: function() {

                    // if this is a single step, ignore the pause and playing params
                    if (this.isPlayStep) {
                        console.log("this is a single step");
                    } else {
                        if (this.isPaused) {
                            console.log("onPlayNextLine. we're now paused by user, so exiting. you can unpause and call me again.");
                            return;
                        }
                        if (!this.isPlaying) {
                            console.log("onPlayNextLine. we're being asked to stop, so exiting.");
                            return;
                        }
                    }
                    if (this.isPausedByPlanner) {
                        console.log("onPlayNextLine: we are paused by planner, so exiting.");
                        return;
                    }

                    console.log("this.currentLine:", this.currentLine);
                    // ACA SE ESTA TRABAJANDO


                    if (this.currentLine > 0) {
                        var linea = this.fileLines[this.currentLine - 1];

                        if (linea.match(/\bUAO\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bUTO\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bM6\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bM7\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bM199\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bPAUSA\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bM57\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }
                        if (linea.match(/\bM58\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }


                    }
                    if (this.currentLine > 1) {
                        var lineaantes = this.fileLines[this.currentLine - 2];
                        if (lineaantes.match(/\bPAUSA\b/i)) {
                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                        }

                    }



                    // FIN SE ESTA TRABAJANDO




                    var ctr = this.currentLine != null ? this.currentLine : 0;
                    localStorage.setItem('currentLine', ctr);
                    if (ctr >= this.fileLines.length) {
                        console.log("at end of buffering gcode. exiting.");
                        chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Sender", "Done buffering Gcode.", 3000, true);
                        chilipeppr.publish("/com-chilipeppr-widget-gcode/doneBuffering", "Duration " + this.statEls.timeDur.text() + " Lines " + this.fileLines.length);
                        // mimic pressing stop
                        //this.onStop();
                        return;
                    }

                    var linegcode = this.fileLines[ctr];
                    //console.log("    orig gcode:", linegcode);

                    // we need to apply the feedrate multiplier
                    linegcode = this.getFeedrateMarkup(linegcode, true);
                    //console.log("after feedrate:", linegcode);

                    //console.log("onPLay. line:", ctr, " gcode:", linegcode);

                    // publish to serial port to send to cnc controller
                    if (this.options.whenPlay == "serial") {
                        //chilipeppr.publish("/com-chilipeppr-widget-serialport/send", linegcode + "\n");
                        // use the new jsonSend
                        var json = {
                            D: linegcode + "\n",
                            Id: "g" + (ctr + 1) // use 1-based index, not 0-based cuz UI shows 1-based
                        }
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/jsonSend", json);

                    }



                    // publish to 3d viewer so it syncs to us
                    if (this.options.whenPlay == "3d")
                        chilipeppr.publish("/com-chilipeppr-widget-3dviewer/gotoline", {
                            line: ctr,
                            gcode: linegcode
                        });


                    this.currentLine++;
                    localStorage.setItem('currentLine', this.currentLine);
                    if (this.statEls == null) {
                        //console.log("lazy loading statEls");
                        this.statEls = {
                            sent: $('#gcode-lines-sent'),
                            remaining: $('#gcode-lines-remaining'),
                            timeStart: $('#gcode-time-start'),
                            timeDur: $('#gcode-time-dur')
                        }
                    }

                    // update DOM to show how many lines are sent
                    if (!this.isInPreUploadMode) {

                        //console.log("udpating stats. statEls:", this.statEls);
                        this.statEls.sent.text(this.currentLine);
                        this.statEls.remaining.text(this.fileLines.length - this.currentLine);
                        //this.statEls.timeStart.text(this.timeStart);
                        var dur = new Date().getTime() - this.timeStart;
                        dur = this.toHHMMSS(parseInt(dur / 1000));
                        this.statEls.timeDur.text(dur);
                    }

                    if (linegcode.match(/M0?6/i)) {
                        // yes, it's m6
                        // see if they want pause
                        if (this.options.pauseOnM6) {
                            this.gotoLine(this.currentLine, true);
                            // pass a null event, but true for the isFromM6 parameter
                            this.onPause(null, true);
                            //this.showToolChangeModal(linegcode,"onplay");
                            // sync gcode list view
                            //if (!this.isPlayNextLineNoScroll)
                            // dont' go to next line, just return
                            return true;
                        } else {
                            console.log("got m6 but user does not want pause. continuing.");
                        }
                    }

                    //console.log("testing for chilipeppr_pause");
                    if (linegcode.match(/chilipeppr_pause/i)) {
                        // yes, it's chilipeppr_pause which simply
                        // means we stop buffering up gcode to SPJS, fire off
                        // an event to let anybody else know, and they have to ask us
                        // to unpause

                        console.log("got chilipeppr_pause. linegcode:", linegcode);

                        this.gotoLine(this.currentLine, true);

                        this.onChiliPepprPause({
                            line: ctr,
                            gcode: linegcode
                        });

                        // dont' go to next line, just return
                        return true;

                    }

                    // delay next line
                    if (this.isPlayStep) {
                        // don't queue up next line, just mark we're done with step
                        this.isPlayStep = false;
                    } else {
                        // queue up next line
                        setTimeout(this.onPlayNextLine.bind(this), this.delayPerLine);
                    }
                },
                onChiliPepprPause: function(meta) {
                    console.log("onChiliPepprPause");


                    this.onPause(null, false, true);

                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onChiliPepprPause", meta);

                },
                onChiliPepprPauseOnComplete: function(meta) {
                    console.log("onChiliPepprPauseOnComplete");
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnComplete", meta);
                },
                onChiliPepprPauseOnExecute: function(meta) {
                    console.log("onChiliPepprPauseOnExecute");
                    chilipeppr.publish("/com-chilipeppr-widget-gcode/onChiliPepprPauseOnExecute", meta);
                },
                toHHMMSS: function(secs) {
                    var sec_num = parseInt(secs, 10); // don't forget the second param
                    var hours = Math.floor(sec_num / 3600);
                    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                    var seconds = sec_num - (hours * 3600) - (minutes * 60);

                    if (hours < 10) {
                        hours = "0" + hours;
                    }
                    if (minutes < 10) {
                        minutes = "0" + minutes;
                    }
                    if (seconds < 10) {
                        seconds = "0" + seconds;
                    }
                    var time = hours + ':' + minutes + ':' + seconds;
                    return time;
                },
                // linenum is 1-based
                gotoLine: function(linenum, isMarkSent) {

                    //console.log("gotoLine:", linenum);

                    // linenum is 1-based (not 0-based) since table is 1-based
                    if (linenum < this.showingStartIndex || linenum > this.showingEndIndex) {
                        // we are needing to show a line way ahead of where we're being asked to show
                        console.log("We are being asked to scroll to a line that does not exist so rendering new. linenum:", linenum);
                        this.jumpToLine(linenum);
                        //return;
                    }

                    var container = $('#com-chilipeppr-widget-gcode-body');
                    // figure out correct index from this.showingStartIndex and linenum
                    var indx = linenum - this.showingStartIndex;
                    var tr = $('#com-chilipeppr-widget-gcode-tbl tbody tr').eq(indx);

                    this.updateRowQueueStatsEl(tr);

                    var scrollTo = tr;
                    console.log("indx:", indx, "scrollTo:", scrollTo);


                    container.scrollTop(
                        scrollTo.offset().top - container.offset().top + container.scrollTop()
                    );




                },
                fileInfo: null, // stores the info for the file drag/dropped
                onFileLoaded: function(txt, info, skipLocalStore) {
                    console.log("Got onFileLoaded. txt.length:", txt.length, "info:", info, "skipLocalStore", skipLocalStore);
                    this.fileInfo = info;

                    //Check for G20 or G21 command. Exit onFileLoaded and prompt user to specify
                    if (this.isDirtyUnits === false && txt.match(/(G20|G21)/i) === null) {
                        //no units command found.  prompt user to select units.
                        //this could also exit the onFileLoaded function, but failsafe would be to let this method continue in background and reissue once units selected by user.
                        this.showUOMModal(txt, info, skipLocalStore);
                    }


                    var isDirty = false;

                    //if G20 or G21 was added manually, mark as dirty to re-issue to workspace.
                    if (this.isDirtyUnits === true) {
                        isDirty = true;
                        this.isDirtyUnits = false;
                    }

                    var that = this;
                    //console.log(arguments);
                    //console.log(txt);
                    // parse the text file and generate rows
                    $('#com-chilipeppr-widget-gcode-tbl > tbody').html("");

                    this.fileLines = txt.split(/\r{0,1}\n/);
                    //this.fileLines = txt.split(/\n/);

                    // see if last line is empty and if so, drop ito
                    if (this.fileLines[this.fileLines.length - 1].length == 0) {
                        this.fileLines.pop();
                    }

                    // do some pre-processing
                    // make all %!~ characters on their own line become a comment
                    // swap in %!~ inside comments to words as well
                    var didWeRemoveAnyEmptyLines = false;
                    var newFileLines = [];
                    for (var idx = 0; idx < this.fileLines.length; idx++) {
                        var fileLine = this.fileLines[idx];
                        if (fileLine.match(/^\s*[%!~]/)) {
                            console.log("found line that had %!~ in it. line:", fileLine);
                            fileLine = fileLine.replace(/%/, ";percent not allowed");
                            fileLine = fileLine.replace(/!/, ";exclamation not allowed");
                            fileLine = fileLine.replace(/~/, ";tilde not allowed");
                            this.fileLines[idx] = fileLine;
                        }
                        // also check for !~% inside comments and swap
                        if (fileLine.match(/\(.*[!~%]/)) {
                            fileLine = fileLine.replace(/!/, "exclamation");
                            fileLine = fileLine.replace(/~/, "tilde");
                            fileLine = fileLine.replace(/%/, "percent");
                            this.fileLines[idx] = fileLine;
                        }

                        // trim
                        fileLine = fileLine.trim();

                        // remove line numbers
                        if (this.options.addlinenums) {
                            if (fileLine.match(/N\d/i)) {

                                if (fileLine.match(/^;|^\(.*\)$/)) {
                                    //console.warn("we have whole line comment, ignore");
                                } else {

                                    var myFileLine = fileLine.replace(/N\s*\d+/ig, "");
                                    // comments removed
                                    // now we can see what the number is
                                    fileLine = myFileLine;
                                }
                                //console.warn("line at end:", fileLine);
                            }
                        }

                        // remove empty lines (problem is we won't line up with
                        // 3d viewer lines anymore)
                        if (this.options.removeemptylines) {
                            if (fileLine.match(/^\s*$/)) {
                                //console.warn("got empty line:", fileLine);
                                didWeRemoveAnyEmptyLines = true;
                            } else {
                                newFileLines.push(fileLine);
                            }
                        } else {
                            newFileLines.push(fileLine);
                        }

                    }
                    this.fileLines = newFileLines;

                    this.metaLines = [];

                    // if adding line nums, do it here temporarily
                    if (this.options.addlinenums) {
                        for (var idx = 0; idx < this.fileLines.length; idx++) {
                            /*if (this.fileLines[idx].match(/^;|^\(.*\)$/)) {
                                // don't add line num
                                //console.warn("we have whole line comment, ignore");
                                this.metaLines[idx] = { isComment: true }
                            } else {*/
                            this.fileLines[idx] = "N" + (idx + 1) + " " + this.fileLines[idx];
                            //}
                        }
                    }
                    /*else {
                                   // still parse for comments cuz need those for knowing
                                   // whether onExecute will come back or not
                                   
                               }*/

                    // see if we removed/added lines and mark as isDirty
                    // so we know at end of this open method to re-send the Gcode
                    // file back into the workspace
                    if (didWeRemoveAnyEmptyLines) {
                        isDirty = true;
                    }

                    $('#com-chilipeppr-widget-gcode-footer #gcode-lines').text(this.fileLines.length);
                    $('#com-chilipeppr-widget-gcode-footer #gcode-lines-sent').text("0");
                    $('#com-chilipeppr-widget-gcode-footer #gcode-lines-remaining').text(this.fileLines.length);

                    this.appendRows(1);

                    //this.setupInfiniteScroll();
                    this.setupJumpScroll();

                    // now format the gcode
                    console.log("going to parse gcode to hilite it.");
                    this.parseGcode();
                    if (skipLocalStore != undefined && skipLocalStore == true) {
                        console.log("skipping storing local file to retain url path load");
                    } else {
                        // we can get a QuotaExceededError here, so catch it
                        try {
                            // remove old 1st to perhaps make more room for quota check
                            localStorage.removeItem('last-imported');
                            // now set
                            localStorage.setItem('last-imported', txt);
                            console.log("stored gcode view file in local store as text");

                        } catch (e) {
                            if (e.name === 'QUOTA_EXCEEDED_ERR' || e.name == "QuotaExceededError" || e.code == 22 || e.name == "NS_ERROR_DOM_QUOTA_REACHED" || e.code == 1014) {
                                //this.sceneRemove(this.object);
                                // show err dialog
                                // $('#com-chilipeppr-widget-gcode-outofspace').modal();
                                console.error("Gcode Widget. out of local storage space, but letting user proceed. err:", e);

                            } else {
                                console.error("Gcode Widget. got generic uncaught err with localStorage:", e);
                            }
                        }
                        //localStorage.setItem('last-imported', txt);
                        localStorage.removeItem('last-loaded');
                    }

                    if (isDirty) {

                        setTimeout(this.resendGcodeToWorkspace.bind(this), 200);

                        // get estimated time duration. request this after a few
                        // seconds to give best chance of 3d viewer being loaded
                        setTimeout(this.getEstimates.bind(this), 1000);

                        // now call our post opening call
                        console.log("tool change will get called in 3.5secs");
                        setTimeout(this.onAfterGcodeFileLoaded.bind(this), 1500);


                        return false;
                    } else {

                        // get estimated time duration. request this after a few
                        // seconds to give best chance of 3d viewer being loaded
                        setTimeout(this.getEstimates.bind(this), 1000);

                        // now call our post opening call
                        console.log("tool change will get called in 3.5secs");
                        setTimeout(this.onAfterGcodeFileLoaded.bind(this), 1500);
                    }
                },
                resendGcodeToWorkspace: function() {
                    // we need to send this gcode file back to the workspace
                    // however, we don't want to get it back ourself, so unsubscribe
                    // from the drag/drop event. then send. the re-subscribe.
                    chilipeppr.unsubscribe("/com-chilipeppr-elem-dragdrop/ondropped", this.onFileLoaded);
                    var obj = {
                        gcode: this.fileLines.join("\n"),
                        info: this.fileInfo
                    };
                    chilipeppr.publish("/com-chilipeppr-elem-dragdrop/loadGcodeDoNotCreateRecentFileEntry", obj);
                    chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondropped", this, this.onFileLoaded);

                },
                jumpToTop: function() {

                    this.infiniteScrollDestroy();
                    this.removeAllRows();
                    this.appendRows(1);
                    /*
                     var elem = $('#com-chilipeppr-widget-gcode-tbl');
                     console.log("elem.height():", elem.height());
                     */
                    $('#com-chilipeppr-widget-gcode-body').scrollTop(0);
                },
                // linenum is 1-based
                jumpToLine: function(linenum) {

                    this.infiniteScrollDestroy();
                    this.removeAllRows();
                    this.appendRows(linenum);
                    /*
                     var elem = $('#com-chilipeppr-widget-gcode-tbl');
                     console.log("elem.height():", elem.height());
                     */
                    $('#com-chilipeppr-widget-gcode-body').scrollTop(0);
                },
                setupJumpScroll: function() {
                    var that = this;
                    $('.com-chilipeppr-gcode-jumpscroll .paginator-first').click(function() {
                        console.log("jump scroll to end");
                        that.jumpToTop();

                    });
                    $('.com-chilipeppr-gcode-jumpscroll .paginator-last').click(function() {
                        console.log("jump scroll to end");
                        that.infiniteScrollDestroy();
                        that.removeAllRows();
                        that.appendRows(that.fileLines.length - that.linesToShow + 1);
                        var elem = $('#com-chilipeppr-widget-gcode-tbl');
                        console.log("elem.height():", elem.height());
                        $('#com-chilipeppr-widget-gcode-body').scrollTop(elem.height() + 10);
                    });
                    // loop thru div 2 thru 8 to attach
                    var rowsPerJump = parseInt(this.fileLines.length / 9);
                    for (var ctr = 0; ctr <= 7; ctr++) {
                        //console.log("attaching click to div ctr:", ctr);
                        var jumpAmt = rowsPerJump * (ctr + 1);
                        var el = $('.com-chilipeppr-gcode-jumpscroll .paginator').eq(ctr);
                        //console.log("EL:", el);
                        el.click(jumpAmt, function(evt) {
                            console.log("jump scroll to:", evt.data);
                            that.infiniteScrollDestroy();
                            that.removeAllRows();
                            that.appendRows(evt.data);
                        });

                    }

                    this.preSetupInfiniteScroll(true);
                },
                preSetupInfiniteScroll: function(doTopScrollOffset) {
                    // Make clickable buttons at top/bottom in case waypoint fails us (which it has been doing)
                    // I think the waypoint dies on resize
                    var wayStart = $('#showstart');
                    var wayEnd = $('#showend');
                    var that = this;

                    wayStart.click(function(evt) {
                        console.log("click on waypoint for top. evt:", evt);
                        if (that.showingStartIndex == 1) {
                            console.log("Already at startIndex 1. Not rendering more.");
                        } else {
                            console.log("There's more to show at start. rendering...");
                            that.prependRows(that.showingStartIndex);
                        }
                    });
                    if (doTopScrollOffset) $('#com-chilipeppr-widget-gcode-body').scrollTop(10);

                    wayEnd.click(function(evt) {
                        console.log("click on waypoint for bottom. evt:", evt);
                        if (that.showingEndIndex >= that.fileLines.length) {
                            console.log("Already at endIndex max (fileLInes). Not rendering more.");
                        } else {
                            console.log("There's more to show at end. rendering...");
                            that.appendRows(that.showingEndIndex + 1);
                        }
                    });

                },
                infiniteScrollDestroy: function() {
                    //console.log("Destroying waypoints");
                    var wayStart = $('#showstart');
                    var wayEnd = $('#showend');


                    wayStart.waypoint('destroy');
                    wayEnd.waypoint('destroy');
                },
                setupInfiniteScroll: function(doTopScrollOffset) {
                    //console.log("setting up waypoints");
                    //console.log($('#showstart'));

                    if (!this.isBodyShowing) {
                        console.log("body not showing, so no reason to setup infinite scroll");
                        return;
                    }

                    var wayStart = $('#showstart');
                    var wayEnd = $('#showend');

                    // destory waypoints because as the DOM gets rows injected/removed
                    // the waypoints cache their x/y pos and so we need to recreate them
                    wayStart.waypoint('destroy');
                    wayEnd.waypoint('destroy');

                    var that = this;
                    wayStart.waypoint(function(direction) {
                        console.log("waypoint for top. dir:", direction);
                        if (direction == "up") {
                            console.log("scroll was up. loading more at start.");
                            if (that.showingStartIndex == 1) {
                                console.log("Already at startIndex 1. Not rendering more.");
                            } else {
                                console.log("There's more to show at start. rendering...");
                                that.prependRows(that.showingStartIndex);
                            }
                        }
                    }, {
                        context: '#com-chilipeppr-widget-gcode-body',
                        offset: -1
                            //offset: 'bottom-in-view',
                    });
                    if (doTopScrollOffset) $('#com-chilipeppr-widget-gcode-body').scrollTop(10);

                    wayEnd.waypoint(function(direction) {
                        console.log("waypoint for bottom. dir:", direction);
                        if (direction == "down") {
                            console.log("sroll was down. loading more at end.");
                            if (that.showingEndIndex >= that.fileLines.length) {
                                console.log("Already at endIndex max (fileLInes). Not rendering more.");
                            } else {
                                console.log("There's more to show at end. rendering...");
                                that.appendRows(that.showingEndIndex + 1);
                            }
                        }
                    }, {
                        context: '#com-chilipeppr-widget-gcode-body',
                        offset: 'bottom-in-view',
                    });
                },
                showingStartIndex: 0,
                showingEndIndex: 0,
                showingStats: function() {
                    $('#gcode-lines-showing').text(this.showingStartIndex + " - " + this.showingEndIndex);
                },
                // callbacks from serial port json server, i.e. serial port widget
                // so we can update meta data of lines completed
                setupOnQueueWriteCompletePubSub: function() {
                    // if we are in json mode we need to do a few unique things
                    // unsubscribe first just in case
                    console.group("gcode widget - setupOnQueueWriteCompletePubSub");
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/jsonSend", this, this.jsonOnSend);
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/onQueue", this, this.onQueue);
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/onWrite", this, this.onWrite);
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/onComplete", this, this.onComplete);
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/onError", this, this.onError);
                    // /com-chilipeppr-interface-cnccontroller/onExecute
                    chilipeppr.unsubscribe("/com-chilipeppr-interface-cnccontroller/onExecute", this, this.onExecute);

                    // 1. we subscribe to more events like /jsonOnQueue, /jsonOnWrite, /jsonOnComplete
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/jsonSend", this, this.jsonOnSend);
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/onQueue", this, this.onQueue);
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/onWrite", this, this.onWrite);
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/onComplete", this, this.onComplete);
                    chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/onExecute", this, this.onExecute);
                    chilipeppr.subscribe("/com-chilipeppr-widget-serialport/onError", this, this.onError);
                    console.groupEnd();
                },
                jsonOnSend: function(data) {

                    // write it to the log
                    //console.group("gcode widget - jsonOnSend");
                    console.log("jsonOnSend. data:", data);

                    // figure out if this was a one-off send or an array
                    var arr = [];
                    if (Array.isArray(data)) {
                        // we have array
                        console.log("jsonOnSend. got array of data instead of individual. must be in multi-send mode. cool.");
                        arr = data;
                    } else {
                        // one-off send. pretend array
                        arr.push(data);
                    }

                    for (var index = 0; index < arr.length; index++) {
                        var item = arr[index];
                        var msgEl;
                        // check that id string is not null/empty and starts with
                        // a g, cuz we make all our id's start with g
                        // otherwise this callback is not for us
                        if (item.Id.length > 0 && item.Id.match(/^g/)) {

                            console.log("jsonOnSend. seems we have an id for this item with a g. item:", item);
                            // get id
                            var id = item.Id;
                            // get numeric value cuz our ids are "g999"
                            var idnum = parseInt(id.replace(/g/, ""));
                            //console.log("derived idnum:", idnum, "id:", id);

                            // update meta data
                            if (this.metaLines[idnum - 1] == null) {
                                //console.log("no meta data for this element yet. creating it.");
                                this.metaLines[idnum - 1] = $.extend({}, this.metaObj);
                            }

                            // set that it is queued
                            this.metaLines[idnum - 1].isSent = true;
                            var linea = this.fileLines[idnum - 1];

                            // update the dom if this row is showing  
                            // send in 1-based number, not 0-based
                            // our id is 1-based, i.e. the row number
                            this.updateRowQueueStats(idnum);

                        }
                    }
                    //console.groupEnd();

                },
                onQueue: function(data) {

                    // write it to the log
                    //console.group("gcode widget - onQueue");
                    console.log("onQueue. data:", data);

                    var item = data;
                    var msgEl;


                    // check that id string is not null/empty and starts with
                    // a g, cuz we make all our id's start with g
                    // otherwise this callback is not for us
                    if (item.Id.length > 0 && item.Id.match(/^g/)) {

                        console.log("onQueue. seems we have an id for this item with a g. item:", item);
                        // get id
                        var id = item.Id;
                        // get numeric value cuz our ids are "g999"
                        var idnum = parseInt(id.replace(/g/, ""));
                        console.log("onQueue. derived idnum:", idnum, "id:", id);

                        // update meta data
                        if (this.metaLines[idnum - 1] == null) {
                            //console.log("onQueue. no meta data for this element yet. creating it.");
                            this.metaLines[idnum - 1] = $.extend({}, this.metaObj);
                        }

                        // set that it is queued
                        this.metaLines[idnum - 1].isQueued = true;


                        // update the dom if this row is showing  
                        // send in 1-based number, not 0-based
                        // our id is 1-based, i.e. the row number
                        this.updateRowQueueStats(idnum);

                    }
                    //console.groupEnd();

                },
                onWrite: function(data) {
                    // write it to the log
                    //console.group("gcode widget - onWrite");
                    console.log("onWrite. data:", data);

                    var item = data;
                    var msgEl;
                    // check that id string is not null/empty and starts with
                    // a g, cuz we make all our id's start with g
                    // otherwise this callback is not for us
                    if (item.Id.length > 0 && item.Id.match(/^g/)) {

                        console.log("onWrite. seems we have an id for this item with a g. item:", item);
                        // get id
                        var id = item.Id;
                        // get numeric value cuz our ids are "g999"
                        var idnum = parseInt(id.replace(/g/, ""));
                        //console.log("derived idnum:", idnum, "id:", id);

                        // update meta data
                        if (this.metaLines[idnum - 1] == null) {
                            //console.log("no meta data for this element yet. creating it.");
                            this.metaLines[idnum - 1] = $.extend({}, this.metaObj);
                        }

                        // set that it is queued
                        this.metaLines[idnum - 1].isWritten = true;

                        // update the dom if this row is showing  
                        // send in 1-based number, not 0-based
                        // our id is 1-based, i.e. the row number
                        this.updateRowQueueStats(idnum);

                    }
                    //console.groupEnd();
                },
                displayLine: function(index, chilipepprPauseFun) {
                    // Only do this if not done already
                    if (this.metaLines[index].isDisplayed)
                        return;

                    this.metaLines[index].isDisplayed = true;

                    // see if comment
                    var linegcode = this.fileLines[index];
                    if (linegcode.match(/(\(.*\)|;.*$)/)) {
                        // it's comment
                        //var re = /\((.*)\)/;
                        //re.exec(linegcode);
                        var comment = RegExp.$1;
                        console.log("Found comment:", comment);
                        chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Comment", comment, 3000, true);
                    }

                    // see if M6 tool change command & user wants to pause on M6
                    if (linegcode.match(/M0?6/i) && this.options.pauseOnM6) {
                        this.showToolChangeModal(linegcode,
                            String(index) + " " + JSON.stringify(this.metaLines[index]));
                    }

                    // see if chilipeppr_pause command
                    if (linegcode.match(/chilipeppr_pause/i)) {
                        chilipepprPauseFun({
                            line: index + 1,
                            gcode: linegcode
                        });
                    }
                },
                onComplete: function(data) {
                    // write it to the log
                    //console.group("gcode widget - onComplete");
                    console.log("onComplete. data:", data);

                    var item = data;
                    var msgEl;
                    // check that id string is not null/empty and starts with
                    // a g, cuz we make all our id's start with g
                    // otherwise this callback is not for us
                    if (item.Id.length > 0 && item.Id.match(/^g/)) {

                        console.log("onComplete. seems we have an id for this item with a g. item:", item);
                        // get id
                        var id = item.Id;
                        // get numeric value cuz our ids are "g999"
                        var idnum = parseInt(id.replace(/g/, ""));
                        //console.log("derived idnum:", idnum, "id:", id);

                        // update meta data
                        if (this.metaLines[idnum - 1] == null) {
                            //console.log("no meta data for this element yet. creating it.");
                            this.metaLines[idnum - 1] = $.extend({}, this.metaObj);
                        }

                        // set that it is queued
                        this.metaLines[idnum - 1].isCompleted = true;

                        // update the dom if this row is showing  
                        // send in 1-based number, not 0-based
                        // our id is 1-based, i.e. the row number
                        this.updateRowQueueStats(idnum);

                        // let user follow along on completes

                        if (!this.isInExecuteScrollToMode &&
                            !this.metaLines[idnum - 1].isDisplayed) {

                            this.gotoLine(idnum, true);

                            this.displayLine(idnum - 1, this.onChiliPepprPauseOnComplete);

                            // see if we're done sending
                            if (idnum >= this.fileLines.length) {
                                console.log("at end of onCompleting gcode.");
                                chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Sender", "Done sending all Gcode into the CNC controller. This may not mean it's done executing yet as the controller typically has a planner buffer.", 6000);

                                // also trigger stop button
                                //this.onStop({viaOnComplete: true});

                                if (!this.isJobDonePubSubSent) {
                                    chilipeppr.publish("/com-chilipeppr-widget-gcode/done", "Duration " + this.statEls.timeDur.text() + " Lines " + this.fileLines.length);
                                    this.isJobDonePubSubSent = true;
                                }
                            }

                            // update estimated time remaining
                            this.calcEstimatedRemain(idnum - 1);
                        }

                    }

                    // update duration of job
                    var dur = new Date().getTime() - this.timeStart;
                    dur = this.toHHMMSS(parseInt(dur / 1000));
                    if (this.statEls) this.statEls.timeDur.text(dur);


                    //console.groupEnd();
                },
                onError: function(data) {
                    // write it to the log
                    console.log("onError. data:", data);

                    var item = data;
                    var msgEl;
                    // check that id string is not null/empty and starts with
                    // a g, cuz we make all our id's start with g
                    // otherwise this callback is not for us
                    if (item.Id.length > 0 && item.Id.match(/^g/)) {

                        console.log("onError. seems we have an id for this item with a g. item:", item);
                        // get id
                        var id = item.Id;
                        // get numeric value cuz our ids are "g999"
                        var idnum = parseInt(id.replace(/g/, ""));
                        //console.log("derived idnum:", idnum, "id:", id);

                        // update meta data
                        if (this.metaLines[idnum - 1] == null) {
                            //console.log("no meta data for this element yet. creating it.");
                            this.metaLines[idnum - 1] = $.extend({}, this.metaObj);
                        }

                        // set that it is error
                        this.metaLines[idnum - 1].isError = true;

                        // update the dom if this row is showing  
                        // send in 1-based number, not 0-based
                        // our id is 1-based, i.e. the row number
                        this.updateRowQueueStats(idnum);

                        // let user follow along on completes
                        //if (!this.isInExecuteScrollToMode) {
                        this.gotoLine(idnum, true);

                        // see if comment
                        var linegcode = this.fileLines[idnum - 1];
                        if (linegcode.match(/(\(.*\)|;.*$)/)) {
                            // it's comment
                            //var re = /\((.*)\)/;
                            //re.exec(linegcode);
                            var comment = RegExp.$1;
                            console.log("Found comment:", comment);
                            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Comment", comment, 3000, true);
                        }

                        // see if M6 tool change command & user wants to pause on M6
                        //(just because controller errored out, user is still expecting a pause on M6 from the software)
                        if (linegcode.match(/M0?6/i) && this.options.pauseOnM6) {
                            this.showToolChangeModal(linegcode, "onerror");
                        }

                        // see if we're done sending
                        if (idnum >= this.fileLines.length) {
                            console.log("at end of onCompleting gcode.");
                            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Sender", "Done sending all Gcode into the CNC controller. This may not mean it's done executing yet as the controller typically has a planner buffer.", 6000);

                            // also trigger stop button
                            this.onStop({
                                viaOnComplete: true
                            });

                            chilipeppr.publish("/com-chilipeppr-widget-gcode/done", "Duration " + this.statEls.timeDur.text() + " Lines " + this.fileLines.length);
                        }

                        // update estimated time remaining
                        this.calcEstimatedRemain(idnum - 1);
                        //}

                    }

                    // update duration of job
                    var dur = new Date().getTime() - this.timeStart;
                    dur = this.toHHMMSS(parseInt(dur / 1000));
                    if (this.statEls) this.statEls.timeDur.text(dur);

                    //console.groupEnd();
                },

                // this prop is set first time we see an onExecuted
                // because that means the user should only see scrolling
                // based on onExecuted, NOT based on onComplete. so this
                // var should be referenced in onComplete and not have a
                // gotoLine run from that method




                isInExecuteScrollToMode: false,
                lastLineMarkedExecuted: null,

                onExecute: function(data) {
                    // write it to the log




                    // //alert("ENTRO");
                    //console.group("gcode widget - onExecute");
                    console.log("onExecute data:", data);
                    console.log("onExecute lastLineMarkedExecuted:", this.lastLineMarkedExecuted,
                        " isInExecuteScrollToMode:", this.isInExecuteScrollToMode);

                    // we can get onExecute methods called on first load
                    // because they come in from sr commands, so if we're not
                    // initialized from the onPlay method, exit
                    if (this.lastLineMarkedExecuted == null) {
                        //console.groupEnd();
                        return;
                    }

                    // if we get something lower than our start, which is 1
                    // just ignore it. Need to do this before setting
                    // isInExecuteScrollToMode below or we'll think that we
                    // need to handle events we don't
                    var item = data;
                    if ('line' in item && item.line < 1) return;

                    // make sure we're in onExecuted mode
                    this.isInExecuteScrollToMode = true;

                    var msgEl;
                    // check that id string is not null/empty and starts with
                    // a g, cuz we make all our id's start with g
                    // otherwise this callback is not for us
                    if ('line' in item && item.line >= 0) {

                        contadordelinea = contadordelinea + 1;




                        console.log("onExecute. seems we have an id for this item with a g. item:", item);
                        // get id
                        var idnum = item.line;


                        // Igualando en caso de que sea segunda vez.
                        if (contadordelinea > idnum) {


                            contadordelinea = idnum;

                        }

                        // Si el contador va bien

                        if (idnum == contadordelinea) {


                            //MESA A SUBIR

                            //TERMINAN POSICIONADORES

                            var gcodeline = this.gcode.lines[idnum - 1];
                            var gcodelineplus = this.gcode.lines[idnum];




                            if (gcodeline.match(/\bM6\b/i) || gcodeline.match(/\bM3\b/i) || gcodeline.match(/\bM67\b/i) ||
                                gcodeline.match(/\bM58\b/i) || gcodeline.match(/\bM57\b/i) || gcodeline.match(/\bM68\b/i) ||
                                gcodeline.match(/\bM5\b/i) || gcodeline.match(/\bM199\b/i) || gcodeline.match(/\bM116\b/i) ||
                                gcodeline.match(/\bM115\b/i) || gcodeline.match(/\bM114\b/i) || gcodeline.match(/\bM113\b/i) || gcodeline.match(/\bM112\b/i) ||
                                gcodeline.match(/\bM111\b/i) || gcodeline.match(/\bM110\b/i) || gcodeline.match(/\bM109\b/i) || gcodeline.match(/\bM108\b/i) ||
                                gcodeline.match(/\bM107\b/i) || gcodeline.match(/\bM106\b/i) || gcodeline.match(/\bM105\b/i) || gcodeline.match(/\bM104\b/i) ||
                                gcodeline.match(/\bM103\b/i) || gcodeline.match(/\bM102\b/i) || gcodeline.match(/\bM101\b/i) || gcodeline.match(/\bM100\b/i) ||
                                gcodeline.match(/\bM22\b/i) || gcodeline.match(/\bM12\b/i) || gcodeline.match(/\bM9\b/i) || gcodeline.match(/\bM8\b/i) ||
                                gcodeline.match(/\bM701\b/i) || gcodeline.match(/\bM20\b/i) || gcodeline.match(/\bM7\b/i) || gcodeline.match(/\bM10\b/i) || gcodeline.match(/\bM80\b/i) || gcodeline.match(/\bM81\b/i) || gcodeline.match(/\bUTO\b/i) || gcodeline.match(/\bUAO\b/i) || gcodeline.match(/\bPAUSA\b/i)) {

                                var cmd = "!";
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);


                                ocupado = 1;

                                ////alert("Es una especial");

                                /*************************************INICIA SWITCH ***********************/


                                switch (gcodeline) {


                                    case (gcodeline.match(/\bM7\b/i) || {}).input:
                                        var cmd = "!";
                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);
                                        this.onm7();


                                        break;


                                    case (gcodeline.match(/\bM80\b/i) || {}).input:
                                        this.encenderblower();
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }
                                        break;


                                    case (gcodeline.match(/\bM81\b/i) || {}).input:
                                        this.apagarblower();
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }
                                        break;

                                    case (gcodeline.match(/\bPAUSA\b/i) || {}).input:
                                        var cmd = "!";
                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);

                                        document.getElementById("salirpausa").disabled = false;
                                        document.getElementById("salirpausa").style = "background-color: greenyellow";
                                        document.getElementById("salirpausa2").disabled = false;
                                        document.getElementById("salirpausa2").style = "background-color: greenyellow";


                                        break;



                                        /********** INICIO CAMBIO HERRAMIENTA ******/
                                    case (gcodeline.match(/\bM6\b/i) || {}).input:

                                        ultimom6 = (idnum - 1);

                                        this.onM20BtnClick();
                                        var cmd = "!";
                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                        this.activarm5();
                                        var esto = this;


                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {

                                            var res = response.split("Pin A5 reads analog ");

                                            response = parseInt(res[1]);

                                            if (response < 900) {
                                                setTimeout(() => {

                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }
                                                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin A5 reads analog ");

                                                        response = parseInt(res[1]);

                                                        if (response > 900) {
                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }
                                                            var theurl = 'http://192.168.0.80/arduino/digital/29';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {

                                                                var res = response.split("Pin D29 set to ");

                                                                response = parseInt(res[1]);



                                                                if (response == 1) {


                                                                    // COMIENZA CH

                                                                    var HttpClient = function() {

                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }
                                                                    var theurl = 'http://192.168.0.98/geth';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {

                                                                        var obj = JSON.parse(response);
                                                                        window.objetodah = obj;
                                                                        var modoh = parseInt(obj[0]['modoh']);




                                                                        var linea = gcodeline.replace('M6', "").trim();
                                                                        linea = linea.replace('M7', "").trim();
                                                                        linea = linea.replace('T', "").trim();

                                                                        var linean = "N" + (idnum);
                                                                        linea = linea.replace(linean, "").trim();
                                                                        window.toolausar = parseInt(linea);



                                                                        if (window.toolausar == 0) {
                                                                            for (var i = 0; i < 17; i++) {

                                                                                if (parseInt(obj[i]['enhusillo'])) {
                                                                                    // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.

                                                                                    var valortool = i + 1;

                                                                                }
                                                                            }

                                                                            cmd = "q" + valortool + ";1";
                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                            if (modoh == 1) {
                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                });
                                                                            } else {
                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {});

                                                                            }



                                                                        } else {

                                                                            // SI ES MODO H:
                                                                            if (modoh == 1) {

                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/geth';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var obj = JSON.parse(response);
                                                                                    window.objetodah = obj;
                                                                                });

                                                                                // Loop para encontrar que pocket tiene la herramienta pedida.
                                                                                for (var i = 0; i < 17; i++) {

                                                                                    if (window.objetodah[i]['herramienta'] == window.toolausar) {
                                                                                        // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                        var indexher = i;
                                                                                        var valortool = i + 1;
                                                                                        var longitud = parseFloat(window.objetodah[i]['longitud']);
                                                                                        var enhusillo = parseInt(window.objetodah[i]['enhusillo']);
                                                                                    }
                                                                                }

                                                                                //COMPENSACION
                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var obj = JSON.parse(response);

                                                                                    var valorx = obj['x'];
                                                                                    var valory = obj['y'];
                                                                                    var valorz = parseFloat(obj['z']);
                                                                                    var valora = obj['a'];

                                                                                    valorz = valorz + longitud;
                                                                                    valorz = valorz.toString();

                                                                                    var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                });





                                                                                //FIN COMPENSACION


                                                                                if (!parseInt(window.objetodah[indexher]['enhusillo'])) {


                                                                                    // CAMBIO BRAZO
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/sigherramienta/' + window.toolausar;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {});

                                                                                    cmd = "q" + valortool + ";1";
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);




                                                                                    //Cambio brazo en la tabla.
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                    });
                                                                                } else {

                                                                                    esto.onM10BtnClick();


                                                                                    esto.activarm3();
                                                                                    //ENCENDERHUSILLO
                                                                                    setTimeout(() => {
                                                                                        var HttpClient = function() {
                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            response = response.split("Pin A5 reads analog ");


                                                                                            response = parseInt(response[1]);

                                                                                            if (response < 900) {
                                                                                                var cmd = "~";
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                            } else {


                                                                                                setTimeout(function() {

                                                                                                    var HttpClient = function() {
                                                                                                        this.get = function(aUrl, aCallback) {
                                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                                            }
                                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                                            anHttpRequest.send(null);
                                                                                                        }
                                                                                                    }
                                                                                                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                    var client = new HttpClient();
                                                                                                    client.get(theurl, function(response) {

                                                                                                        response = response.split("Pin A5 reads analog ");


                                                                                                        response = parseInt(response[1]);

                                                                                                        if (response < 900) {
                                                                                                            var cmd = "~";
                                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                        } else {

                                                                                                            document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"


                                                                                                            var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                            erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                        }


                                                                                                    });

                                                                                                }, 4000)

                                                                                            }

                                                                                        });


                                                                                    }, 8000);



                                                                                    //EN HUSILLO, SOLO BAJAR Y ARRANCAR.



                                                                                }

                                                                            }

                                                                            // SI ES MODO LINEAL:  ***********************************************************************************************
                                                                            else {
                                                                                var indexher = window.toolausar - 1;
                                                                                var valortool = window.toolausar;

                                                                                var longitud = parseFloat(window.objetodah[(window.toolausar - 1)]['longitud']);


                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/sigherramienta/' + window.toolausar;
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {});

                                                                                var enhusillo = 100;



                                                                                //COMPENSACION MODO LINEAL
                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var obj = JSON.parse(response);

                                                                                    var valorx = obj['x'];
                                                                                    var valory = obj['y'];
                                                                                    var valorz = parseFloat(obj['z']);
                                                                                    var valora = obj['a'];

                                                                                    valorz = valorz + longitud;
                                                                                    valorz = valorz.toString();

                                                                                    var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                });





                                                                                //FIN COMPENSACION

                                                                                var valortoolenhusillo = valortool;

                                                                                //BUSCAR SI HAY HERRAMIENTA EN EL HUSILLO
                                                                                for (var i = 0; i < 17; i++) {

                                                                                    if (parseInt(obj[i]['enhusillo']) == 1) {
                                                                                        enhusillo = 1;
                                                                                        var indexherenhusillo = i;
                                                                                        var valortoolenhusillo = i + 1;
                                                                                    }

                                                                                }




                                                                                if (valortoolenhusillo != valortool) {
                                                                                    //SI HAY: REGRESARLA A POSICIÓN ORIGINAL  Y luego cambiar nueva
                                                                                    if (enhusillo == 1) {


                                                                                        // cambio posicion original.


                                                                                        // ROTAR EN TABLA
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/rotarcar/' + valortoolenhusillo;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            // CAMBIAR EN TABLA
                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {});

                                                                                        });

                                                                                        //Mandar a hacer el cambio real

                                                                                        cmd = "Q" + valortoolenhusillo + ";1";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);


                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/sigherramienta/' + window.toolausar;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                        /* ESTO TENDRIA QUE IR EN EL FINAL De la cadena de X.
                                        
                                                    setTimeout( function(){
                                                        
                                                        
                                                            var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/rotarcar/'+toolausar;
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                    var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                });
                                                                });
                                                        
                                                                // CAMBIAR EN TABLA
                                                        
                                        
                                                        //Cambiar real.
                                                            cmd = "x"+toolausar+";"+obj[(toolausar-1)]['longitud'];
                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd );
                                        
                                                        },7000);
                                                        */

                                                                                    }
                                                                                }
                                                                                // Si la herramienta en el husillo es la herramienta que se pidió.
                                                                                else {


                                                                                    if (enhusillo != 1) {

                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/rotarcar/' + window.toolausar;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            // CAMBIAR EN TABLA
                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {});

                                                                                        });

                                                                                        cmd = "q" + window.toolausar + ";1";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);


                                                                                    } else {

                                                                                        esto.onM10BtnClick();
                                                                                        esto.activarm3();
                                                                                        //ENCENDERHUSILLO
                                                                                        setTimeout(() => {
                                                                                            var HttpClient = function() {
                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {


                                                                                                response = response.split("Pin A5 reads analog ");


                                                                                                response = parseInt(response);

                                                                                                if (response < 900) {
                                                                                                    var cmd = "~";
                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                } else {


                                                                                                    setTimeout(function() {

                                                                                                        var HttpClient = function() {
                                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                                }
                                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                                anHttpRequest.send(null);
                                                                                                            }
                                                                                                        }
                                                                                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                        var client = new HttpClient();
                                                                                                        client.get(theurl, function(response) {


                                                                                                            response = response.split("Pin A5 reads analog ");


                                                                                                            response = parseInt(response[1]);

                                                                                                            if (response < 900) {
                                                                                                                var cmd = "~";
                                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                            } else {
                                                                                                                document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                                var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                                erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                                document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                            }


                                                                                                        });

                                                                                                    }, 4000)

                                                                                                }

                                                                                            });

                                                                                        }, 8000);

                                                                                        //EN HUSILLO, SOLO BAJAR Y ARRANCAR.

                                                                                    }

                                                                                }


                                                                            }
                                                                        }

                                                                    });







                                                                    //TERMINA CH






                                                                } else {

                                                                    alert("Debe bloquear las válvula del carrusel para poder moverlo.");

                                                                }



                                                            });

                                                        } else {
                                                            alert("El husillo no ha terminado de girar");
                                                        }

                                                    });


                                                }, 19000);


                                            } else {

                                                var HttpClient = function() {
                                                    this.get = function(aUrl, aCallback) {
                                                        var anHttpRequest = new XMLHttpRequest();
                                                        anHttpRequest.onreadystatechange = function() {
                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                        }
                                                        anHttpRequest.open("GET", aUrl, true);
                                                        anHttpRequest.send(null);
                                                    }
                                                }
                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                var client = new HttpClient();
                                                client.get(theurl, function(response) {

                                                    var res = response.split("Pin A5 reads analog ");

                                                    response = parseInt(res[1]);

                                                    if (response > 900) {
                                                        var HttpClient = function() {
                                                            this.get = function(aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function() {
                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                        aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                            }
                                                        }
                                                        var theurl = 'http://192.168.0.80/arduino/digital/29';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D29 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {


                                                                // COMIENZA CH
                                                                var HttpClient = function() {

                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.98/geth';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {

                                                                    var obj = JSON.parse(response);
                                                                    window.objetodah = obj;

                                                                    var modoh = parseInt(obj[0]['modoh']);



                                                                    var linea = gcodeline.replace('M6', "").trim();
                                                                    linea = linea.replace('M7', "").trim();
                                                                    linea = linea.replace('T', "").trim();

                                                                    var linean = "N" + (idnum);
                                                                    linea = linea.replace(linean, "").trim();
                                                                    window.toolausar = parseInt(linea);

                                                                    if (window.toolausar == 0) {
                                                                        for (var i = 0; i < 17; i++) {

                                                                            if (parseInt(obj[i]['enhusillo'])) {
                                                                                // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.

                                                                                var valortool = i + 1;

                                                                            }
                                                                        }

                                                                        cmd = "q" + valortool + ";1";
                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                        if (modoh == 1) {
                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                            });
                                                                        } else {
                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {});

                                                                        }



                                                                    } else {

                                                                        // SI ES MODO H:
                                                                        if (modoh == 1) {

                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/geth';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var obj = JSON.parse(response);
                                                                                window.objetodah = obj;
                                                                            });
                                                                            // Loop para encontrar que pocket tiene la herramienta pedida.
                                                                            for (var i = 0; i < 17; i++) {

                                                                                if (window.objetodah[i]['herramienta'] == window.toolausar) {
                                                                                    // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                    var indexher = i;
                                                                                    var valortool = i + 1;
                                                                                    var longitud = window.objetodah[i]['longitud'];
                                                                                }
                                                                            }


                                                                            //COMPENSACION
                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var obj = JSON.parse(response);

                                                                                var valorx = obj['x'];
                                                                                var valory = obj['y'];
                                                                                var valorz = parseFloat(obj['z']);
                                                                                var valora = obj['a'];

                                                                                valorz = valorz + longitud;
                                                                                valorz = valorz.toString();

                                                                                var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                            });





                                                                            //FIN COMPENSACION
                                                                            if (!parseInt(obj[indexher]['enhusillo'])) {


                                                                                // CAMBIO BRAZO

                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/sigherramienta/' + valortool;
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {});


                                                                                cmd = "q" + valortool + ";1";
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);



                                                                                //Cambio brazo en la tabla.
                                                                                var HttpClient = function() {

                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }
                                                                                var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                });

                                                                                // }
                                                                                //ROTACIÓN a nueva posicion.


                                                                                //codigo de busqueda de siguiente herramienta -- SOLO EN GCODE.

                                                                                /*       var largodecodigo = esto.gcode.lines.length;
                                                                                        var valorsiguientetool = 1000;
                                                                                        
                                                                                        for (var n=(idnum); n<largodecodigo; n++){
                                                                                        
                                                                                            var gcodetemporal = esto.gcode.lines[n];
                                                                                            if(gcodetemporal.match(/\bM6\b/i)){
                                                                                                var linean = "N"+(n+1);
                                                                                                var lineatemporal = gcodelinetemporal.replace('M6', "").trim();
                                                                                                lineatemporal = lineatemporal.replace('T', "").trim();
                                                                                                lineatemporal = lineatemporal.replace('M7', "").trim();
                                                                                                lineatemporal = lineatemporal.replace(linean, "").trim();
                                                                                        
                                                                                                var valorstool = parseInt(lineatemporal);
                                                                                                                    n=100000;
                                                                                        
                                                                                                                }
                                                                                                            }
                                                                                        
                                                                                                            for( var i = 0; i < 17; i++){
                                                                                        if (parseInt(obj[i]['herramienta']) == valorstool){
                                                                                            // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                            var indexher = i;
                                                                                        valorsiguientetool = i+1;
                                                                                        }}
                                                                                        
                                                                                        //si existe alguna siguiente tool hacer rotacion. si no, no hacer nada.
                                                                                        
                                                                                        
                                                                                        setTimeout(function(){
                                                                                            if(valorsiguientetool != 1000){
                                                                                        
                                                                                            cmd = "i"+valorsiguientetool;
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd );
                                                                                        //Cambio brazo en la tabla.
                                                                                                var HttpClient = function () {
                                                                                                
                                                                                                this.get = function (aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function () {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                        }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/rotarcar/'+valorsiguientetool;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function (response) {
                                                                                        
                                                                                        });
                                                                                        
                                                                                        }
                                                                                        var cmd  = "~";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.serialPort + " " + cmd);
                                                                                        },15000);
                                                                                        */
                                                                            } else {
                                                                                esto.onM10BtnClick();
                                                                                esto.activarm3();
                                                                                //ENCENDERHUSILLO
                                                                                setTimeout(() => {
                                                                                    var HttpClient = function() {
                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        response = response.split("Pin A5 reads analog ");


                                                                                        response = parseInt(response);

                                                                                        if (response < 900) {
                                                                                            var cmd = "~";
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                        } else {


                                                                                            setTimeout(function() {

                                                                                                var HttpClient = function() {
                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {

                                                                                                    response = response.split("Pin A5 reads analog ");
                                                                                                    response = parseInt(response);
                                                                                                    if (response < 900) {
                                                                                                        var cmd = "~";
                                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                    } else {
                                                                                                        document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                        erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                        document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                    }


                                                                                                });

                                                                                            }, 4000)

                                                                                        }

                                                                                    });
                                                                                }, 8000);

                                                                                //EN HUSILLO, SOLO BAJAR Y ARRANCAR.

                                                                            }


                                                                        }

                                                                        // SI ES MODO LINEAL:  ***********************************************************************************************
                                                                        else {;
                                                                            var longitud = parseFloat(window.objetodah[(window.toolausar - 1)]['longitud']);

                                                                            var indexher = window.toolausar - 1;
                                                                            var valortool = window.toolausar;



                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/sigherramienta/' + window.toolausar;
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {});

                                                                            var enhusillo = 100;

                                                                            //COMPENSACION MODO LINEAL
                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var obj = JSON.parse(response);

                                                                                var valorx = obj['x'];
                                                                                var valory = obj['y'];
                                                                                var valorz = parseFloat(obj['z']);
                                                                                var valora = obj['a'];

                                                                                valorz = valorz + longitud;
                                                                                valorz = valorz.toString();

                                                                                var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                            });





                                                                            //FIN COMPENSACION

                                                                            var valortoolenhusillo = valortool;

                                                                            //BUSCAR SI HAY HERRAMIENTA EN EL HUSILLO
                                                                            for (var i = 0; i < 17; i++) {

                                                                                if (parseInt(obj[i]['enhusillo']) == 1) {
                                                                                    enhusillo = 1;
                                                                                    var indexherenhusillo = i;
                                                                                    var valortoolenhusillo = i + 1;
                                                                                }

                                                                            }

                                                                            if (valortoolenhusillo != valortool) {
                                                                                //SI HAY: REGRESARLA A POSICIÓN ORIGINAL  Y luego cambiar nueva
                                                                                if (enhusillo == 1) {

                                                                                    // cambio posicion original.


                                                                                    // ROTAR EN TABLA
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/rotarcar/' + valortoolenhusillo;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        // CAMBIAR EN TABLA
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                    });

                                                                                    //Mandar a hacer el cambio real

                                                                                    cmd = "Q" + valortoolenhusillo + ";1";
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);




                                                                                    /* ESTO TENDRIA QUE IR EN EL FINAL De la cadena de X.
                                        
                                                    setTimeout( function(){
                                                        
                                                        
                                                            var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/rotarcar/'+toolausar;
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                    var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                });
                                                                });
                                                        
                                                                // CAMBIAR EN TABLA
                                                        
                                        
                                                        //Cambiar real.
                                                            cmd = "x"+toolausar+";"+obj[(toolausar-1)]['longitud'];
                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd );
                                        
                                                        },7000);
                                                        */

                                                                                }
                                                                            }
                                                                            // Si la herramienta en el husillo es la herramienta que se pidió.
                                                                            else {


                                                                                if (enhusillo != 1) {

                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/rotarcar/' + window.toolausar;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        // CAMBIAR EN TABLA
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                    });

                                                                                    cmd = "q" + window.toolausar + ";1";
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                                } else {

                                                                                    esto.onM10BtnClick();
                                                                                    esto.activarm3();
                                                                                    //ENCENDERHUSILLO
                                                                                    setTimeout(() => {
                                                                                        var HttpClient = function() {
                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {


                                                                                            response = response.split("Pin A5 reads analog ");


                                                                                            response = parseInt(response);

                                                                                            if (response < 900) {
                                                                                                var cmd = "~";
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                            } else {


                                                                                                setTimeout(function() {

                                                                                                    var HttpClient = function() {
                                                                                                        this.get = function(aUrl, aCallback) {
                                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                                            }
                                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                                            anHttpRequest.send(null);
                                                                                                        }
                                                                                                    }
                                                                                                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                    var client = new HttpClient();
                                                                                                    client.get(theurl, function(response) {


                                                                                                        response = response.split("Pin A5 reads analog ");


                                                                                                        response = parseInt(response[1]);

                                                                                                        if (response < 900) {
                                                                                                            var cmd = "~";
                                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                        } else {
                                                                                                            document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                            var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                            erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                        }


                                                                                                    });

                                                                                                }, 4000)

                                                                                            }

                                                                                        });

                                                                                    }, 8000);

                                                                                    //EN HUSILLO, SOLO BAJAR Y ARRANCAR.
                                                                                }
                                                                            }




                                                                        }
                                                                    }

                                                                });







                                                                //TERMINA CH






                                                            } else {

                                                                alert("Debe bloquear las válvula del carrusel para poder moverlo.");

                                                            }



                                                        });

                                                    } else {
                                                        alert("El husillo no ha terminado de girar");
                                                    }

                                                });





                                            }
                                        })


                                        break;



                                        /*********FIN CAMBIO DE HERRAMIENTA******/

                                        /*************INICIO UTO***********************/
                                    case (gcodeline.match(/\bUTO\b/i) || {}).input:

                                        var numeroorigen = gcodeline.match(/UTO (.*?) /i)[1];
                                        var utox = gcodeline.match(/X(.*?) /i)[1];
                                        var utoy = gcodeline.match(/Y(.*?) /i)[1];
                                        var utoa = gcodeline.match(/A(.*?) /i)[1];
                                        var utoz = gcodeline.match(/Z(.*?)*/i)[0];
                                        utoz = utoz.substring(1);

                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.98/api/uto/' + numeroorigen + "/" + utox + "/" + utoy + "/" + utoa + "/" + utoz;
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {




                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }
                                            var theurl = 'http://192.168.0.98/api/obtenerorigenesusar';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {


                                                var obj = JSON.parse(response);
                                                switch (numeroorigen) {


                                                    case "1":
                                                        var xcambiar = obj['x1'];
                                                        var ycambiar = obj['y1'];
                                                        var acambiar = obj['a1'];
                                                        var zcambiar = obj['z1'];
                                                        break;
                                                    case "2":
                                                        var xcambiar = obj['x2'];
                                                        var ycambiar = obj['y2'];
                                                        var acambiar = obj['a2'];
                                                        var zcambiar = obj['z2'];
                                                        break;
                                                    case "3":
                                                        var xcambiar = obj['x3'];
                                                        var ycambiar = obj['y3'];
                                                        var acambiar = obj['a3'];
                                                        var zcambiar = obj['z3'];
                                                        break;
                                                    case "4":
                                                        var xcambiar = obj['x4'];
                                                        var ycambiar = obj['y4'];
                                                        var acambiar = obj['a4'];
                                                        var zcambiar = obj['z4'];
                                                        break;
                                                    case "5":
                                                        var xcambiar = obj['x5'];
                                                        var ycambiar = obj['y5'];
                                                        var acambiar = obj['a5'];
                                                        var zcambiar = obj['z5'];
                                                        break;
                                                    case "6":
                                                        var xcambiar = obj['x6'];
                                                        var ycambiar = obj['y6'];
                                                        var acambiar = obj['a6'];
                                                        var zcambiar = obj['z6'];
                                                        break;
                                                    case "7":
                                                        var xcambiar = obj['x7'];
                                                        var ycambiar = obj['y7'];
                                                        var acambiar = obj['a7'];
                                                        var zcambiar = obj['z7'];
                                                        break;
                                                    case "8":
                                                        var xcambiar = obj['x8'];
                                                        var ycambiar = obj['y8'];
                                                        var acambiar = obj['a8'];
                                                        var zcambiar = obj['z8'];
                                                        break;
                                                    case "9":
                                                        var xcambiar = obj['x9'];
                                                        var ycambiar = obj['y9'];
                                                        var acambiar = obj['a9'];
                                                        var zcambiar = obj['z9'];
                                                        break;
                                                    case "10":
                                                        var xcambiar = obj['x10'];
                                                        var ycambiar = obj['y10'];
                                                        var acambiar = obj['a10'];
                                                        var zcambiar = obj['z10'];
                                                        break;
                                                    case "11":
                                                        var xcambiar = obj['x11'];
                                                        var ycambiar = obj['y11'];
                                                        var acambiar = obj['a11'];
                                                        var zcambiar = obj['z11'];
                                                        break;
                                                    case "12":
                                                        var xcambiar = obj['x12'];
                                                        var ycambiar = obj['y12'];
                                                        var acambiar = obj['a12'];
                                                        var zcambiar = obj['z12'];
                                                        break;
                                                    case "13":
                                                        var xcambiar = obj['x13'];
                                                        var ycambiar = obj['y13'];
                                                        var acambiar = obj['a13'];
                                                        var zcambiar = obj['z13'];
                                                        break;
                                                    case "14":
                                                        var xcambiar = obj['x14'];
                                                        var ycambiar = obj['y14'];
                                                        var acambiar = obj['a14'];
                                                        var zcambiar = obj['z14'];
                                                        break;
                                                    case "15":
                                                        var xcambiar = obj['x15'];
                                                        var ycambiar = obj['y15'];
                                                        var acambiar = obj['a15'];
                                                        var zcambiar = obj['z15'];
                                                        break;
                                                    case "16":
                                                        var xcambiar = obj['x16'];
                                                        var ycambiar = obj['y16'];
                                                        var acambiar = obj['a16'];
                                                        var zcambiar = obj['z16'];
                                                        break;

                                                }



                                                var cmd = "G10 L2 P1 X" + xcambiar + " Y" + ycambiar + " A" + acambiar + " Z" + zcambiar;
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                //alert(cmd);
                                                setTimeout(function() {
                                                    var cmd = "G54";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                    if (!sigespecial && !errora && !errory) {
                                                        setTimeout(function() {
                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                            var cmd = "~";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                        }, 700);
                                                    }
                                                }, 500);




                                            });

                                        });
                                        break;
                                        /**********************************************FIN UTO***********************************/




                                        /**********************************************INICIO UAO***********************************/


                                    case (gcodeline.match(/\bUAO\b/i) || {}).input:

                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.98/api/resetuto';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {});
                                        var coord = gcodeline.match(/UAO(.*?)*/i)[0];
                                        coord = coord.substring(4);

                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.98/api/obtenerorigenesusar';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {


                                            var obj = JSON.parse(response);
                                            switch (coord) {


                                                case "1":
                                                    var xcambiar = obj['x1'];
                                                    var ycambiar = obj['y1'];
                                                    var acambiar = obj['a1'];
                                                    var zcambiar = obj['z1'];
                                                    break;
                                                case "2":
                                                    var xcambiar = obj['x2'];
                                                    var ycambiar = obj['y2'];
                                                    var acambiar = obj['a2'];
                                                    var zcambiar = obj['z2'];
                                                    break;
                                                case "3":
                                                    var xcambiar = obj['x3'];
                                                    var ycambiar = obj['y3'];
                                                    var acambiar = obj['a3'];
                                                    var zcambiar = obj['z3'];
                                                    break;
                                                case "4":
                                                    var xcambiar = obj['x4'];
                                                    var ycambiar = obj['y4'];
                                                    var acambiar = obj['a4'];
                                                    var zcambiar = obj['z4'];
                                                    break;
                                                case "5":
                                                    var xcambiar = obj['x5'];
                                                    var ycambiar = obj['y5'];
                                                    var acambiar = obj['a5'];
                                                    var zcambiar = obj['z5'];
                                                    break;
                                                case "6":
                                                    var xcambiar = obj['x6'];
                                                    var ycambiar = obj['y6'];
                                                    var acambiar = obj['a6'];
                                                    var zcambiar = obj['z6'];
                                                    break;
                                                case "7":
                                                    var xcambiar = obj['x7'];
                                                    var ycambiar = obj['y7'];
                                                    var acambiar = obj['a7'];
                                                    var zcambiar = obj['z7'];
                                                    break;
                                                case "8":
                                                    var xcambiar = obj['x8'];
                                                    var ycambiar = obj['y8'];
                                                    var acambiar = obj['a8'];
                                                    var zcambiar = obj['z8'];
                                                    break;
                                                case "9":
                                                    var xcambiar = obj['x9'];
                                                    var ycambiar = obj['y9'];
                                                    var acambiar = obj['a9'];
                                                    var zcambiar = obj['z9'];
                                                    break;
                                                case "10":
                                                    var xcambiar = obj['x10'];
                                                    var ycambiar = obj['y10'];
                                                    var acambiar = obj['a10'];
                                                    var zcambiar = obj['z10'];
                                                    break;
                                                case "11":
                                                    var xcambiar = obj['x11'];
                                                    var ycambiar = obj['y11'];
                                                    var acambiar = obj['a11'];
                                                    var zcambiar = obj['z11'];
                                                    break;
                                                case "12":
                                                    var xcambiar = obj['x12'];
                                                    var ycambiar = obj['y12'];
                                                    var acambiar = obj['a12'];
                                                    var zcambiar = obj['z12'];
                                                    break;
                                                case "13":
                                                    var xcambiar = obj['x13'];
                                                    var ycambiar = obj['y13'];
                                                    var acambiar = obj['a13'];
                                                    var zcambiar = obj['z13'];
                                                    break;
                                                case "14":
                                                    var xcambiar = obj['x14'];
                                                    var ycambiar = obj['y14'];
                                                    var acambiar = obj['a14'];
                                                    var zcambiar = obj['z14'];
                                                    break;
                                                case "15":
                                                    var xcambiar = obj['x15'];
                                                    var ycambiar = obj['y15'];
                                                    var acambiar = obj['a15'];
                                                    var zcambiar = obj['z15'];
                                                    break;
                                                case "16":
                                                    var xcambiar = obj['x16'];
                                                    var ycambiar = obj['y16'];
                                                    var acambiar = obj['a16'];
                                                    var zcambiar = obj['z16'];
                                                    break;

                                            }


                                            var theurl = 'http://192.168.0.98/api/actualizarorigenusado/' + coord;
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {});

                                            var cmd = "G10 L2 P1 X" + xcambiar + " Y" + ycambiar + " A" + acambiar + " Z" + zcambiar;
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                            // alert(cmd);
                                            setTimeout(function() {
                                                var cmd = "G54";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                if (!sigespecial && !errora && !errory) {
                                                    setTimeout(function() {
                                                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");

                                                        var cmd = "~";
                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                    }, 700);
                                                }
                                            }, 500);


                                        });

                                        break;


                                        /********************************FIN UAO************************************************/
                                        /**************************************INICIA M3***********************/
                                    case (gcodeline.match(/\bM3\b/i) || {}).input:
                                        ocupado = 1;
                                        this.activarm3();
                                        //alert ("M3");            
                                        var tiempo = 8000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;



                                        /***********************************FIN M3 *********************************/


                                        /**************************************INICIO M5********************************/

                                    case (gcodeline.match(/\bM5\b/i) || {}).input:
                                        ocupado = 1;
                                        this.activarm5();

                                        // alert ("M5");
                                        var tiempo = 4000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }
                                        break;

                                        /*************************************FIN M5 ***********************************/

                                        /***************************************INICIO M57 SACAR PALETA DERECHA*********/
                                    case (gcodeline.match(/\bM57\b/i) || {}).input:
                                    case (gcodeline.match(/\bM57\b/i) || {}).input:
                                        document.getElementById("salirpausa").disabled = false;

                                        document.getElementById("salirpausa").style = " background-color:greenyellow"
                                        document.getElementById("salirpausa2").disabled = false;

                                        document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                        var esto = this;
                                        esto.verificarmesaizqdentro();

                                        setTimeout(function(){
                                        esto.activarM57();
                                    },1000);

                                        ocupado = 0;

                                     




                                        break;
                                        /***************************************FIN M57 SACAR PALETA DERECHA*********/





                                        /***************************************INICIO M58 Meter PALETA DERECHA*********/


                                    case (gcodeline.match(/\bM58\b/i) || {}).input:
                                        document.getElementById("salirpausa").disabled = false;

                                        document.getElementById("salirpausa").style = " background-color:greenyellow"
                                        document.getElementById("salirpausa2").disabled = false;

                                        document.getElementById("salirpausa2").style = " background-color:greenyellow"
                                        var esto = this;


                                        esto.activarM58();
                                        ocupado = 0;
                                        esto.verificarmesaderechadentro();

                                        // alert ("M58");


                                        break;
                                        /*************************************FIN M57 ***********************************/



                                        /***************************************INICIO M116*********/


                                    case (gcodeline.match(/\bM116\b/i) || {}).input:

                                        numerobroca = "16";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M116 ***********************************/

                                        /***************************************INICIO M115*********/


                                    case (gcodeline.match(/\bM115\b/i) || {}).input:

                                        numerobroca = "15";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M115 ***********************************/

                                        /***************************************INICIO M114*********/


                                    case (gcodeline.match(/\bM114\b/i) || {}).input:

                                        numerobroca = "14";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M114 ***********************************/

                                        /***************************************INICIO M113*********/


                                    case (gcodeline.match(/\bM113\b/i) || {}).input:

                                        numerobroca = "13";

                                        ocupado = 1;
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M113 ***********************************/
                                        /***************************************INICIO M112*********/


                                    case (gcodeline.match(/\bM112\b/i) || {}).input:

                                        numerobroca = "12";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M112 ***********************************/

                                        /***************************************INICIO M111*********/


                                    case (gcodeline.match(/\bM111\b/i) || {}).input:

                                        numerobroca = "11";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M111 ***********************************/

                                        /***************************************INICIO M110*********/


                                    case (gcodeline.match(/\bM110\b/i) || {}).input:

                                        numerobroca = "10";
                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M110 ***********************************/


                                        /***************************************INICIO M109*********/


                                    case (gcodeline.match(/\bM109\b/i) || {}).input:

                                        numerobroca = "9";
                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M109 ***********************************/
                                        /***************************************INICIO M108*********/


                                    case (gcodeline.match(/\bM108\b/i) || {}).input:

                                        numerobroca = "8";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M108 ***********************************/

                                        /***************************************INICIO M107*********/


                                    case (gcodeline.match(/\bM107\b/i) || {}).input:

                                        numerobroca = "7";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M107 ***********************************/
                                        /***************************************INICIO M106*********/


                                    case (gcodeline.match(/\bM106\b/i) || {}).input:

                                        numerobroca = "6";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M106 ***********************************/

                                        /***************************************INICIO M105*********/


                                    case (gcodeline.match(/\bM105\b/i) || {}).input:

                                        numerobroca = "5";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M105 ***********************************/

                                        /***************************************INICIO M104*********/


                                    case (gcodeline.match(/\bM104\b/i) || {}).input:

                                        numerobroca = "4";

                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M104 ***********************************/
                                        /***************************************INICIO M103*********/


                                    case (gcodeline.match(/\bM103\b/i) || {}).input:

                                        numerobroca = "3";
                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M103 ***********************************/
                                        /***************************************INICIO M102*********/


                                    case (gcodeline.match(/\bM102\b/i) || {}).input:

                                        numerobroca = "2";
                                        ocupado = 1;
                                        // alert ("M102");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M102 ***********************************/
                                        /***************************************INICIO M101*********/


                                    case (gcodeline.match(/\bM101\b/i) || {}).input:
                                        ocupado = 1;
                                        numerobroca = "1";

                                        // alert ("M101");
                                        if (!sigespecial && !errora && !errory) {
                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        }
                                        ocupado = 0;
                                        break;
                                        /*************************************FIN M101 ***********************************/
                                        /***************************************INICIO M100*********/


                                    case (gcodeline.match(/\bM100\b/i) || {}).input:
                                        ocupado = 1;
                                        this.subirtbrocaBtnClick();

                                        // alert ("M100");
                                        var tiempo = 2000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }
                                        break;
                                        /*************************************FIN M100 ***********************************/

                                        /***************************************INICIO M22*********/


                                    case (gcodeline.match(/\bM22\b/i) || {}).input:
                                        ocupado = 1;
                                        this.taladroarribaBtnClick();

                                        // alert ("M22");
                                        var tiempo = 2000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }
                                        break;
                                        /*************************************FIN M22 ***********************************/

                                        /***************************************INICIO M20*********/


                                    case (gcodeline.match(/\bM20\b/i) || {}).input:

                                        ocupado = 1;
                                        this.onM20BtnClick();
                                        // alert ("M20");
                                        var tiempo = 4000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M20 ***********************************/

                                        /***************************************INICIO M10*********/


                                    case (gcodeline.match(/\bM10\b/i) || {}).input:
                                        ocupado = 1;
                                        this.onM10BtnClick();
                                        // alert ("M10");
                                        var tiempo = 4000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M10 ***********************************/

                                        /***************************************INICIO M12*********/


                                    case (gcodeline.match(/\bM12\b/i) || {}).input:
                                        ocupado = 1;
                                        this.taladroabajoBtnClick();

                                        // alert ("M12");
                                        var tiempo = 2000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M12 ***********************************/


                                        /***************************************INICIO M9*********/


                                    case (gcodeline.match(/\bM9\b/i) || {}).input:
                                        ocupado = 1;
                                        this.taladrooffBtnClick();

                                        // alert ("M9");
                                        var tiempo = 4000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M9***********************************/
                                        /***************************************INICIO M8*********/


                                    case (gcodeline.match(/\bM8\b/i) || {}).input:
                                        ocupado = 1;
                                        this.taladroonBtnClick();

                                        // alert ("M8");
                                        var tiempo = 5000;
                                        temp = temp + tiempo;
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M9***********************************/

                                        /***************************************INICIO M199*********/


                                    case (gcodeline.match(/\bM199\b/i) || {}).input:

                                        ocupado = 1;



                                        this.activarM199();

                                        // alert ("M199");
                                        var tiempo = 1000;
                                        temp = temp + tiempo;
                                        //alert(sigespecial);
                                        if (!sigespecial && !errora && !errory) {
                                            setTimeout(function() {
                                                var cmd = "~";
                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                temp = 0;
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }, temp);
                                        }

                                        break;
                                        /*************************************FIN M199***********************************/



                                        /*************************** FIN SWITCH***********************/
                                }






















                                //++++++++++++++++


                            } else {
                                temp = 0;
                            }

                        } else {

                            var gcodelineantes = this.gcode.lines[idnum - 1];


                            while (idnum > contadordelinea) {
                                var numrestar = idnum - contadordelinea;
                                var gcodeline = this.gcode.lines[contadordelinea - 1];

                                var gcodelineplus = this.gcode.lines[contadordelinea];

                                /*
   
                        if (gcodelineplus.match(/\bM6\b/i) || gcodelineplus.match(/\bM3\b/i) || gcodelineplus.match(/\bM67\b/i) 
                    || gcodelineplus.match(/\bM58\b/i) || gcodelineplus.match(/\bM57\b/i) ||  gcodelineplus.match(/\bM68\b/i)
      || gcodelineplus.match(/\bM5\b/i) || gcodelineplus.match(/\bM199\b/i) || gcodelineplus.match(/\bM116\b/i) || 
        gcodelineplus.match(/\bM115\b/i) || gcodelineplus.match(/\bM114\b/i) || gcodelineplus.match(/\bM113\b/i) || gcodelineplus.match(/\bM112\b/i) ||
         gcodelineplus.match(/\bM111\b/i) || gcodelineplus.match(/\bM110\b/i) || gcodelineplus.match(/\bM109\b/i) || gcodelineplus.match(/\bM108\b/i) ||
          gcodelineplus.match(/\bM107\b/i) || gcodelineplus.match(/\bM106\b/i) || gcodelineplus.match(/\bM105\b/i) || gcodelineplus.match(/\bM104\b/i) || 
          gcodelineplus.match(/\bM103\b/i) || gcodelineplus.match(/\bM102\b/i) || gcodelineplus.match(/\bM101\b/i) || gcodelineplus.match(/\bM100\b/i) || 
          gcodelineplus.match(/\bM22\b/i) || gcodelineplus.match(/\bM12\b/i) || gcodelineplus.match(/\bM9\b/i) || gcodelineplus.match(/\bM8\b/i) || 
          gcodelineplus.match(/\bM701\b/i) || gcodelineplus.match(/\bM20\b/i) || gcodelineplus.match(/\bM10\b/i) )  {

           
           if( gcodelineplus.match(/\bM58\b/i)  ){
           

                         var HttpClient = function() {
               this.get = function(aUrl, aCallback) {
                   var anHttpRequest = new XMLHttpRequest();
                   anHttpRequest.onreadystatechange = function() {
                       if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                           aCallback(anHttpRequest.responseText);
                   }
                   anHttpRequest.open("GET", aUrl, true);
                   anHttpRequest.send(null);
               }
           }
           var theurl = 'http://192.168.0.98/api/estados';
           var client = new HttpClient();
           client.get(theurl, function(response) { 
 var obj = JSON.parse(response);
                            
                     if ( parseInt(obj['I']["259"]) != 0 && parseInt(obj['I']["258"]) != 0 && parseInt(obj['I']["261"]) != 0 && parseInt(obj['I']["262"]) != 0){
                     yentrabajo = 1;
                     aentrabajo=0;
                     sigespecial = 0;
                     errory=0;
                      }
                     else{
                        errory=1;
                         var erroresexistentes = document.getElementById("textoerrores").value;
          
          erroresexistentes = erroresexistentes.concat("\\\n\\\n");
          
          erroresexistentes = erroresexistentes.concat("Mesa Y No esta lista para ser llamada por Código G, Error de Movimiento");
          
          document.getElementById("textoerrores").value = erroresexistentes;
 document.getElementById("indicadorerrorejec").className = "led-red";
                     }
                         
                 });


           }

            

          }
          else{
              sigespecial = 0;

              if( gcodelineplus.match(/\bA\b/i) ){

if(aentrabajo != 1){  
 
    var HttpClient = function() {
this.get = function(aUrl, aCallback) {
var anHttpRequest = new XMLHttpRequest();
anHttpRequest.onreadystatechange = function() {
if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
  aCallback(anHttpRequest.responseText);
}
anHttpRequest.open("GET", aUrl, true);
anHttpRequest.send(null);
}
}
var theurl = 'http://192.168.0.98/api/estados';
var client = new HttpClient();
client.get(theurl, function(response) {
var obj = JSON.parse(response);
    
if (parseInt(obj['I']["307"]) != 0 && parseInt(obj['I']["306"]) != 0 && parseInt(obj['I']["309"]) != 0 && parseInt(obj['I']["310"]) != 0){
aentrabajo = 1;
yentrabajo=0;
errora=0;
}
else{

    errora=1;
    sigespecial = 1;
    
var erroresexistentes = document.getElementById("textoerrores").value;

erroresexistentes = erroresexistentes.concat("\\\n\\\n");

erroresexistentes = erroresexistentes.concat("Mesa A No esta lista para ser llamada por Código G, Error de Movimiento");

document.getElementById("textoerrores").value = erroresexistentes;
document.getElementById("indicadorerrorejec").className = "led-red";

}
});}


}


              
              if( gcodelineplus.match(/\bY\b/i) ){
                if(yentrabajo != 1){
                  
                       
                            var HttpClient = function() {
                  this.get = function(aUrl, aCallback) {
                      var anHttpRequest = new XMLHttpRequest();
                      anHttpRequest.onreadystatechange = function() {
                          if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                              aCallback(anHttpRequest.responseText);
                      }
                      anHttpRequest.open("GET", aUrl, true);
                      anHttpRequest.send(null);
                  }
              }
              var theurl = 'http://192.168.0.98/api/estados';
              var client = new HttpClient();
              client.get(theurl, function(response) { 
    var obj = JSON.parse(response);
                               
                        if ( parseInt(obj['I']["259"]) != 0 && parseInt(obj['I']["258"]) != 0 && parseInt(obj['I']["261"]) != 0 && parseInt(obj['I']["262"]) != 0){
                        yentrabajo = 1;
                        aentrabajo=0;
                        errory=0;
                        sigespecial = 0;
                         }
                        else{
                            errory=1;
                            sigespecial=1;
               var erroresexistentes = document.getElementById("textoerrores").value;
             
             erroresexistentes = erroresexistentes.concat("\\\n\\\n");
             
             erroresexistentes = erroresexistentes.concat("Mesa Y No esta lista para ser llamada por Código G, Error de Movimiento");
             
             document.getElementById("textoerrores").value = erroresexistentes;
    document.getElementById("indicadorerrorejec").className = "led-red";
                        }
                            
                    });}


              }



          }




TERMINA COMENT *****/
                                //MESA A SUBIR

                                ////alert(gcodeline);
                                //TERMINAN POSICIONADORES
                                if (gcodeline.match(/\bM6\b/i) || gcodeline.match(/\bM3\b/i) || gcodeline.match(/\bM67\b/i) ||
                                    gcodeline.match(/\bM58\b/i) || gcodeline.match(/\bM57\b/i) || gcodeline.match(/\bM68\b/i) ||
                                    gcodeline.match(/\bM5\b/i) || gcodeline.match(/\bM199\b/i) || gcodeline.match(/\bM116\b/i) ||
                                    gcodeline.match(/\bM115\b/i) || gcodeline.match(/\bM114\b/i) || gcodeline.match(/\bM113\b/i) || gcodeline.match(/\bM112\b/i) ||
                                    gcodeline.match(/\bM111\b/i) || gcodeline.match(/\bM110\b/i) || gcodeline.match(/\bM109\b/i) || gcodeline.match(/\bM108\b/i) ||
                                    gcodeline.match(/\bM107\b/i) || gcodeline.match(/\bM106\b/i) || gcodeline.match(/\bM105\b/i) || gcodeline.match(/\bM104\b/i) ||
                                    gcodeline.match(/\bM103\b/i) || gcodeline.match(/\bM102\b/i) || gcodeline.match(/\bM101\b/i) || gcodeline.match(/\bM100\b/i) ||
                                    gcodeline.match(/\bM22\b/i) || gcodeline.match(/\bM12\b/i) || gcodeline.match(/\bM9\b/i) || gcodeline.match(/\bM8\b/i) ||
                                    gcodeline.match(/\bM701\b/i) || gcodeline.match(/\bM7\b/i) || gcodeline.match(/\bM20\b/i) || gcodeline.match(/\bM10\b/i) || gcodeline.match(/\bM80\b/i) || gcodeline.match(/\bM81\b/i) || gcodeline.match(/\bUTO\b/i) || gcodeline.match(/\bUAO\b/i) || gcodeline.match(/\bPAUSA\b/i)) {

                                    ocupado = 1;
                                    var cmd = "!";

                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);
                                    ////alert("Es una especial");
                                    //alert(gcodeline);

                                    /*************************************INICIA SWITCH ***********************/


                                    switch (gcodeline) {


                                        case (gcodeline.match(/\bM7\b/i) || {}).input:
                                            var cmd = "!";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);
                                            this.onm7();


                                            break;


                                        case (gcodeline.match(/\bM80\b/i) || {}).input:
                                            this.encenderblower();
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }
                                            break;


                                        case (gcodeline.match(/\bM81\b/i) || {}).input:
                                            this.apagarblower();
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }
                                            break;


                                        case (gcodeline.match(/\bPAUSA\b/i) || {}).input:

                                            var cmd = "!";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);

                                            document.getElementById("salirpausa").disabled = false;
                                            document.getElementById("salirpausa").style = "background-color: greenyellow";
                                            document.getElementById("salirpausa2").disabled = false;
                                            document.getElementById("salirpausa2").style = "background-color: greenyellow";


                                            break;



                                            /********** INICIO CAMBIO HERRAMIENTA ******/
                                        case (gcodeline.match(/\bM6\b/i) || {}).input:

                                            if (contadordelinea - 1 != ultimom6) {

                                                this.onM20BtnClick();
                                                var lineacodigog = gcodeline;
                                                var toolqueseusara = 0;
                                                var contador2 = contadordelinea;
                                                var cmd = "!";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                                this.activarm5();
                                                var esto = this;


                                                var HttpClient = function() {
                                                    this.get = function(aUrl, aCallback) {
                                                        var anHttpRequest = new XMLHttpRequest();
                                                        anHttpRequest.onreadystatechange = function() {
                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                        }
                                                        anHttpRequest.open("GET", aUrl, true);
                                                        anHttpRequest.send(null);
                                                    }
                                                }
                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                var client = new HttpClient();
                                                client.get(theurl, function(response) {

                                                    var res = response.split("Pin A5 reads analog ");

                                                    response = parseInt(res[1]);

                                                    if (response < 900) {
                                                        setTimeout(() => {

                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }
                                                            var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {

                                                                var res = response.split("Pin A5 reads analog ");

                                                                response = parseInt(res[1]);

                                                                if (response > 900) {
                                                                    var HttpClient = function() {
                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }
                                                                    var theurl = 'http://192.168.0.80/arduino/digital/29';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {

                                                                        var res = response.split("Pin D29 set to ");

                                                                        response = parseInt(res[1]);

                                                                        if (response == 1) {


                                                                            // COMIENZA CH
                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }
                                                                            var theurl = 'http://192.168.0.98/geth';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var obj = JSON.parse(response);
                                                                                window.objetodah = obj;
                                                                                var modoh = parseInt(obj[0]['modoh']);



                                                                                var linea = lineacodigog.replace('M6', "").trim();


                                                                                linea = linea.replace('M7', "").trim();
                                                                                linea = linea.replace('T', "").trim();



                                                                                var linean = "N" + (contador2);
                                                                                linea = linea.replace(linean, "").trim();
                                                                                toolqueseusara = parseInt(linea);


                                                                                if (toolqueseusara == 0) {
                                                                                    for (var i = 0; i < 17; i++) {

                                                                                        if (parseInt(obj[i]['enhusillo'])) {
                                                                                            // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.

                                                                                            var valortool = i + 1;

                                                                                        }
                                                                                    }

                                                                                    cmd = "q" + valortool + ";1";
                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                                    if (modoh == 1) {
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                        });
                                                                                    } else {
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                    }



                                                                                } else {

                                                                                    // SI ES MODO H:
                                                                                    if (modoh == 1) {
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/geth';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            var obj = JSON.parse(response);
                                                                                            window.objetodah = obj;
                                                                                        });
                                                                                        // Loop para encontrar que pocket tiene la herramienta pedida.
                                                                                        for (var i = 0; i < 17; i++) {

                                                                                            if (window.objetodah[i]['herramienta'] == toolqueseusara) {
                                                                                                // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                                var indexher = i;
                                                                                                var valortool = i + 1;
                                                                                                var longitud = parseFloat(window.objetodah[i]['longitud']);
                                                                                                var enhusillo = parseInt(window.objetodah[i]['enhusillo']);
                                                                                            }
                                                                                        }

                                                                                        //COMPENSACION
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            var obj = JSON.parse(response);

                                                                                            var valorx = obj['x'];
                                                                                            var valory = obj['y'];
                                                                                            var valorz = parseFloat(obj['z']);
                                                                                            var valora = obj['a'];

                                                                                            valorz = valorz + longitud;
                                                                                            valorz = valorz.toString();

                                                                                            var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                        });





                                                                                        //FIN COMPENSACION


                                                                                        if (!parseInt(window.objetodah[indexher]['enhusillo'])) {


                                                                                            // CAMBIO BRAZO
                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/sigherramienta/' + toolqueseusara;
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {});

                                                                                            cmd = "q" + valortool + ";1";
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);




                                                                                            //Cambio brazo en la tabla.
                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {

                                                                                            });
                                                                                        } else {

                                                                                            esto.onM10BtnClick();
                                                                                            esto.activarm3();
                                                                                            //ENCENDERHUSILLO
                                                                                            setTimeout(() => {
                                                                                                var HttpClient = function() {
                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {

                                                                                                    response = response.split("Pin A5 reads analog ");
                                                                                                    response = parseInt(response);

                                                                                                    if (response < 900) {
                                                                                                        var cmd = "~";
                                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                    } else {


                                                                                                        setTimeout(function() {

                                                                                                            var HttpClient = function() {
                                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                                    }
                                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                                    anHttpRequest.send(null);
                                                                                                                }
                                                                                                            }
                                                                                                            var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                            var client = new HttpClient();
                                                                                                            client.get(theurl, function(response) {

                                                                                                                response = response.split("Pin A5 reads analog ");
                                                                                                                response = parseInt(response[1]);
                                                                                                                if (response < 900) {
                                                                                                                    var cmd = "~";
                                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                                } else {

                                                                                                                    document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"


                                                                                                                    var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                                    erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                                    document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                                }


                                                                                                            });

                                                                                                        }, 4000)

                                                                                                    }

                                                                                                });
                                                                                            }, 8000);



                                                                                            //EN HUSILLO, SOLO BAJAR Y ARRANCAR.



                                                                                        }

                                                                                    }

                                                                                    // SI ES MODO LINEAL:  ***********************************************************************************************
                                                                                    else {
                                                                                        var indexher = toolqueseusara - 1;
                                                                                        var valortool = toolqueseusara;



                                                                                        var longitud = parseFloat(window.objetodah[(toolqueseusara - 1)]['longitud']);


                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/sigherramienta/' + toolqueseusara;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                        var enhusillo = 100;



                                                                                        //COMPENSACION MODO LINEAL
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                            var obj = JSON.parse(response);

                                                                                            var valorx = obj['x'];
                                                                                            var valory = obj['y'];
                                                                                            var valorz = parseFloat(obj['z']);
                                                                                            var valora = obj['a'];

                                                                                            valorz = valorz + longitud;
                                                                                            valorz = valorz.toString();

                                                                                            var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                        });





                                                                                        //FIN COMPENSACION

                                                                                        var valortoolenhusillo = valortool;

                                                                                        //BUSCAR SI HAY HERRAMIENTA EN EL HUSILLO
                                                                                        for (var i = 0; i < 17; i++) {

                                                                                            if (parseInt(obj[i]['enhusillo']) == 1) {
                                                                                                enhusillo = 1;
                                                                                                var indexherenhusillo = i;
                                                                                                var valortoolenhusillo = i + 1;
                                                                                            }

                                                                                        }




                                                                                        if (valortoolenhusillo != valortool) {
                                                                                            //SI HAY: REGRESARLA A POSICIÓN ORIGINAL  Y luego cambiar nueva
                                                                                            if (enhusillo == 1) {


                                                                                                // cambio posicion original.


                                                                                                // ROTAR EN TABLA
                                                                                                var HttpClient = function() {

                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/rotarcar/' + valortoolenhusillo;
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {

                                                                                                    // CAMBIAR EN TABLA
                                                                                                    var HttpClient = function() {

                                                                                                        this.get = function(aUrl, aCallback) {
                                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                                            }
                                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                                            anHttpRequest.send(null);
                                                                                                        }
                                                                                                    }
                                                                                                    var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                                    var client = new HttpClient();
                                                                                                    client.get(theurl, function(response) {});

                                                                                                });

                                                                                                //Mandar a hacer el cambio real

                                                                                                cmd = "Q" + valortoolenhusillo + ";1";
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);


                                                                                                var HttpClient = function() {

                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/sigherramienta/' + toolqueseusara;
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {});

                                                                                                /* ESTO TENDRIA QUE IR EN EL FINAL De la cadena de X.
                                        
                                                    setTimeout( function(){
                                                        
                                                        
                                                            var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/rotarcar/'+toolausar;
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                    var HttpClient = function () {
                                                                        
                                                                        this.get = function (aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function () {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                                }
                                                                }
                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function (response) {
                                                                });
                                                                });
                                                        
                                                                // CAMBIAR EN TABLA
                                                        
                                        
                                                        //Cambiar real.
                                                            cmd = "x"+toolausar+";"+obj[(toolausar-1)]['longitud'];
                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd );
                                        
                                                        },7000);
                                                        */

                                                                                            }
                                                                                        }
                                                                                        // Si la herramienta en el husillo es la herramienta que se pidió.
                                                                                        else {


                                                                                            if (enhusillo != 1) {

                                                                                                var HttpClient = function() {

                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/rotarcar/' + toolqueseusara;
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {

                                                                                                    // CAMBIAR EN TABLA
                                                                                                    var HttpClient = function() {

                                                                                                        this.get = function(aUrl, aCallback) {
                                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                                            }
                                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                                            anHttpRequest.send(null);
                                                                                                        }
                                                                                                    }
                                                                                                    var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                                    var client = new HttpClient();
                                                                                                    client.get(theurl, function(response) {});

                                                                                                });

                                                                                                cmd = "q" + toolqueseusara + ";1";
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);


                                                                                            } else {

                                                                                                esto.onM10BtnClick();
                                                                                                esto.activarm3();
                                                                                                //ENCENDERHUSILLO
                                                                                                setTimeout(() => {
                                                                                                    var HttpClient = function() {
                                                                                                        this.get = function(aUrl, aCallback) {
                                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                                            }
                                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                                            anHttpRequest.send(null);
                                                                                                        }
                                                                                                    }
                                                                                                    var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                    var client = new HttpClient();
                                                                                                    client.get(theurl, function(response) {

                                                                                                        response = response.split("Pin A5 reads analog ");
                                                                                                        response = parseInt(response);

                                                                                                        if (response < 900) {
                                                                                                            var cmd = "~";
                                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                        } else {


                                                                                                            setTimeout(function() {

                                                                                                                var HttpClient = function() {
                                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                                        }
                                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                                        anHttpRequest.send(null);
                                                                                                                    }
                                                                                                                }
                                                                                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                                var client = new HttpClient();
                                                                                                                client.get(theurl, function(response) {

                                                                                                                    response = response.split("Pin A5 reads analog ");
                                                                                                                    response = parseInt(response[1]);
                                                                                                                    if (response < 900) {
                                                                                                                        var cmd = "~";
                                                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                                    } else {
                                                                                                                        document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                                        erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                                        document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                                    }


                                                                                                                });

                                                                                                            }, 4000)

                                                                                                        }

                                                                                                    });

                                                                                                }, 8000);

                                                                                                //EN HUSILLO, SOLO BAJAR Y ARRANCAR.

                                                                                            }

                                                                                        }


                                                                                    }
                                                                                }

                                                                            });







                                                                            //TERMINA CH






                                                                        } else {

                                                                            alert("Debe bloquear las válvula del carrusel para poder moverlo.");

                                                                        }



                                                                    });

                                                                } else {
                                                                    alert("El husillo no ha terminado de girar");
                                                                }

                                                            });


                                                        }, 19000);


                                                    } else {

                                                        var HttpClient = function() {
                                                            this.get = function(aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function() {
                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                        aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                            }
                                                        }
                                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin A5 reads analog ");

                                                            response = parseInt(res[1]);

                                                            if (response > 900) {
                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.80/arduino/digital/29';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {

                                                                    var res = response.split("Pin D29 set to ");

                                                                    response = parseInt(res[1]);

                                                                    if (response == 1) {


                                                                        // COMIENZA CH
                                                                        var HttpClient = function() {

                                                                            this.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }
                                                                        var theurl = 'http://192.168.0.98/geth';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {

                                                                            var obj = JSON.parse(response);
                                                                            window.objetodah = obj;

                                                                            var modoh = parseInt(obj[0]['modoh']);



                                                                            var linea = lineacodigog.replace('M6', "").trim();


                                                                            linea = linea.replace('M7', "").trim();
                                                                            linea = linea.replace('T', "").trim();

                                                                            var linean = "N" + (contador2);
                                                                            linea = linea.replace(linean, "").trim();
                                                                            toolqueseusara = parseInt(linea);





                                                                            if (toolqueseusara == 0) {
                                                                                for (var i = 0; i < 17; i++) {

                                                                                    if (parseInt(obj[i]['enhusillo'])) {
                                                                                        // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.

                                                                                        var valortool = i + 1;

                                                                                    }
                                                                                }

                                                                                cmd = "q" + valortool + ";1";
                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                                if (modoh == 1) {
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                    });
                                                                                } else {
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {});

                                                                                }



                                                                            } else {

                                                                                // SI ES MODO H:
                                                                                if (modoh == 1) {
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/geth';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        var obj = JSON.parse(response);
                                                                                        window.objetodah = obj;
                                                                                    });

                                                                                    // Loop para encontrar que pocket tiene la herramienta pedida.
                                                                                    for (var i = 0; i < 17; i++) {

                                                                                        if (window.objetodah[i]['herramienta'] == toolqueseusara) {
                                                                                            // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                            var indexher = i;
                                                                                            var valortool = i + 1;
                                                                                            var longitud = window.objetodah[i]['longitud'];
                                                                                        }
                                                                                    }


                                                                                    //COMPENSACION
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        var obj = JSON.parse(response);

                                                                                        var valorx = obj['x'];
                                                                                        var valory = obj['y'];
                                                                                        var valorz = parseFloat(obj['z']);
                                                                                        var valora = obj['a'];

                                                                                        valorz = valorz + longitud;
                                                                                        valorz = valorz.toString();

                                                                                        var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                    });





                                                                                    //FIN COMPENSACION
                                                                                    if (!parseInt(obj[indexher]['enhusillo'])) {


                                                                                        // CAMBIO BRAZO

                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/sigherramienta/' + valortool;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});


                                                                                        cmd = "q" + valortool + ";1";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);



                                                                                        //Cambio brazo en la tabla.
                                                                                        var HttpClient = function() {

                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }
                                                                                        var theurl = 'http://192.168.0.98/cambiobrazomodoh/' + valortool;
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {

                                                                                        });

                                                                                        // }
                                                                                        //ROTACIÓN a nueva posicion.


                                                                                        //codigo de busqueda de siguiente herramienta -- SOLO EN GCODE.

                                                                                        /*       var largodecodigo = esto.gcode.lines.length;
                                                                                                var valorsiguientetool = 1000;
                                                                                                
                                                                                                for (var n=(idnum); n<largodecodigo; n++){
                                                                                                
                                                                                                    var gcodetemporal = esto.gcode.lines[n];
                                                                                                    if(gcodetemporal.match(/\bM6\b/i)){
                                                                                                        var linean = "N"+(n+1);
                                                                                                        var lineatemporal = gcodetemporal.replace('M6', "").trim();
                                                                                                        lineatemporal = lineatemporal.replace('T', "").trim();
                                                                                                        lineatemporal = lineatemporal.replace('M7', "").trim();
                                                                                                        lineatemporal = lineatemporal.replace(linean, "").trim();
                                                                                                
                                                                                                        var valorstool = parseInt(lineatemporal);
                                                                                                                            n=100000;
                                                                                                
                                                                                                                        }
                                                                                                                    }
                                                                                                
                                                                                                                    for( var i = 0; i < 17; i++){
                                                                                                if (parseInt(obj[i]['herramienta']) == valorstool){
                                                                                                    // NUMERO DE INDEX DEL POCKET A COPIAR DATOS DE LONGITUD.
                                                                                                    var indexher = i;
                                                                                                valorsiguientetool = i+1;
                                                                                                }}
                                                                                                
                                                                                                //si existe alguna siguiente tool hacer rotacion. si no, no hacer nada.
                                                                                                
                                                                                                
                                                                                                setTimeout(function(){
                                                                                                    if(valorsiguientetool != 1000){
                                                                                                
                                                                                                    cmd = "i"+valorsiguientetool;
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd );
                                                                                                //Cambio brazo en la tabla.
                                                                                                        var HttpClient = function () {
                                                                                                        
                                                                                                        this.get = function (aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function () {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                                }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/rotarcar/'+valorsiguientetool;
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function (response) {
                                                                                                
                                                                                                });
                                                                                                
                                                                                                }
                                                                                                var cmd  = "~";
                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + this.serialPort + " " + cmd);
                                                                                                },15000);
                                                                                                */
                                                                                    } else {
                                                                                        esto.onM10BtnClick();
                                                                                        esto.activarm3();
                                                                                        //ENCENDERHUSILLO
                                                                                        setTimeout(() => {
                                                                                            var HttpClient = function() {
                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {

                                                                                                response = response.split("Pin A5 reads analog ");
                                                                                                response = parseInt(response);

                                                                                                if (response < 900) {
                                                                                                    var cmd = "~";
                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                } else {


                                                                                                    setTimeout(function() {

                                                                                                        var HttpClient = function() {
                                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                                }
                                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                                anHttpRequest.send(null);
                                                                                                            }
                                                                                                        }
                                                                                                        var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                        var client = new HttpClient();
                                                                                                        client.get(theurl, function(response) {

                                                                                                            response = response.split("Pin A5 reads analog ");
                                                                                                            response = parseInt(response[1]);
                                                                                                            if (response < 900) {
                                                                                                                var cmd = "~";
                                                                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                            } else {
                                                                                                                document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                                var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                                erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                                document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                            }


                                                                                                        });

                                                                                                    }, 4000)

                                                                                                }

                                                                                            });
                                                                                        }, 8000);

                                                                                        //EN HUSILLO, SOLO BAJAR Y ARRANCAR.

                                                                                    }


                                                                                }

                                                                                // SI ES MODO LINEAL:  ***********************************************************************************************
                                                                                else {


                                                                                    var longitud = parseFloat(window.objetodah[(toolqueseusara - 1)]['longitud']);

                                                                                    var indexher = toolqueseusara - 1;
                                                                                    var valortool = toolqueseusara;




                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/sigherramienta/' + toolqueseusara;
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {});

                                                                                    var enhusillo = 100;

                                                                                    //COMPENSACION MODO LINEAL
                                                                                    var HttpClient = function() {

                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }
                                                                                    var theurl = 'http://192.168.0.98/api/origenesactivos/';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {

                                                                                        var obj = JSON.parse(response);

                                                                                        var valorx = obj['x'];
                                                                                        var valory = obj['y'];
                                                                                        var valorz = parseFloat(obj['z']);
                                                                                        var valora = obj['a'];

                                                                                        valorz = valorz + longitud;
                                                                                        valorz = valorz.toString();

                                                                                        var cmd = "G10 L2 P1 X" + valorx + " Y" + valory + " A" + valora + " Z" + valorz;
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3 " + cmd);



                                                                                    });





                                                                                    //FIN COMPENSACION

                                                                                    var valortoolenhusillo = valortool;

                                                                                    //BUSCAR SI HAY HERRAMIENTA EN EL HUSILLO
                                                                                    for (var i = 0; i < 17; i++) {

                                                                                        if (parseInt(obj[i]['enhusillo']) == 1) {
                                                                                            enhusillo = 1;
                                                                                            var indexherenhusillo = i;
                                                                                            var valortoolenhusillo = i + 1;
                                                                                        }

                                                                                    }

                                                                                    if (valortoolenhusillo != valortool) {
                                                                                        //SI HAY: REGRESARLA A POSICIÓN ORIGINAL  Y luego cambiar nueva
                                                                                        if (enhusillo == 1) {

                                                                                            // cambio posicion original.


                                                                                            // ROTAR EN TABLA
                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/rotarcar/' + valortoolenhusillo;
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {

                                                                                                // CAMBIAR EN TABLA
                                                                                                var HttpClient = function() {

                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {});

                                                                                            });

                                                                                            //Mandar a hacer el cambio real

                                                                                            cmd = "Q" + valortoolenhusillo + ";1";
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);




                                                                                        }
                                                                                    }
                                                                                    // Si la herramienta en el husillo es la herramienta que se pidió.
                                                                                    else {


                                                                                        if (enhusillo != 1) {

                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            var theurl = 'http://192.168.0.98/rotarcar/' + toolqueseusara;
                                                                                            var client = new HttpClient();
                                                                                            client.get(theurl, function(response) {

                                                                                                // CAMBIAR EN TABLA
                                                                                                var HttpClient = function() {

                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.98/cambiobrazomodop';
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {});

                                                                                            });

                                                                                            cmd = "q" + toolqueseusara + ";1";
                                                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send COM4 " + cmd);

                                                                                        } else {

                                                                                            esto.onM10BtnClick();
                                                                                            esto.activarm3();
                                                                                            //ENCENDERHUSILLO
                                                                                            setTimeout(() => {
                                                                                                var HttpClient = function() {
                                                                                                    this.get = function(aUrl, aCallback) {
                                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                aCallback(anHttpRequest.responseText);
                                                                                                        }
                                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                                        anHttpRequest.send(null);
                                                                                                    }
                                                                                                }
                                                                                                var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                var client = new HttpClient();
                                                                                                client.get(theurl, function(response) {

                                                                                                    response = response.split("Pin A5 reads analog ");
                                                                                                    response = parseInt(response);

                                                                                                    if (response < 900) {
                                                                                                        var cmd = "~";
                                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                        chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                    } else {


                                                                                                        setTimeout(function() {

                                                                                                            var HttpClient = function() {
                                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                                    }
                                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                                    anHttpRequest.send(null);
                                                                                                                }
                                                                                                            }
                                                                                                            var theurl = 'http://192.168.0.86/arduino/analog/5';
                                                                                                            var client = new HttpClient();
                                                                                                            client.get(theurl, function(response) {

                                                                                                                response = response.split("Pin A5 reads analog ");
                                                                                                                response = parseInt(response[1]);
                                                                                                                if (response < 900) {
                                                                                                                    var cmd = "~";
                                                                                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                                                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                                                                                } else {
                                                                                                                    document.getElementById("salirpausa").disabled = false;

document.getElementById("salirpausa").style = " background-color:greenyellow"
document.getElementById("salirpausa2").disabled = false;

document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                                                                                                    var erroresexistentes = document.getElementById("textoerrores").value;
                                                                                                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");
                                                                                                                    erroresexistentes = erroresexistentes.concat("HUSILLO NO COMENZO A GIRAR");
                                                                                                                    document.getElementById("textoerrores").value = erroresexistentes;
                                                                                                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                                                }


                                                                                                            });

                                                                                                        }, 4000)

                                                                                                    }

                                                                                                });

                                                                                            }, 8000);

                                                                                            //EN HUSILLO, SOLO BAJAR Y ARRANCAR.
                                                                                        }
                                                                                    }




                                                                                }
                                                                            }

                                                                        });







                                                                        //TERMINA CH






                                                                    } else {

                                                                        alert("Debe bloquear las válvula del carrusel para poder moverlo.");

                                                                    }



                                                                });

                                                            } else {
                                                                alert("El husillo no ha terminado de girar");
                                                            }

                                                        });





                                                    }
                                                })

                                            }
                                            break;



                                            /*********FIN CAMBIO DE HERRAMIENTA******/


                                            /************************INICIO UTO**************************/
                                        case (gcodeline.match(/\bUTO\b/i) || {}).input:

                                            var numeroorigen = gcodeline.match(/UTO (.*?) /i)[1];
                                            var utox = gcodeline.match(/X(.*?) /i)[1];
                                            var utoy = gcodeline.match(/Y(.*?) /i)[1];
                                            var utoa = gcodeline.match(/A(.*?) /i)[1];
                                            var utoz = gcodeline.match(/Z(.*?)*/i)[0];
                                            utoz = utoz.substring(1);

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }
                                            var theurl = 'http://192.168.0.98/api/uto/' + numeroorigen + "/" + utox + "/" + utoy + "/" + utoa + "/" + utoz;
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {




                                                var HttpClient = function() {
                                                    this.get = function(aUrl, aCallback) {
                                                        var anHttpRequest = new XMLHttpRequest();
                                                        anHttpRequest.onreadystatechange = function() {
                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                        }
                                                        anHttpRequest.open("GET", aUrl, true);
                                                        anHttpRequest.send(null);
                                                    }
                                                }
                                                var theurl = 'http://192.168.0.98/api/obtenerorigenesusar';
                                                var client = new HttpClient();
                                                client.get(theurl, function(response) {


                                                    var obj = JSON.parse(response);
                                                    switch (numeroorigen) {


                                                        case "1":
                                                            var xcambiar = obj['x1'];
                                                            var ycambiar = obj['y1'];
                                                            var acambiar = obj['a1'];
                                                            var zcambiar = obj['z1'];
                                                            break;
                                                        case "2":
                                                            var xcambiar = obj['x2'];
                                                            var ycambiar = obj['y2'];
                                                            var acambiar = obj['a2'];
                                                            var zcambiar = obj['z2'];
                                                            break;
                                                        case "3":
                                                            var xcambiar = obj['x3'];
                                                            var ycambiar = obj['y3'];
                                                            var acambiar = obj['a3'];
                                                            var zcambiar = obj['z3'];
                                                            break;
                                                        case "4":
                                                            var xcambiar = obj['x4'];
                                                            var ycambiar = obj['y4'];
                                                            var acambiar = obj['a4'];
                                                            var zcambiar = obj['z4'];
                                                            break;
                                                        case "5":
                                                            var xcambiar = obj['x5'];
                                                            var ycambiar = obj['y5'];
                                                            var acambiar = obj['a5'];
                                                            var zcambiar = obj['z5'];
                                                            break;
                                                        case "6":
                                                            var xcambiar = obj['x6'];
                                                            var ycambiar = obj['y6'];
                                                            var acambiar = obj['a6'];
                                                            var zcambiar = obj['z6'];
                                                            break;
                                                        case "7":
                                                            var xcambiar = obj['x7'];
                                                            var ycambiar = obj['y7'];
                                                            var acambiar = obj['a7'];
                                                            var zcambiar = obj['z7'];
                                                            break;
                                                        case "8":
                                                            var xcambiar = obj['x8'];
                                                            var ycambiar = obj['y8'];
                                                            var acambiar = obj['a8'];
                                                            var zcambiar = obj['z8'];
                                                            break;
                                                        case "9":
                                                            var xcambiar = obj['x9'];
                                                            var ycambiar = obj['y9'];
                                                            var acambiar = obj['a9'];
                                                            var zcambiar = obj['z9'];
                                                            break;
                                                        case "10":
                                                            var xcambiar = obj['x10'];
                                                            var ycambiar = obj['y10'];
                                                            var acambiar = obj['a10'];
                                                            var zcambiar = obj['z10'];
                                                            break;
                                                        case "11":
                                                            var xcambiar = obj['x11'];
                                                            var ycambiar = obj['y11'];
                                                            var acambiar = obj['a11'];
                                                            var zcambiar = obj['z11'];
                                                            break;
                                                        case "12":
                                                            var xcambiar = obj['x12'];
                                                            var ycambiar = obj['y12'];
                                                            var acambiar = obj['a12'];
                                                            var zcambiar = obj['z12'];
                                                            break;
                                                        case "13":
                                                            var xcambiar = obj['x13'];
                                                            var ycambiar = obj['y13'];
                                                            var acambiar = obj['a13'];
                                                            var zcambiar = obj['z13'];
                                                            break;
                                                        case "14":
                                                            var xcambiar = obj['x14'];
                                                            var ycambiar = obj['y14'];
                                                            var acambiar = obj['a14'];
                                                            var zcambiar = obj['z14'];
                                                            break;
                                                        case "15":
                                                            var xcambiar = obj['x15'];
                                                            var ycambiar = obj['y15'];
                                                            var acambiar = obj['a15'];
                                                            var zcambiar = obj['z15'];
                                                            break;
                                                        case "16":
                                                            var xcambiar = obj['x16'];
                                                            var ycambiar = obj['y16'];
                                                            var acambiar = obj['a16'];
                                                            var zcambiar = obj['z16'];
                                                            break;

                                                    }



                                                    var cmd = "G10 L2 P1 X" + xcambiar + " Y" + ycambiar + " A" + acambiar + " Z" + zcambiar;
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                    //alert(cmd);
                                                    setTimeout(function() {
                                                        var cmd = "G54";
                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                        if (!sigespecial && !errora && !errory) {
                                                            setTimeout(function() {
                                                                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");

                                                                var cmd = "~";
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                            }, 700);
                                                        }
                                                    }, 500);


                                                });

                                            });
                                            break;
                                            /**********************************************FIN UTO***********************************/




                                            /**********************************************INICIO UAO***********************************/


                                        case (gcodeline.match(/\bUAO\b/i) || {}).input:
                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }
                                            var theurl = 'http://192.168.0.98/api/resetuto';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {});
                                            var coord = gcodeline.match(/UAO(.*?)*/i)[0];
                                            coord = coord.substring(4);

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }
                                            var theurl = 'http://192.168.0.98/api/obtenerorigenesusar';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {


                                                var obj = JSON.parse(response);
                                                switch (coord) {


                                                    case "1":
                                                        var xcambiar = obj['x1'];
                                                        var ycambiar = obj['y1'];
                                                        var acambiar = obj['a1'];
                                                        var zcambiar = obj['z1'];
                                                        break;
                                                    case "2":
                                                        var xcambiar = obj['x2'];
                                                        var ycambiar = obj['y2'];
                                                        var acambiar = obj['a2'];
                                                        var zcambiar = obj['z2'];
                                                        break;
                                                    case "3":
                                                        var xcambiar = obj['x3'];
                                                        var ycambiar = obj['y3'];
                                                        var acambiar = obj['a3'];
                                                        var zcambiar = obj['z3'];
                                                        break;
                                                    case "4":
                                                        var xcambiar = obj['x4'];
                                                        var ycambiar = obj['y4'];
                                                        var acambiar = obj['a4'];
                                                        var zcambiar = obj['z4'];
                                                        break;
                                                    case "5":
                                                        var xcambiar = obj['x5'];
                                                        var ycambiar = obj['y5'];
                                                        var acambiar = obj['a5'];
                                                        var zcambiar = obj['z5'];
                                                        break;
                                                    case "6":
                                                        var xcambiar = obj['x6'];
                                                        var ycambiar = obj['y6'];
                                                        var acambiar = obj['a6'];
                                                        var zcambiar = obj['z6'];
                                                        break;
                                                    case "7":
                                                        var xcambiar = obj['x7'];
                                                        var ycambiar = obj['y7'];
                                                        var acambiar = obj['a7'];
                                                        var zcambiar = obj['z7'];
                                                        break;
                                                    case "8":
                                                        var xcambiar = obj['x8'];
                                                        var ycambiar = obj['y8'];
                                                        var acambiar = obj['a8'];
                                                        var zcambiar = obj['z8'];
                                                        break;
                                                    case "9":
                                                        var xcambiar = obj['x9'];
                                                        var ycambiar = obj['y9'];
                                                        var acambiar = obj['a9'];
                                                        var zcambiar = obj['z9'];
                                                        break;
                                                    case "10":
                                                        var xcambiar = obj['x10'];
                                                        var ycambiar = obj['y10'];
                                                        var acambiar = obj['a10'];
                                                        var zcambiar = obj['z10'];
                                                        break;
                                                    case "11":
                                                        var xcambiar = obj['x11'];
                                                        var ycambiar = obj['y11'];
                                                        var acambiar = obj['a11'];
                                                        var zcambiar = obj['z11'];
                                                        break;
                                                    case "12":
                                                        var xcambiar = obj['x12'];
                                                        var ycambiar = obj['y12'];
                                                        var acambiar = obj['a12'];
                                                        var zcambiar = obj['z12'];
                                                        break;
                                                    case "13":
                                                        var xcambiar = obj['x13'];
                                                        var ycambiar = obj['y13'];
                                                        var acambiar = obj['a13'];
                                                        var zcambiar = obj['z13'];
                                                        break;
                                                    case "14":
                                                        var xcambiar = obj['x14'];
                                                        var ycambiar = obj['y14'];
                                                        var acambiar = obj['a14'];
                                                        var zcambiar = obj['z14'];
                                                        break;
                                                    case "15":
                                                        var xcambiar = obj['x15'];
                                                        var ycambiar = obj['y15'];
                                                        var acambiar = obj['a15'];
                                                        var zcambiar = obj['z15'];
                                                        break;
                                                    case "16":
                                                        var xcambiar = obj['x16'];
                                                        var ycambiar = obj['y16'];
                                                        var acambiar = obj['a16'];
                                                        var zcambiar = obj['z16'];
                                                        break;

                                                }


                                                var theurl = 'http://192.168.0.98/api/actualizarorigenusado/' + coord;
                                                var client = new HttpClient();
                                                client.get(theurl, function(response) {});

                                                var cmd = "G10 L2 P1 X" + xcambiar + " Y" + ycambiar + " A" + acambiar + " Z" + zcambiar;
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                // alert(cmd);
                                                setTimeout(function() {
                                                    var cmd = "G54";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                    if (!sigespecial && !errora && !errory) {
                                                        setTimeout(function() {
                                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");

                                                            var cmd = "~";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                        }, 700);
                                                    }
                                                }, 500);


                                            });

                                            break;


                                            /********************************FIN UAO************************************************/

                                            /**************************************INICIA M3***********************/
                                        case (gcodeline.match(/\bM3\b/i) || {}).input:
                                            ocupado = 1;
                                            this.activarm3();
                                            //alert ("M3");    

                                            var tiempo = 8000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;



                                            /***********************************FIN M3 *********************************/


                                            /**************************************INICIO M5********************************/

                                        case (gcodeline.match(/\bM5\b/i) || {}).input:
                                            ocupado = 1;
                                            this.activarm5();

                                            // alert ("M5");
                                            var tiempo = 4000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }
                                            break;

                                            /*************************************FIN M5 ***********************************/

                                            /***************************************INICIO M57 SACAR PALETA DERECHA*********/
                                        case (gcodeline.match(/\bM57\b/i) || {}).input:
                                            document.getElementById("salirpausa").disabled = false;

                                            document.getElementById("salirpausa").style = " background-color:greenyellow"
                                            document.getElementById("salirpausa2").disabled = false;

                                            document.getElementById("salirpausa2").style = " background-color:greenyellow"

                                            var esto = this;
                                            var cmd = "$3ma=1";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                            var cmd = "$ysn=0";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                            var cmd = "$ysx=1";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                                            setTimeout(function() {
                                                var cmd = "$2ma=3";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                                var cmd = "$asn=0";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                                                var cmd = "$asx=1";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

ocupado = 0;
                                                esto.verificarmesaizqdentro();

setTimeout(function(){
esto.activarM57();
},1000);

                                            }, 1000);
                                            break;

                                            /***************************************INICIO M58 Meter PALETA DERECHA*********/


                                        case (gcodeline.match(/\bM58\b/i) || {}).input:
                                            document.getElementById("salirpausa").disabled = false;

                                            document.getElementById("salirpausa").style = " background-color:greenyellow"
                                            document.getElementById("salirpausa2").disabled = false;

                                            document.getElementById("salirpausa2").style = " background-color:greenyellow"
                                            var esto = this;

                                            esto.verificarmesaderechadentro();

setTimeout(function(){
                                            esto.activarM58();
                                            ocupado = 0;
                                        },1000);
                                            // alert ("M58");


                                            break;
                                            /*************************************FIN M57 ***********************************/



                                            /***************************************INICIO M116*********/


                                        case (gcodeline.match(/\bM116\b/i) || {}).input:

                                            numerobroca = "16";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M116 ***********************************/

                                            /***************************************INICIO M115*********/


                                        case (gcodeline.match(/\bM115\b/i) || {}).input:

                                            numerobroca = "15";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M115 ***********************************/

                                            /***************************************INICIO M114*********/


                                        case (gcodeline.match(/\bM114\b/i) || {}).input:

                                            numerobroca = "14";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M114 ***********************************/

                                            /***************************************INICIO M113*********/


                                        case (gcodeline.match(/\bM113\b/i) || {}).input:

                                            numerobroca = "13";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M113 ***********************************/
                                            /***************************************INICIO M112*********/


                                        case (gcodeline.match(/\bM112\b/i) || {}).input:

                                            numerobroca = "12";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M112 ***********************************/

                                            /***************************************INICIO M111*********/


                                        case (gcodeline.match(/\bM111\b/i) || {}).input:

                                            numerobroca = "11";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M111 ***********************************/

                                            /***************************************INICIO M110*********/


                                        case (gcodeline.match(/\bM110\b/i) || {}).input:

                                            numerobroca = "10";
                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M110 ***********************************/


                                            /***************************************INICIO M109*********/


                                        case (gcodeline.match(/\bM109\b/i) || {}).input:

                                            numerobroca = "9";
                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M109 ***********************************/
                                            /***************************************INICIO M108*********/


                                        case (gcodeline.match(/\bM108\b/i) || {}).input:

                                            numerobroca = "8";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M108 ***********************************/

                                            /***************************************INICIO M107*********/


                                        case (gcodeline.match(/\bM107\b/i) || {}).input:

                                            numerobroca = "7";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M107 ***********************************/
                                            /***************************************INICIO M106*********/


                                        case (gcodeline.match(/\bM106\b/i) || {}).input:

                                            numerobroca = "6";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M106 ***********************************/

                                            /***************************************INICIO M105*********/


                                        case (gcodeline.match(/\bM105\b/i) || {}).input:

                                            numerobroca = "5";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M105 ***********************************/

                                            /***************************************INICIO M104*********/


                                        case (gcodeline.match(/\bM104\b/i) || {}).input:

                                            numerobroca = "4";

                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M104 ***********************************/
                                            /***************************************INICIO M103*********/


                                        case (gcodeline.match(/\bM103\b/i) || {}).input:

                                            numerobroca = "3";
                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M103 ***********************************/
                                            /***************************************INICIO M102*********/


                                        case (gcodeline.match(/\bM102\b/i) || {}).input:

                                            numerobroca = "2";
                                            ocupado = 1;
                                            // alert ("M102");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M102 ***********************************/
                                            /***************************************INICIO M101*********/


                                        case (gcodeline.match(/\bM101\b/i) || {}).input:
                                            ocupado = 1;
                                            numerobroca = "1";

                                            // alert ("M101");
                                            if (!sigespecial && !errora && !errory) {
                                                var cmd = "~";
                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                            }
                                            ocupado = 0;
                                            break;
                                            /*************************************FIN M101 ***********************************/
                                            /***************************************INICIO M100*********/


                                        case (gcodeline.match(/\bM100\b/i) || {}).input:
                                            ocupado = 1;
                                            this.subirtbrocaBtnClick();

                                            // alert ("M100");
                                            var tiempo = 2000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }
                                            break;
                                            /*************************************FIN M100 ***********************************/

                                            /***************************************INICIO M22*********/


                                        case (gcodeline.match(/\bM22\b/i) || {}).input:
                                            ocupado = 1;
                                            this.taladroarribaBtnClick();

                                            // alert ("M22");
                                            var tiempo = 2000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }
                                            break;
                                            /*************************************FIN M22 ***********************************/

                                            /***************************************INICIO M20*********/


                                        case (gcodeline.match(/\bM20\b/i) || {}).input:

                                            ocupado = 1;
                                            this.onM20BtnClick();
                                            // alert ("M20");
                                            var tiempo = 4000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M20 ***********************************/

                                            /***************************************INICIO M10*********/


                                        case (gcodeline.match(/\bM10\b/i) || {}).input:
                                            ocupado = 1;
                                            this.onM10BtnClick();
                                            // alert ("M10");
                                            var tiempo = 4000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M10 ***********************************/

                                            /***************************************INICIO M12*********/


                                        case (gcodeline.match(/\bM12\b/i) || {}).input:
                                            ocupado = 1;
                                            this.taladroabajoBtnClick();

                                            // alert ("M12");
                                            var tiempo = 2000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M12 ***********************************/


                                            /***************************************INICIO M9*********/


                                        case (gcodeline.match(/\bM9\b/i) || {}).input:
                                            ocupado = 1;
                                            this.taladrooffBtnClick();

                                            // alert ("M9");
                                            var tiempo = 4000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M9***********************************/
                                            /***************************************INICIO M8*********/


                                        case (gcodeline.match(/\bM8\b/i) || {}).input:
                                            ocupado = 1;
                                            this.taladroonBtnClick();

                                            // alert ("M8");
                                            var tiempo = 5000;
                                            temp = temp + tiempo;
                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M9***********************************/

                                            /***************************************INICIO M199*********/


                                        case (gcodeline.match(/\bM199\b/i) || {}).input:

                                            //alert(sigespecial);
                                            ocupado = 1;
                                            this.activarM199();

                                            // alert ("M199");
                                            var tiempo = 1000;
                                            temp = temp + tiempo;

                                            if (!sigespecial && !errora && !errory) {
                                                setTimeout(function() {

                                                    temp = 0;
                                                    var cmd = "~";
                                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                                    chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                                                }, temp);
                                            }

                                            break;
                                            /*************************************FIN M199***********************************/



                                            /*************************** FIN SWITCH***********************/
                                    }






















                                    //++++++++++++++++


                                } else {



                                    if (!sigespecial && !errora && !errory) {
                                        /*setTimeout(function(){
                                        var cmd  = "~";
                                           chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                        },800)*/
                                    }
                                    temp = 0;


                                }

                                contadordelinea = contadordelinea + 1;


                            }


                            // continuar el procesamiento en tinyG


                        }


                        // ok, here's the deal, we only get status intervals every
                        // 250ms, which means we'll get a line number that could be
                        // many numbers beyond the last line we marked as "executed"
                        // so we have to fill in the gaps

                        for (var markIndex = this.lastLineMarkedExecuted; markIndex < idnum; markIndex++) {
                            //console.log("onExecute. marking metaline as executed. markIndex:", markIndex, "metaLine:", this.metaLines[markIndex]);
                            if (this.metaLines[markIndex] == null) {
                                //console.log("onExecute no meta data for this element yet. creating it.");
                                this.metaLines[markIndex] = $.extend({}, this.metaObj);
                            }

                            // set that it is queued
                            this.metaLines[markIndex].isExecuted = true;

                            // update the dom if this row is showing  
                            // send in 1-based number, not 0-based
                            // our id is 1-based, i.e. the row number
                            this.updateRowQueueStats(markIndex + 1);

                            // Act on line, if applicable
                            this.displayLine(markIndex, this.onChiliPepprPauseOnExecute);

                            //console.log("metaLine after:", this.metaLines[markIndex]);
                        }
                        this.lastLineMarkedExecuted = markIndex;

                        // let user follow along on completes
                        this.gotoLine(idnum, true);

                        // see if we're done sending
                        if (idnum >= this.fileLines.length) {
                            var serialPort = "COM3";
                            console.log("onExecute. at end of onExecuting gcode.");
                            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Sender", "Done Executing Gcode. Duration " + this.statEls.timeDur.text() + " Lines " + this.fileLines.length, 5000);
                            var cmd = "~";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                            if (!this.isJobDonePubSubSent) {
                                chilipeppr.publish("/com-chilipeppr-widget-gcode/done", "Duration " + this.statEls.timeDur.text() + " Lines " + this.fileLines.length);
                                this.isJobDonePubSubSent = true;
                            }

                            // also trigger stop button
                            this.onStop({
                                viaOnExecute: true
                            });

                            // mark to no longer update onExecuteds (we'll exit
                            // at top of this method when null) we get marked as 
                            // an int from onPyay when we want to kick in our
                            // updates again
                            this.lastLineMarkedExecuted == null;
                        }

                        // update estimated time remaining
                        this.calcEstimatedRemain(idnum - 1);
                    }

                    // update duration of job
                    var dur = new Date().getTime() - this.timeStart;
                    dur = this.toHHMMSS(parseInt(dur / 1000));
                    if (this.statEls) this.statEls.timeDur.text(dur);



                    //console.groupEnd();
                },


                //taladro encendido
                taladroonBtnClick: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.86/arduino/digital/32/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.88/arduino/digital/27/1';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("indicadortaladro").className = "led-green";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Taladro",
                                    "Taladro Encendido",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 1000);

                    });


                },


                activarM199: function(evt) {
                    //alert("M199");
                    //alert(numerobroca);    
                    switch (numerobroca) {
                        case "1":
                            this.bajarbroca1();

                            break;

                        case "2":
                            this.bajarbroca2();

                            break;

                        case "3":
                            this.bajarbroca3();

                            break;

                        case "4":
                            this.bajarbroca4();

                            break;

                        case "5":
                            this.bajarbroca5();

                            break;

                        case "6":
                            this.bajarbroca6();


                            break;

                        case "7":
                            this.bajarbroca7();


                            break;

                        case "8":
                            this.bajarbroca8();


                            break;
                        case "9":
                            this.bajarbroca9();

                            break;

                        case "10":
                            this.bajarbroca10();

                            break;

                        case "11":
                            this.bajarbroca11();


                            break;

                        case "12":
                            this.bajarbroca12();

                            break;

                        case "13":
                            this.bajarbroca13();

                            break;

                        case "14":
                            this.bajarbroca14();

                            break;

                        case "15":
                            this.bajarbroca15();


                            break;

                        case "16":
                            this.bajarbroca16();

                            break;

                    }

                },


                //taladro apagado
                taladrooffBtnClick: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.88/arduino/digital/27/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.86/arduino/digital/32/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("indicadortaladro").className = "led-off";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Taladro",
                                    "Taladro Apagado",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 1000);

                    });

                },


                onM20BtnClick: function(evt) {




                    /*   var erroresexistentes = document.getElementById("textoalarmas").value;
                       
                       alarmasexistentes = alarmasexistentes.concat("\\\n\\\n");
                       
                       alarmasexistentes = alarmasexistentes.concat("LALA");

                       document.getElementById("textoalarmas").value = alarmasexistentes;
                       */



                    // Validación

                    // Si el brazo no está extendido
                    var esto = this;
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.80/arduino/digital/3/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {


                    });

                    theurl = 'http://192.168.0.80/arduino/digital/8/1';
                    client = new HttpClient();
                    client.get(theurl, function(response) {


                    });




                    var cmd = "g";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + serialPort2 + " " + cmd);
                    entrabajo = 0;
                    document.getElementById("indicadorposhusillo").className = "led-off";

                    chilipeppr.publish(
                        '/com-chilipeppr-elem-flashmsg/flashmsg',
                        "Estado del Husillo",
                        "Husillo en posición de descanso",
                        4000 /* show for 2 second */
                    );


                    //Continúa procedimiento



                },




                //Husillo trabajo

                onM10BtnClick: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.80/arduino/distancia/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        var res = parseFloat(response);
                        if (res < 30 && entrabajo == 0) {


                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.80/arduino/digital/8/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {



                            });


                            theurl = 'http://192.168.0.80/arduino/digital/3/1';
                            client.get(theurl, function(response) {



                            });




                            var cmd = "p";
                            entrabajo = 1;
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "send " + serialPort2 + " " + cmd);

                            document.getElementById("indicadorposhusillo").className = "led-green";

                            chilipeppr.publish(
                                '/com-chilipeppr-elem-flashmsg/flashmsg',
                                "Estado del Husillo",
                                "Husillo en posición de trabajo",
                                4000 /* show for 2 second */
                            );

                        }
                    });
                    //Continúa procedimiento





                },


                //subir taladro
                taladroarribaBtnClick: function(evt) {





                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/30';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D30 set to ");
                        response = parseInt(res[1]);

                        if (response == 0) {


                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/26/1';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {



                                setTimeout(function() {
                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }
                                    var theurl = 'http://192.168.0.84/arduino/digital/26/0';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                    });

                                }, 2000);



                            });

                            // VALIDACION TALADRO

                            setTimeout(function() {

                                var HttpClient = function() {
                                    this.get = function(aUrl, aCallback) {
                                        var anHttpRequest = new XMLHttpRequest();
                                        anHttpRequest.onreadystatechange = function() {
                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                aCallback(anHttpRequest.responseText);
                                        }
                                        anHttpRequest.open("GET", aUrl, true);
                                        anHttpRequest.send(null);
                                    }
                                }
                                var theurl = 'http://192.168.0.84/arduino/digital/30';
                                var client = new HttpClient();
                                client.get(theurl, function(response) {

                                    var res = response.split("Pin D30 set to ");
                                    response = parseInt(res[1]);

                                    if (response == 1) {

                                        document.getElementById("indicadortaladropos").className = "led-off";
                                        chilipeppr.publish(
                                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                                            "Estado del Taladro",
                                            "Taladro en Posición de Descanso",
                                            5000 /* show for 2 second */
                                        );

                                    } else {

                                        chilipeppr.publish(
                                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                                            "Estado del Taladro",
                                            "Taladro no llego a posición de descanso (I.128), revisar su estado",
                                            5000 /* show for 2 second */
                                        );


                                    }
                                });


                            }, 5000);

                        } else {

                            chilipeppr.publish(
                                '/com-chilipeppr-elem-flashmsg/flashmsg',
                                "Estado del Taladro",
                                "Taladro en posición de trabajo",
                                5000 /* show for 2 second */
                            );


                        }
                    });

                },

                //bajar taladro
                taladroabajoBtnClick: function(evt) {

                    ////alert("ENTRE");
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/29';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D29 set to ");
                        response = parseInt(res[1]);

                        if (response == 0) {


                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/25/1';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {



                                setTimeout(function() {
                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }
                                    var theurl = 'http://192.168.0.84/arduino/digital/25/0';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                    });

                                }, 2000);



                            });

                            // VALIDACION TALADRO

                            setTimeout(function() {

                                var HttpClient = function() {
                                    this.get = function(aUrl, aCallback) {
                                        var anHttpRequest = new XMLHttpRequest();
                                        anHttpRequest.onreadystatechange = function() {
                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                aCallback(anHttpRequest.responseText);
                                        }
                                        anHttpRequest.open("GET", aUrl, true);
                                        anHttpRequest.send(null);
                                    }
                                }
                                var theurl = 'http://192.168.0.84/arduino/digital/29';
                                var client = new HttpClient();
                                client.get(theurl, function(response) {

                                    var res = response.split("Pin D29 set to ");
                                    response = parseInt(res[1]);

                                    if (response == 1) {

                                        document.getElementById("indicadortaladropos").className = "led-green";
                                        chilipeppr.publish(
                                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                                            "Estado del Taladro",
                                            "Taladro en Posición de Trabajo",
                                            5000 /* show for 2 second */
                                        );

                                    } else {

                                        chilipeppr.publish(
                                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                                            "Estado del Taladro",
                                            "Taladro no llego a posición de trabajo (I.129), revisar su estado",
                                            5000 /* show for 2 second */
                                        );


                                    }
                                });


                            }, 5000);

                        } else {

                            chilipeppr.publish(
                                '/com-chilipeppr-elem-flashmsg/flashmsg',
                                "Estado del Taladro",
                                "Taladro en posición de trabajo",
                                5000 /* show for 2 second */
                            );


                        }
                    });

                },


                onmjuntasBtnClick: function(evt) {
                    var cmd = "G28.2 Y0 A0";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                    var home = 0;

                    while (home = 0) {
                        chilipeppr.subscribe("COM3/ws/recv", this, function(msg) {
                            this.onWsMessage(msg);
                        });

                    }

                    if (home == 1) {

                        // quitar el run 192.168.0.88/arduino/digital/11/0


                    }




                },

                subirbrocaBtnClick: function(evt) {

                    var value = document.getElementById("brocanum").value;

                    switch (value) {


                        case "1":
                            this.subirbroca1();

                            break;

                        case "2":
                            this.subirbroca2();
                            break;

                        case "3":
                            this.subirbroca3();
                            break;

                        case "4":
                            this.subirbroca4();
                            break;

                        case "5":
                            this.subirbroca5();
                            break;

                        case "6":
                            this.subirbroca6();
                            break;

                        case "7":
                            this.subirbroca7();
                            break;

                        case "8":
                            this.subirbroca8();

                            break;
                        case "9":
                            this.subirbroca9();
                            break;

                        case "10":
                            this.subirbroca10();
                            break;

                        case "11":
                            this.subirbroca11();
                            break;

                        case "12":
                            this.subirbroca12();

                            break;

                        case "13":
                            this.subirbroca13();

                            break;

                        case "14":
                            this.subirbroca14();

                            break;

                        case "15":
                            this.subirbroca15();
                            break;

                        case "16":
                            this.subirbroca16();
                            break;

                        default:
                            value = "papas";

                    }



                },


                bajarbrocaBtnClick: function(evt) {
                    var value = document.getElementById("brocanum").value;


                    switch (value) {


                        case "1":
                            this.bajarbroca1();
                            break;

                        case "2":
                            this.bajarbroca2();
                            break;

                        case "3":
                            this.bajarbroca3();
                            break;

                        case "4":
                            this.bajarbroca4();
                            break;

                        case "5":
                            this.bajarbroca5();

                            break;

                        case "6":
                            this.bajarbroca6();

                            break;

                        case "7":
                            this.bajarbroca7();

                            break;

                        case "8":
                            this.bajarbroca8();

                            break;
                        case "9":
                            this.bajarbroca9();
                            break;

                        case "10":
                            this.bajarbroca10();
                            break;

                        case "11":
                            this.bajarbroca11();

                            break;

                        case "12":
                            this.bajarbroca12();
                            break;

                        case "13":
                            this.bajarbroca13();

                            break;

                        case "14":
                            this.bajarbroca14();

                            break;

                        case "15":
                            this.bajarbroca15();

                            break;

                        case "16":
                            this.bajarbroca16();
                            break;


                        default:
                            value = "papas";

                    }


                },

                //subir brocas
                subirbroca16: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/28/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/28/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib16").className = "led-off";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 16 Arriba",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });

                },


                subirbroca15: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/23/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/23/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib15").className = "led-off";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 15 Arriba",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });

                },


                subirbroca14: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/27/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/27/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib14").className = "led-off";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 14 Arriba",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });

                },




                subirbroca13: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/14/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib13").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 13 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },



                subirbroca12: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/15/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib12").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 12 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },




                subirbroca11: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/16/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib11").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 11 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca10: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/17/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib10").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 10 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca9: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/18/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib9").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 9 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca8: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/9/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib8").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 8 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca7: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/8/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib7").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 7 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca6: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/7/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib6").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 6 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },


                subirbroca5: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/6/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib5").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 5 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },


                subirbroca4: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/5/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib4").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 4 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca3: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/4/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib3").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 3 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca2: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/3/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib2").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 2 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },

                subirbroca1: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/2/0';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib1").className = "led-off";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 1 Arriba",
                            2000 /* show for 2 second */
                        );

                    });





                },
                //fin subir brocas


                //bajar brocas 

                bajarbroca16: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/10/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/10/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib16").className = "led-off";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 16 Abajo",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });
                },

                // 15 y 16
                bajarbroca15: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/11/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/11/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib15").className = "led-green";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 15 Abajo",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });

                },


                bajarbroca14: function(evt) {
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/12/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {



                        setTimeout(function() {
                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }
                            var theurl = 'http://192.168.0.84/arduino/digital/12/0';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                document.getElementById("ib14").className = "led-green";
                                chilipeppr.publish(
                                    '/com-chilipeppr-elem-flashmsg/flashmsg',
                                    "Estado de Brocas",
                                    "Broca 14 Abajo",
                                    2000 /* show for 2 second */
                                );

                            });

                        }, 2000);

                    });

                },


                bajarbroca13: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/14/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib13").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 13 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },



                bajarbroca12: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/15/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib12").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 12 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },




                bajarbroca11: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/16/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib11").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 11 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca10: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/17/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib10").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 10 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca9: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/18/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib9").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 9 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca8: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/9/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib8").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 8 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca7: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/8/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib7").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 7 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca6: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/7/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib6").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 6 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },


                bajarbroca5: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/6/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib5").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 5 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },


                bajarbroca4: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/5/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib4").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 4 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca3: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/4/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib3").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 3 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca2: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/3/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib2").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 2 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                bajarbroca1: function(evt) {



                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/digital/2/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        document.getElementById("ib1").className = "led-green";
                        chilipeppr.publish(
                            '/com-chilipeppr-elem-flashmsg/flashmsg',
                            "Estado de Brocas",
                            "Broca 1 Abajo",
                            2000 /* show for 2 second */
                        );

                    });





                },

                //fin bajar brocas

                ////////////////// MESA IZQUIERDA ENTREGA/////////////////////////////////////////////////////////

                // BLOQUEAR PALETA IZQUIERDA

                bloquearpaletaizquierda: function(evt) {

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.82/arduino/digital/34/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                    });

                    setTimeout(function(){
                        var theurl = 'http://192.168.0.82/arduino/digital/34/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                    });
                  

                    setTimeout(function() {

                        var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }


                        var theurl = 'http://192.168.0.82/arduino/digital/34/0';
                        var client = new HttpClient();
                        client.get(theurl, function(response) {
                            // alert ("BLOQUEADO");
                        });



                        var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }


                        var theurl = 'http://192.168.0.82/arduino/digital/40';
                        var client = new HttpClient();
                        client.get(theurl, function(response) {

                            var res = response.split("Pin D40 set to ");

                            response = parseInt(res[1]);

                            if (response == 1) {


                                // SI SE BLOQUEO
                                // http://192.168.0.85/arduino/digital/7/0

                                // APAGAR LED
                                var HttpClient = function() {


                                    this.get = function(aUrl, aCallback) {
                                        var anHttpRequest = new XMLHttpRequest();
                                        anHttpRequest.onreadystatechange = function() {
                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                aCallback(anHttpRequest.responseText);
                                        }
                                        anHttpRequest.open("GET", aUrl, true);
                                        anHttpRequest.send(null);
                                    }
                                }

                                var theurl = 'http://192.168.0.85/arduino/digital/6/0';
                                var client = new HttpClient();
                                client.get(theurl, function(response) {});
                            } else {


                                var erroresexistentes = document.getElementById("textoerrores").value;

                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                erroresexistentes = erroresexistentes.concat("Mesas A no pudo ser bloqueada, Error de Movimiento");

                                document.getElementById("textoerrores").value = erroresexistentes;
                                document.getElementById("indicadorerrorejec").className = "led-red";
                                var cmd = "!";
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                                // SI NO SE BLOQUEO (ERROR)


                            }
                        })

                    }, 1000)

                },2000)

                },




                // Chequeo posicion trabajo

                checkposiciontrabajoizq: function(evt) {

                    var HttpClient = function() {


                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN TRABAJO
                    var theurl = 'http://192.168.0.82/arduino/digital/41';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D41 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            return true;
                        } else {

                            return false;
                        }
                    });


                },


                // Chequeo posicion carga

                checkposicioncargaizq: function(evt) {

                    var HttpClient = function() {

                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN CARGA
                    var theurl = 'http://192.168.0.82/arduino/digital/37';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D37 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {
                            return true;

                        } else {
                            return false;

                        }
                    });



                },


                // SACARMESAizquierda
                sacarpaletaizquierda: function(evt) {

                    var self = this;
                    var HttpClient = function() {


                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN TRABAJO
                    var theurl = 'http://192.168.0.82/arduino/digital/41';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D41 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {


                            // LEER SI ESTA DESBLOQUEADA                               

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }


                            var theurl = 'http://192.168.0.82/arduino/digital/38';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D38 set to ");

                                response = parseInt(res[1]);
                                // SI NO ESTA DESBLOQUEADA.... 
                                if (response == 0) {


                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    // ENCIENDE INTERRUPTOR
                                    var theurl = 'http://192.168.0.82/arduino/digital/35/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            // APAGA INTERRUPTOR
                                            var theurl = 'http://192.168.0.82/arduino/digital/35/0';
                                            var client = new HttpClient();



                                            setTimeout(function() {

                                                client.get(theurl, function(response) {

                                                    // Chequea si se desacoplo 
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }


                                                    var theurl = 'http://192.168.0.82/arduino/digital/38';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D38 set to ");

                                                        response = parseInt(res[1]);
                                                        // SI NO ESTA DESBLOQUEADA.... 
                                                        if (response == 0) {

                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                            erroresexistentes = erroresexistentes.concat("Mesa A no Desbloqueada, Error de Movimiento");

                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                            var cmd = "!";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                        } else {

                                                            // SI ESTA DESBLOQUEADA
                                                            // Saca MESA derecha.


                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }


                                                            var theurl = 'http://192.168.0.85/arduino/digital/11/1';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {


                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }


                                                                // ACTIVAR LED                                            

                                                                var HttpClient = function() {


                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.85/arduino/digital/6/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});






                                                                // ACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/24/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {


                                                                    // DESACTIVAR FW 

                                                                    var HttpClient = function() {
                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }

                                                                    var theurl = 'http://192.168.0.85/arduino/digital/8/1';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {


                                                                        //ESPERAR 1 SEGUNDO LEER FRENO


                                                                        var HttpClient = function() {
                                                                            this.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }

                                                                        // DESACTIVAR RUN
                                                                        var theurl = 'http://192.168.0.85/arduino/digital/11/0';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {});



                                                                        setTimeout(function() {





                                                                            var HttpClient = function() {
                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }

                                                                            var freno = 1;


                                                                            var theurl = 'http://192.168.0.82/arduino/digital/39';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var res = response.split("Pin D39 set to ");

                                                                                response = parseInt(res[1]);

                                                                                //if (response == 0) {


                                                                                // APAGA RUN
                                                                                //DESACTIVA PALETA


                                                                                // LEE SI MESA ESTA EN CARGA
                                                                                var theurl = 'http://192.168.0.82/arduino/digital/37';
                                                                                var client = new HttpClient();

                                                                                setTimeout(function(){
                                                                                client.get(theurl, function(response) {

                                                                                    var res = response.split("Pin D37 set to ");

                                                                                    response = parseInt(res[1]);

                                                                                    if (response == 1) {
                                                                                        var HttpClient = function() {
                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }

                                                                                        var theurl = 'http://192.168.0.85/arduino/digital/8/0';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {




                                                                                            var HttpClient = function() {

                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }
                                                                                            self.bloquearpaletaizquierda();

                                                                                        });

                                                                                    } else {


                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                        erroresexistentes = erroresexistentes.concat("Mesa A no llego a Posición de Carga, Error de Movimiento");

                                                                                        document.getElementById("textoerrores").value = erroresexistentes;
                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
        


                                                                                    }
                                                                                });
                                                                            },2000);






                                                                                freno = 0;


                                                                                //}




                                                                            });


                                                                        }, 7050);



                                                                    });





                                                                });


                                                            });


                                                        }


                                                    })
                                                });



                                            }, 3500);



                                        }

                                    );
                                } else {

                                    // SI ESTA DESBLOQUEADA
                                    // Saca MESA derecha.


                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }


                                    var theurl = 'http://192.168.0.85/arduino/digital/11/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {


                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }


                                        // ACTIVAR LED                                            

                                        var HttpClient = function() {


                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.85/arduino/digital/6/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {});

                                        // ACTIVAR RUN
                                        var theurl = 'http://192.168.0.85/arduino/digital/24/0';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {


                                            // DESACTIVAR FW 

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.85/arduino/digital/8/1';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {


                                                //ESPERAR 1 SEGUNDO LEER FRENO
                                                setTimeout(function() {

                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    // DESACTIVAR RUN
                                                    var theurl = 'http://192.168.0.85/arduino/digital/11/0';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {});

                                                }, 1500)

                                                setTimeout(function() {





                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    var freno = 1;


                                                    var theurl = 'http://192.168.0.82/arduino/digital/39';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D39 set to ");

                                                        response = parseInt(res[1]);

                                                        //if (response == 0) {


                                                        // APAGA RUN
                                                        //DESACTIVA PALETA


                                                        // LEE SI MESA ESTA EN CARGA
                                                        var theurl = 'http://192.168.0.82/arduino/digital/37';
                                                        var client = new HttpClient();

                                                        setTimeout(function(){
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D37 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {
                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                var theurl = 'http://192.168.0.85/arduino/digital/8/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {




                                                                    var HttpClient = function() {

                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }
                                                                    self.bloquearpaletaizquierda();

                                                                });

                                                            } else {


                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                erroresexistentes = erroresexistentes.concat("Mesa A no llego a Posición de Carga, Error de Movimiento");

                                                                document.getElementById("textoerrores").value = erroresexistentes;
                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                


                                                            }
                                                       
                                                       
                                                  
                                                });
                                            },2000);




                                                        freno = 0;


                                                        //}




                                                    });


                                                }, 7050);



                                            });





                                        });


                                    });


                                }











                            });


                        } else {
                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesa A no está en posición Trabajo");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                        }




                    });
                },

                // METERMESAIZQUIERDA
                meterpaletaizquierda: function(evt) {

                    var self = this;

                    var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }
                        // LEER SI MESA ESTA EN CARGA

                    var theurl = 'http://192.168.0.82/arduino/digital/37';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D37 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {


                            // LEER SI ESTA DESBLOQUEADA                               

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }


                            var theurl = 'http://192.168.0.82/arduino/digital/38';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D38 set to ");

                                response = parseInt(res[1]);
                                // SI NO ESTA DESBLOQUEADA.... 
                                if (response == 0) {

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    // ENCIENDE INTERRUPTOR
                                    var theurl = 'http://192.168.0.82/arduino/digital/35/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            // APAGA INTERRUPTOR
                                            var theurl = 'http://192.168.0.82/arduino/digital/35/0';
                                            var client = new HttpClient();



                                            setTimeout(function() {

                                                client.get(theurl, function(response) {

                                                    // Chequea si se desacoplo 
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }


                                                    var theurl = 'http://192.168.0.82/arduino/digital/38';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D38 set to ");

                                                        response = parseInt(res[1]);
                                                        // SI NO ESTA DESBLOQUEADA.... 
                                                        if (response == 0) {

                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                            erroresexistentes = erroresexistentes.concat("Mesa A no se pudo desbloquear, Error de Movimiento.");

                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                            var cmd = "!";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);


                                                        } else {
                                                            setTimeout(function() {

                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                // DESACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/11/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});

                                                            }, 2500)


                                                            // SI ESTA DESBLOQUEADA
                                                            // METE MESA derecha.

                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }


                                                            var theurl = 'http://192.168.0.85/arduino/digital/11/1';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {


                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                // ACTIVAR LED                                            

                                                                var HttpClient = function() {


                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.85/arduino/digital/6/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});


                                                                // ACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/24/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {


                                                                    // ACTIVAR FW 

                                                                    var HttpClient = function() {
                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }

                                                                    var theurl = 'http://192.168.0.85/arduino/digital/8/1';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {


                                                                        //ESPERAR 1 SEGUNDO LEER FRENO
                                                                        setTimeout(function() {

                                                                            var HttpClient = function() {
                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }

                                                                            // DESACTIVAR RUN
                                                                            var theurl = 'http://192.168.0.85/arduino/digital/11/0';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {});

                                                                        }, 1500)

                                                                        setTimeout(function() {





                                                                            var HttpClient = function() {
                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }

                                                                            var freno = 1;


                                                                            var theurl = 'http://192.168.0.82/arduino/digital/39';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var res = response.split("Pin D39 set to ");

                                                                                response = parseInt(res[1]);



                                                                                // APAGA RUN
                                                                                //DESACTIVA PALETA




                                                                                // LEE SI MESA ESTA EN TRABAJO
                                                                                var theurl = 'http://192.168.0.82/arduino/digital/41';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var res = response.split("Pin D41 set to ");

                                                                                    response = parseInt(res[1]);

                                                                                    if (response == 1) {
                                                                                        var HttpClient = function() {
                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }

                                                                                        // ACTIVAR RUN
                                                                                        var theurl = 'http://192.168.0.85/arduino/digital/8/0';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {
                                                                                            var HttpClient = function() {


                                                                                                this.get = function(aUrl, aCallback) {
                                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                            aCallback(anHttpRequest.responseText);
                                                                                                    }
                                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                                    anHttpRequest.send(null);
                                                                                                }
                                                                                            }

                                                                                            self.bloquearpaletaizquierda();
                                                                                        });

                                                                                    } else {
                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                        erroresexistentes = erroresexistentes.concat("Mesa A no llego a posición Trabajo, Error de Movimiento.");

                                                                                        document.getElementById("textoerrores").value = erroresexistentes;
                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                        var cmd = "!";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                                                    }

                                                                                });






                                                                                freno = 0;







                                                                            });


                                                                        }, 7000);



                                                                    });





                                                                });


                                                            });


                                                        }


                                                    })
                                                });



                                            }, 1500);



                                        }

                                    );
                                } else {

                                    // SI ESTA DESBLOQUEADA
                                    // METE MESA derecha.

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }


                                    var theurl = 'http://192.168.0.85/arduino/digital/11/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {


                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }


                                        // ACTIVAR LED                                            

                                        var HttpClient = function() {


                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.85/arduino/digital/6/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {});


                                        // ACTIVAR 
                                        var theurl = 'http://192.168.0.85/arduino/digital/24/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {


                                            // ACTIVAR FW 

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.85/arduino/digital/8/1';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {


                                                setTimeout(function() {

                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    // DESACTIVAR RUN
                                                    var theurl = 'http://192.168.0.85/arduino/digital/11/0';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {});

                                                }, 1500)

                                                setTimeout(function() {





                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    var freno = 1;


                                                    var theurl = 'http://192.168.0.82/arduino/digital/39';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D39 set to ");

                                                        response = parseInt(res[1]);



                                                        // APAGA RUN
                                                        //DESACTIVA PALETA




                                                        // LEE SI MESA ESTA EN TRABAJO
                                                        var theurl = 'http://192.168.0.82/arduino/digital/41';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D41 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {
                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                // ACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/8/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {
                                                                    var HttpClient = function() {


                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }

                                                                    self.bloquearpaletaizquierda();
                                                                });

                                                            } else {
                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                erroresexistentes = erroresexistentes.concat("Mesa A no llego a posición Trabajo, Error de Movimiento.");

                                                                document.getElementById("textoerrores").value = erroresexistentes;
                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                var cmd = "!";
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                            }

                                                        });






                                                        freno = 0;







                                                    });


                                                }, 7000);



                                            });





                                        });


                                    });


                                }











                            });


                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesa A no esta en posición de carga");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                        }
                    });


                },

                /////////////////////////////// MESA DERECHA ENTREGA///////////////////////////////////

                // BLOQUEAR PALETA DERECHA


                bloquearpaletaderecha: function(evt) {
                    var self = this;
                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.83/arduino/digital/42/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }

                        var theurl = 'http://192.168.0.83/arduino/digital/42/1';
                    var client = new HttpClient();
                     
                        client.get(theurl, function(response) {});

                        var theurl = 'http://192.168.0.83/arduino/digital/42/0';
                        var client = new HttpClient();

                        client.get(theurl, function(response) {});


                        var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }


                        var theurl = 'http://192.168.0.83/arduino/digital/29';
                        var client = new HttpClient();
                        client.get(theurl, function(response) {

                            var res = response.split("Pin D29 set to ");

                            response = parseInt(res[1]);

                            if (response == 1) {
                                // SI SE BLOQUEO
                                // http://192.168.0.85/arduino/digital/7/0

                                // APAGAR LED
                                var HttpClient = function() {


                                    this.get = function(aUrl, aCallback) {
                                        var anHttpRequest = new XMLHttpRequest();
                                        anHttpRequest.onreadystatechange = function() {
                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                aCallback(anHttpRequest.responseText);
                                        }
                                        anHttpRequest.open("GET", aUrl, true);
                                        anHttpRequest.send(null);
                                    }
                                }

                                // LEE SI MESA ESTA EN TRABAJO
                                var theurl = 'http://192.168.0.85/arduino/digital/7/0';
                                var client = new HttpClient();
                                client.get(theurl, function(response) {});
                            } else {
                                // SI NO SE BLOQUEO (ERROR)

                                var erroresexistentes = document.getElementById("textoerrores").value;

                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                erroresexistentes = erroresexistentes.concat("Mesas derecha no pudo ser bloqueada, Error de Movimiento");

                                document.getElementById("textoerrores").value = erroresexistentes;
                                document.getElementById("indicadorerrorejec").className = "led-red";
                                var cmd = "!";
                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                            }


                        });
                    });


                },




                // Chequeo posicion trabajo

                checkposiciontrabajo: function(evt) {

                    var HttpClient = function() {


                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN TRABAJO
                    var theurl = 'http://192.168.0.83/arduino/digital/32';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D32 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            return true;
                        } else {

                            return false;
                        }
                    });


                },


                // Chequeo posicion carga

                checkposicioncarga: function(evt) {

                    var HttpClient = function() {

                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN CARGA
                    var theurl = 'http://192.168.0.83/arduino/digital/31';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D31 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {
                            return true;

                        } else {
                            return false;

                        }
                    });



                },


                // SACARMESADERECHA
                sacarpaletaderecha: function(evt) {

                    var self = this;
                    var HttpClient = function() {


                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }

                    // LEE SI MESA ESTA EN TRABAJO
                    var theurl = 'http://192.168.0.83/arduino/digital/32';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D32 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {


                            // LEER SI ESTA DESBLOQUEADA                               

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }


                            var theurl = 'http://192.168.0.83/arduino/digital/30';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D30 set to ");

                                response = parseInt(res[1]);
                                // SI NO ESTA DESBLOQUEADA.... 
                                if (response == 0) {
                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    
                                    var theurl = 'http://192.168.0.83/arduino/digital/42/0';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {});
                                    // ENCIENDE INTERRUPTOR
                                    var theurl = 'http://192.168.0.83/arduino/digital/43/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            // APAGA INTERRUPTOR
                                            var theurl = 'http://192.168.0.83/arduino/digital/43/0';
                                            var client = new HttpClient();



                                            setTimeout(function() {

                                                client.get(theurl, function(response) {

                                                    // Chequea si se desacoplo 
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }


                                                    var theurl = 'http://192.168.0.83/arduino/digital/30';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {



                                                        var res = response.split("Pin D30 set to ");

                                                        response = parseInt(res[1]);
                                                        // SI NO ESTA DESBLOQUEADA.... 
                                                        if (response == 0) {



                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                            erroresexistentes = erroresexistentes.concat("Mesa Y no se pudo desbloquear Error de movimiento");

                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                            var cmd = "!";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                            // INFORMA ERROR Y PARA PROCESO   

                                                        } else {

                                                            // SI ESTA DESBLOQUEADA
                                                            // Saca MESA derecha.

                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }


                                                            var theurl = 'http://192.168.0.85/arduino/digital/12/1';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {


                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }


                                                                // ACTIVAR LED                                            

                                                                var HttpClient = function() {


                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.85/arduino/digital/7/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});






                                                                // ACTIVAR RUNhttp://192.168.0.85/arduino/digital/25/0
                                                                var theurl = 'http://192.168.0.85/arduino/digital/25/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {


                                                                    // DESACTIVAR FW 

                                                                    var HttpClient = function() {
                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }


                                                                    var theurl = 'http://192.168.0.85/arduino/digital/10/1';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {});


                                                                    //ESPERAR 1 SEGUNDO LEER FRENO

                                                                    setTimeout(function() {
                                                                        var HttpClient = function() {
                                                                            this.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }


                                                                        var theurl = 'http://192.168.0.85/arduino/digital/12/0';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {});

                                                                    }, 1000)



                                                                    setTimeout(function() {




                                                                        var HttpClient = function() {
                                                                            this.get = function(aUrl, aCallback) {
                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                        aCallback(anHttpRequest.responseText);
                                                                                }
                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                anHttpRequest.send(null);
                                                                            }
                                                                        }

                                                                        var freno = 1;


                                                                        var theurl = 'http://192.168.0.83/arduino/digital/22';
                                                                        var client = new HttpClient();
                                                                        client.get(theurl, function(response) {

                                                                            var res = response.split("Pin D22 set to ");

                                                                            response = parseInt(res[1]);

                                                                            //if (response == 0) {


                                                                            // APAGA RUN
                                                                            //DESACTIVA PALETA





                                                                            var HttpClient = function() {

                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }

                                                                            // LEE SI MESA ESTA EN CARGA
                                                                            var theurl = 'http://192.168.0.83/arduino/digital/31';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var res = response.split("Pin D31 set to ");

                                                                                response = parseInt(res[1]);

                                                                                if (response == 1) {
                                                                                    var HttpClient = function() {
                                                                                        this.get = function(aUrl, aCallback) {
                                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                    aCallback(anHttpRequest.responseText);
                                                                                            }
                                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                                            anHttpRequest.send(null);
                                                                                        }
                                                                                    }

                                                                                    // DESACTIVAR RUN

                                                                                    var theurl = 'http://192.168.0.85/arduino/digital/10/0';
                                                                                    var client = new HttpClient();
                                                                                    client.get(theurl, function(response) {});

                                                                                    self.bloquearpaletaderecha();

                                                                                } else {



                                                                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                    erroresexistentes = erroresexistentes.concat("Mesa Y no llego a posición de Carga, Error de movimiento");

                                                                                    document.getElementById("textoerrores").value = erroresexistentes;
                                                                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                    


                                                                                }

                                                                            });





                                                                            freno = 0;







                                                                        });


                                                                    }, 8750);



                                                                });





                                                            });





                                                        }


                                                    })
                                                });



                                            }, 2500);



                                        }

                                    );
                                } else {

                                    // SI ESTA DESBLOQUEADA
                                    // Saca MESA derecha.

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }


                                    var theurl = 'http://192.168.0.85/arduino/digital/12/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {


                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }


                                        // ACTIVAR LED                                            

                                        var HttpClient = function() {


                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.85/arduino/digital/7/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {});

                                        // ACTIVAR  http://192.168.0.85/arduino/digital/25/0
                                        var theurl = 'http://192.168.0.85/arduino/digital/25/0';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {


                                            //ACTIVAR RUN

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.85/arduino/digital/10/1';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {});



                                            //ESPERAR 1 SEGUNDO LEER FRENO




                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.85/arduino/digital/12/0';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {});




                                            setTimeout(function() {




                                                var HttpClient = function() {
                                                    this.get = function(aUrl, aCallback) {
                                                        var anHttpRequest = new XMLHttpRequest();
                                                        anHttpRequest.onreadystatechange = function() {
                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                aCallback(anHttpRequest.responseText);
                                                        }
                                                        anHttpRequest.open("GET", aUrl, true);
                                                        anHttpRequest.send(null);
                                                    }
                                                }

                                                var freno = 1;


                                                var theurl = 'http://192.168.0.83/arduino/digital/22';
                                                var client = new HttpClient();
                                                client.get(theurl, function(response) {

                                                    var res = response.split("Pin D22 set to ");

                                                    response = parseInt(res[1]);

                                                    //if (response == 0) {


                                                    // APAGA RUN
                                                    //DESACTIVA PALETA





                                                    var HttpClient = function() {

                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    // LEE SI MESA ESTA EN CARGA
                                                    var theurl = 'http://192.168.0.83/arduino/digital/31';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D31 set to ");

                                                        response = parseInt(res[1]);

                                                        if (response == 1) {
                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }

                                                            // DESACTIVAR RUN

                                                            var theurl = 'http://192.168.0.85/arduino/digital/10/0';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {});

                                                            self.bloquearpaletaderecha();

                                                        } else {



                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                            erroresexistentes = erroresexistentes.concat("Mesa Y no llego a posición de Carga, Error de movimiento");

                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                        


                                                        }

                                                    });





                                                    freno = 0;







                                                });


                                            }, 8750);




                                        });





                                    });





                                }











                            });


                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesa Y no está en posición de trabajo, Error de Movimiento");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                        }

                    });
                },

                // METERMESADERECHA
                meterpaletaderecha: function(evt) {

                    var self = this;

                    var HttpClient = function() {
                            this.get = function(aUrl, aCallback) {
                                var anHttpRequest = new XMLHttpRequest();
                                anHttpRequest.onreadystatechange = function() {
                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                        aCallback(anHttpRequest.responseText);
                                }
                                anHttpRequest.open("GET", aUrl, true);
                                anHttpRequest.send(null);
                            }
                        }
                        // LEER SI MESA NO ESTA EN TRABAJO

                    var theurl = 'http://192.168.0.83/arduino/digital/32';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D32 set to ");

                        response = parseInt(res[1]);

                        if (response == 0) {


                            // LEER SI ESTA DESBLOQUEADA                               

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }


                            var theurl = 'http://192.168.0.83/arduino/digital/30';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D30 set to ");

                                response = parseInt(res[1]);
                                // SI NO ESTA DESBLOQUEADA.... 
                                if (response == 0) {

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }
                                    var theurl = 'http://192.168.0.83/arduino/digital/42/0';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {});
                                    // ENCIENDE INTERRUPTOR
                                    var theurl = 'http://192.168.0.83/arduino/digital/43/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            // APAGA INTERRUPTOR
                                            var theurl = 'http://192.168.0.83/arduino/digital/43/0';
                                            var client = new HttpClient();



                                            setTimeout(function() {

                                                client.get(theurl, function(response) {

                                                    // Chequea si se desacoplo 
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }


                                                    var theurl = 'http://192.168.0.83/arduino/digital/30';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D30 set to ");

                                                        response = parseInt(res[1]);
                                                        // SI NO ESTA DESBLOQUEADA.... 
                                                        if (response == 0) {


                                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                            erroresexistentes = erroresexistentes.concat("Mesa Y no se pudo desbloquear, Error de movimiento");

                                                            document.getElementById("textoerrores").value = erroresexistentes;
                                                            document.getElementById("indicadorerrorejec").className = "led-red";
                                                            var cmd = "!";
                                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);


                                                        } else {

                                                            // SI ESTA DESBLOQUEADA
                                                            // METE MESA derecha.

                                                            var HttpClient = function() {
                                                                this.get = function(aUrl, aCallback) {
                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                    anHttpRequest.onreadystatechange = function() {
                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                            aCallback(anHttpRequest.responseText);
                                                                    }
                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                    anHttpRequest.send(null);
                                                                }
                                                            }


                                                            var theurl = 'http://192.168.0.85/arduino/digital/12/1';
                                                            var client = new HttpClient();
                                                            client.get(theurl, function(response) {


                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                // ACTIVAR LED                                            

                                                                var HttpClient = function() {


                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }
                                                                var theurl = 'http://192.168.0.85/arduino/digital/7/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});


                                                                // ACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/25/1';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {


                                                                    // ACTIVAR FW 

                                                                    var HttpClient = function() {
                                                                        this.get = function(aUrl, aCallback) {
                                                                            var anHttpRequest = new XMLHttpRequest();
                                                                            anHttpRequest.onreadystatechange = function() {
                                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                    aCallback(anHttpRequest.responseText);
                                                                            }
                                                                            anHttpRequest.open("GET", aUrl, true);
                                                                            anHttpRequest.send(null);
                                                                        }
                                                                    }

                                                                    var theurl = 'http://192.168.0.85/arduino/digital/10/1';
                                                                    var client = new HttpClient();
                                                                    client.get(theurl, function(response) {


                                                                        //ESPERAR 1 SEGUNDO LEER FRENO
                                                                        setTimeout(function() {
                                                                            var HttpClient = function() {
                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }


                                                                            var theurl = 'http://192.168.0.85/arduino/digital/12/0';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {});

                                                                        }, 1000);


                                                                        setTimeout(function() {





                                                                            var HttpClient = function() {
                                                                                this.get = function(aUrl, aCallback) {
                                                                                    var anHttpRequest = new XMLHttpRequest();
                                                                                    anHttpRequest.onreadystatechange = function() {
                                                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                            aCallback(anHttpRequest.responseText);
                                                                                    }
                                                                                    anHttpRequest.open("GET", aUrl, true);
                                                                                    anHttpRequest.send(null);
                                                                                }
                                                                            }

                                                                            var freno = 1;

                                                                            var theurl = 'http://192.168.0.83/arduino/digital/22';
                                                                            var client = new HttpClient();
                                                                            client.get(theurl, function(response) {

                                                                                var res = response.split("Pin D22 set to ");

                                                                                response = parseInt(res[1]);




                                                                                // APAGA RUN
                                                                                //DESACTIVA PALETA




                                                                                var HttpClient = function() {


                                                                                    this.get = function(aUrl, aCallback) {
                                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                                        anHttpRequest.onreadystatechange = function() {
                                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                aCallback(anHttpRequest.responseText);
                                                                                        }
                                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                                        anHttpRequest.send(null);
                                                                                    }
                                                                                }

                                                                                // LEE SI MESA ESTA EN TRABAJO
                                                                                var theurl = 'http://192.168.0.83/arduino/digital/32';
                                                                                var client = new HttpClient();
                                                                                client.get(theurl, function(response) {

                                                                                    var res = response.split("Pin D32 set to ");

                                                                                    response = parseInt(res[1]);

                                                                                    if (response == 1) {
                                                                                        var HttpClient = function() {
                                                                                            this.get = function(aUrl, aCallback) {
                                                                                                var anHttpRequest = new XMLHttpRequest();
                                                                                                anHttpRequest.onreadystatechange = function() {
                                                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                                        aCallback(anHttpRequest.responseText);
                                                                                                }
                                                                                                anHttpRequest.open("GET", aUrl, true);
                                                                                                anHttpRequest.send(null);
                                                                                            }
                                                                                        }

                                                                                        // ACTIVAR RUN
                                                                                        var theurl = 'http://192.168.0.85/arduino/digital/10/0';
                                                                                        var client = new HttpClient();
                                                                                        client.get(theurl, function(response) {});

                                                                                        self.bloquearpaletaderecha();

                                                                                    } else {
                                                                                        // ERROR

                                                                                        var erroresexistentes = document.getElementById("textoerrores").value;

                                                                                        erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                                        erroresexistentes = erroresexistentes.concat("Mesa Y no llego a posición de trabajo");

                                                                                        document.getElementById("textoerrores").value = erroresexistentes;
                                                                                        document.getElementById("indicadorerrorejec").className = "led-red";
                                                                                        var cmd = "!";
                                                                                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                                                    }
                                                                                });







                                                                                freno = 0;







                                                                            });


                                                                        }, 7000);



                                                                    });





                                                                });


                                                            });


                                                        }


                                                    })
                                                });



                                            }, 1500);



                                        }

                                    );
                                } else {

                                    // SI ESTA DESBLOQUEADA
                                    // METE MESA derecha.

                                    var HttpClient = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }


                                    var theurl = 'http://192.168.0.85/arduino/digital/12/1';
                                    var client = new HttpClient();
                                    client.get(theurl, function(response) {


                                        var HttpClient = function() {
                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }


                                        // ACTIVAR LED                                            

                                        var HttpClient = function() {


                                            this.get = function(aUrl, aCallback) {
                                                var anHttpRequest = new XMLHttpRequest();
                                                anHttpRequest.onreadystatechange = function() {
                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                        aCallback(anHttpRequest.responseText);
                                                }
                                                anHttpRequest.open("GET", aUrl, true);
                                                anHttpRequest.send(null);
                                            }
                                        }
                                        var theurl = 'http://192.168.0.85/arduino/digital/7/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {});


                                        // ACTIVAR RUN
                                        var theurl = 'http://192.168.0.85/arduino/digital/10/1';
                                        var client = new HttpClient();
                                        client.get(theurl, function(response) {


                                            // ACTIVAR FW 

                                            var HttpClient = function() {
                                                this.get = function(aUrl, aCallback) {
                                                    var anHttpRequest = new XMLHttpRequest();
                                                    anHttpRequest.onreadystatechange = function() {
                                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                            aCallback(anHttpRequest.responseText);
                                                    }
                                                    anHttpRequest.open("GET", aUrl, true);
                                                    anHttpRequest.send(null);
                                                }
                                            }

                                            var theurl = 'http://192.168.0.85/arduino/digital/25/1';
                                            var client = new HttpClient();
                                            client.get(theurl, function(response) {



                                                //ESPERAR 1 SEGUNDO LEER FRENO
                                                setTimeout(function() {
                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }


                                                    var theurl = 'http://192.168.0.85/arduino/digital/12/0';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {});

                                                }, 1000);


                                                setTimeout(function() {





                                                    var HttpClient = function() {
                                                        this.get = function(aUrl, aCallback) {
                                                            var anHttpRequest = new XMLHttpRequest();
                                                            anHttpRequest.onreadystatechange = function() {
                                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                    aCallback(anHttpRequest.responseText);
                                                            }
                                                            anHttpRequest.open("GET", aUrl, true);
                                                            anHttpRequest.send(null);
                                                        }
                                                    }

                                                    var freno = 1;

                                                    var theurl = 'http://192.168.0.83/arduino/digital/22';
                                                    var client = new HttpClient();
                                                    client.get(theurl, function(response) {

                                                        var res = response.split("Pin D22 set to ");

                                                        response = parseInt(res[1]);




                                                        // APAGA RUN
                                                        //DESACTIVA PALETA




                                                        var HttpClient = function() {


                                                            this.get = function(aUrl, aCallback) {
                                                                var anHttpRequest = new XMLHttpRequest();
                                                                anHttpRequest.onreadystatechange = function() {
                                                                    if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                        aCallback(anHttpRequest.responseText);
                                                                }
                                                                anHttpRequest.open("GET", aUrl, true);
                                                                anHttpRequest.send(null);
                                                            }
                                                        }

                                                        // LEE SI MESA ESTA EN TRABAJO
                                                        var theurl = 'http://192.168.0.83/arduino/digital/32';
                                                        var client = new HttpClient();
                                                        client.get(theurl, function(response) {

                                                            var res = response.split("Pin D32 set to ");

                                                            response = parseInt(res[1]);

                                                            if (response == 1) {
                                                                var HttpClient = function() {
                                                                    this.get = function(aUrl, aCallback) {
                                                                        var anHttpRequest = new XMLHttpRequest();
                                                                        anHttpRequest.onreadystatechange = function() {
                                                                            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                                                aCallback(anHttpRequest.responseText);
                                                                        }
                                                                        anHttpRequest.open("GET", aUrl, true);
                                                                        anHttpRequest.send(null);
                                                                    }
                                                                }

                                                                // ACTIVAR RUN
                                                                var theurl = 'http://192.168.0.85/arduino/digital/10/0';
                                                                var client = new HttpClient();
                                                                client.get(theurl, function(response) {});

                                                                self.bloquearpaletaderecha();

                                                            } else {
                                                                // ERROR

                                                                var erroresexistentes = document.getElementById("textoerrores").value;

                                                                erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                                                erroresexistentes = erroresexistentes.concat("Mesa Y no llego a posición de trabajo");

                                                                document.getElementById("textoerrores").value = erroresexistentes;
                                                                document.getElementById("indicadorerrorejec").className = "led-red";
                                                                var cmd = "!";
                                                                chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                                            }
                                                        });







                                                        freno = 0;







                                                    });


                                                }, 7000);




                                            });





                                        });


                                    });


                                }











                            });


                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesa Y no esta en posición de carga. Error de movimiento");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                        }
                    });


                },



                activarM58: function(evt) {

                   

                    // VERIFICAR SI MESA A ESTA AFUERA

                    var self = this;


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.82/arduino/digital/46';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D46 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            //Arduino 8.
                            var theurl = 'http://192.168.0.86/arduino/digital/44';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D44 set to ");

                                response = parseInt(res[1]);

                                if (response == 1) {

                                    self.sacarpaletaizquierda();

                                } else {

                                    // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                    erroresexistentes = erroresexistentes.concat("Mesa A No esta en cero absoluto, Error de Movimiento");

                                    document.getElementById("textoerrores").value = erroresexistentes;
                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                    var cmd = "!";
                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                }
                            });

                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesas se encuentran en modo Gantry, Error de Movimiento");

                            document.getElementById("textoerrores").value = erroresexistentes;

                            var cmd = "!";
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                            // MESA A NO ESTA EN POSICION DE TRABAJO

                        }

                    });

                },


                verificarmesaderechadentro: function(evt) {

                    var cmd = "$3ma=3";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$asn=0";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$asx=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    setTimeout(function() {
                        var cmd = "$2ma=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$ysn=0";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$ysx=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                        setTimeout(function() {

                            var cmd = "$3ma=3";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$asn=0";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$asx=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                
setTimeout(function(){
    var cmd = "$2ma=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$ysn=0";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$ysx=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                            var HttpCliente = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            var elurl = 'http://192.168.0.83/arduino/digital/32';
                            var cliente = new HttpCliente();
                            cliente.get(elurl, function(response) {

                                var res = response.split("Pin D32 set to ");
                                response = parseInt(res[1]);

                                if (response == 1) {

                                    var HttpCliente = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    var elurl = 'http://192.168.0.83/arduino/digital/29';
                                    var cliente = new HttpCliente();
                                    cliente.get(elurl, function(response) {
                                        var res = response.split("Pin D29 set to ");
                                        response = parseInt(res[1]);
                                        if (response == 1) {



                                            document.getElementById("salirpausa").disabled = true;
                                            var cmd = "~";
                                            document.getElementById("salirpausa2").disabled = true;
                                            var cmd = "~";
                                            document.getElementById("salirpausa2").style = " background-color:gray"

                                            document.getElementById("salirpausa").style = " background-color:gray"
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);


                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");




                                        } else {
                                            document.getElementById("indicadorerrorejec").className = "led-red";

                                            var erroresexistentes = document.getElementById("textoerrores").value;

erroresexistentes = erroresexistentes.concat("\\\n\\\n");

erroresexistentes = erroresexistentes.concat("MESA DER NO ESTA EN POSICION DE TRABAJO, LLEVELA A POSICION DE TRABAJO Y LUEGO SALGA DE PAUSA");

document.getElementById("textoerrores").value = erroresexistentes;


                                        }
                                    });


                                } else {
                                    document.getElementById("indicadorerrorejec").className = "led-red";

                                    var erroresexistentes = document.getElementById("textoerrores").value;

erroresexistentes = erroresexistentes.concat("\\\n\\\n");

erroresexistentes = erroresexistentes.concat("MESA DER NO ESTA EN POSICION DE TRABAJO, LLEVELA A POSICION DE TRABAJO Y LUEGO SALGA DE PAUSA");

document.getElementById("textoerrores").value = erroresexistentes;
                                }
                            });
                        },1500)
                        }, 1500);
                    }, 1500)
                },

                verificarmesaizqdentro: function(evt) {

                    var cmd = "$3ma=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$ysn=0";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$ysx=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                    setTimeout(function() {
                        var cmd = "$2ma=3";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$asn=0";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$asx=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                        setTimeout(function() {


                            var cmd = "$3ma=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$ysn=0";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                    var cmd = "$ysx=1";
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);

                    setTimeout(function() {
                        var cmd = "$2ma=3";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$asn=0";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);
                        var cmd = "$asx=1";
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + serialPort + " " + cmd);




                            var HttpCliente = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            var elurl = 'http://192.168.0.82/arduino/digital/41';
                            var cliente = new HttpCliente();
                            cliente.get(elurl, function(response) {

                                var res = response.split("Pin D41 set to ");
                                response = parseInt(res[1]);

                                if (response == 1) {

                                    var HttpCliente = function() {
                                        this.get = function(aUrl, aCallback) {
                                            var anHttpRequest = new XMLHttpRequest();
                                            anHttpRequest.onreadystatechange = function() {
                                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                                    aCallback(anHttpRequest.responseText);
                                            }
                                            anHttpRequest.open("GET", aUrl, true);
                                            anHttpRequest.send(null);
                                        }
                                    }

                                    var elurl = 'http://192.168.0.82/arduino/digital/40';
                                    var cliente = new HttpCliente();
                                    cliente.get(elurl, function(response) {
                                        var res = response.split("Pin D40 set to ");
                                        response = parseInt(res[1]);
                                        if (response == 1) {

                                            document.getElementById("salirpausa").disabled = true;
                                            document.getElementById("salirpausa").style = " background-color:gray"
                                            document.getElementById("salirpausa2").disabled = true;
                                            document.getElementById("salirpausa2").style = " background-color:gray"

                                            var cmd = "~";
                                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf COM3" + " " + cmd);


                                            chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");


                                        } else {
                                            var erroresexistentes = document.getElementById("textoerrores").value;

                                            document.getElementById("indicadorerrorejec").className = "led-red";

erroresexistentes = erroresexistentes.concat("\\\n\\\n");

erroresexistentes = erroresexistentes.concat("MESA IZQ NO ESTA EN POSICION DE TRABAJO, LLEVELA A POSICION DE TRABAJO Y LUEGO SALGA DE PAUSA");

document.getElementById("textoerrores").value = erroresexistentes;

                                        }
                                    });


                                } else {

                                    document.getElementById("indicadorerrorejec").className = "led-red";

                                    var erroresexistentes = document.getElementById("textoerrores").value;

erroresexistentes = erroresexistentes.concat("\\\n\\\n");

erroresexistentes = erroresexistentes.concat("MESA IZQ NO ESTA EN POSICION DE TRABAJO, LLEVELA A POSICION DE TRABAJO Y LUEGO SALGA DE PAUSA");

document.getElementById("textoerrores").value = erroresexistentes;
        }
                            });
                        }, 1500);
                        }, 1500);
                    }, 1500);
                },
                activarM57: function(evt) {

                    // VERIFICAR SI MESA A ESTA AFUERA

                    var self = this;


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.82/arduino/digital/46';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D46 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            //Arduino 8.
                            var theurl = 'http://192.168.0.86/arduino/digital/41';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D41 set to ");

                                response = parseInt(res[1]);

                                if (response == 1) {




                                    self.sacarpaletaderecha();

                                } else {

                                    // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                    erroresexistentes = erroresexistentes.concat("Mesa Y No esta en cero absoluto, Error de Movimiento");

                                    document.getElementById("textoerrores").value = erroresexistentes;

                                    var cmd = "!";
                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                }
                            });

                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesas se encuentran en modo Gantry, Error de Movimiento");

                            document.getElementById("indicadorerrorejec").className = "led-red";
                            document.getElementById("textoerrores").value = erroresexistentes;

                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                            // MESA A NO ESTA EN POSICION DE TRABAJO

                        }

                    });

                },



                activarM67: function(evt) {

                    var self = this;


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.82/arduino/digital/46';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D46 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            //Arduino 8.
                            var theurl = 'http://192.168.0.86/arduino/digital/41';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D41 set to ");

                                response = parseInt(res[1]);

                                if (response == 1) {


                                    self.meterpaletaderecha();

                                } else {

                                    // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                    erroresexistentes = erroresexistentes.concat("Mesa Y No esta en cero absoluto, Error de Movimiento");
                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                    document.getElementById("textoerrores").value = erroresexistentes;

                                    var cmd = "!";
                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                }
                            });

                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesas se encuentran en modo Gantry, Error de Movimiento");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                            // MESA A NO ESTA EN POSICION DE TRABAJO

                        }

                    });

                },


                activarM68: function(evt) {


                    var self = this;




                    // VERIFICAR SI MESA A ESTA AFUERA

                    var self = this;


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }


                    var theurl = 'http://192.168.0.82/arduino/digital/46';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {

                        var res = response.split("Pin D46 set to ");

                        response = parseInt(res[1]);

                        if (response == 1) {

                            var HttpClient = function() {
                                this.get = function(aUrl, aCallback) {
                                    var anHttpRequest = new XMLHttpRequest();
                                    anHttpRequest.onreadystatechange = function() {
                                        if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                            aCallback(anHttpRequest.responseText);
                                    }
                                    anHttpRequest.open("GET", aUrl, true);
                                    anHttpRequest.send(null);
                                }
                            }

                            //Arduino 8.
                            var theurl = 'http://192.168.0.86/arduino/digital/44';
                            var client = new HttpClient();
                            client.get(theurl, function(response) {

                                var res = response.split("Pin D44 set to ");

                                response = parseInt(res[1]);

                                if (response == 1) {


                                    self.meterpaletaizquierda();

                                } else {

                                    // MESA A NO ESTA EN POSICION CERO ABSOLUTO
                                    var erroresexistentes = document.getElementById("textoerrores").value;

                                    erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                                    erroresexistentes = erroresexistentes.concat("Mesa A No esta en cero absoluto, Error de Movimiento");

                                    document.getElementById("textoerrores").value = erroresexistentes;
                                    document.getElementById("indicadorerrorejec").className = "led-red";
                                    var cmd = "!";
                                    chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);

                                }
                            });

                        } else {

                            var erroresexistentes = document.getElementById("textoerrores").value;

                            erroresexistentes = erroresexistentes.concat("\\\n\\\n");

                            erroresexistentes = erroresexistentes.concat("Mesas se encuentran en modo Gantry, Error de Movimiento");

                            document.getElementById("textoerrores").value = erroresexistentes;
                            document.getElementById("indicadorerrorejec").className = "led-red";
                            var cmd = "!";
                            chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", "sendnobuf " + this.serialPort + " " + cmd);
                            // MESA A NO ESTA EN POSICION DE TRABAJO

                        }

                    });

                },




                //Todas brocas
                subirtbrocaBtnClick: function(evt) {

                    ////alert("Subiendo todas las brocas");

                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/subirbrocas/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        document.getElementById("ib1").className = "led-off";
                        document.getElementById("ib2").className = "led-off";
                        document.getElementById("ib3").className = "led-off";
                        document.getElementById("ib4").className = "led-off";
                        document.getElementById("ib5").className = "led-off";
                        document.getElementById("ib6").className = "led-off";
                        document.getElementById("ib7").className = "led-off";
                        document.getElementById("ib8").className = "led-off";
                        document.getElementById("ib9").className = "led-off";
                        document.getElementById("ib10").className = "led-off";
                        document.getElementById("ib11").className = "led-off";
                        document.getElementById("ib12").className = "led-off";
                        document.getElementById("ib13").className = "led-off";
                        document.getElementById("ib14").className = "led-off";
                        document.getElementById("ib15").className = "led-off";
                        document.getElementById("ib16").className = "led-off";

                    });




                },

                bajartbrocaBtnClick: function(evt) {
                    ////alert("Bajando todas las brocas");


                    var HttpClient = function() {
                        this.get = function(aUrl, aCallback) {
                            var anHttpRequest = new XMLHttpRequest();
                            anHttpRequest.onreadystatechange = function() {
                                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                                    aCallback(anHttpRequest.responseText);
                            }
                            anHttpRequest.open("GET", aUrl, true);
                            anHttpRequest.send(null);
                        }
                    }
                    var theurl = 'http://192.168.0.84/arduino/bajarbrocas/1';
                    var client = new HttpClient();
                    client.get(theurl, function(response) {
                        document.getElementById("ib1").className = "led-green";
                        document.getElementById("ib2").className = "led-green";
                        document.getElementById("ib3").className = "led-green";
                        document.getElementById("ib4").className = "led-green";
                        document.getElementById("ib5").className = "led-green";
                        document.getElementById("ib6").className = "led-green";
                        document.getElementById("ib7").className = "led-green";
                        document.getElementById("ib8").className = "led-green";
                        document.getElementById("ib9").className = "led-green";
                        document.getElementById("ib10").className = "led-green";
                        document.getElementById("ib11").className = "led-green";
                        document.getElementById("ib12").className = "led-green";
                        document.getElementById("ib13").className = "led-green";
                        document.getElementById("ib14").className = "led-green";
                        document.getElementById("ib15").className = "led-green";
                        document.getElementById("ib16").className = "led-green";

                    });



                },





                // linenum is 1-based since visually gcode starts at line 1, this.fileLines is 0-based
                // so don't forget
                updateRowQueueStats: function(linenum) {


                    var linea = this.fileLines[linenum - 1];


                    // We will update the checkmark based on the underlying meta data for
                    // the line. Lines are stored in this.fileLines and meta data is in
                    // this.metaLines. They have equal indexes.

                    // linenum is 1-based (not 0-based) since table is 1-based
                    if (linenum < this.showingStartIndex || linenum > this.showingEndIndex) {
                        // this means the line is not showing, so exit here
                        //console.log("We are being asked to update the checkmark to show queue status for a line that does not exist so exiting. linenum:", linenum);
                        //this.jumpToLine(linenum);
                        return;
                    }

                    var container = $('#com-chilipeppr-widget-gcode-body');
                    // figure out correct index from this.showingStartIndex and linenum
                    var indx = linenum - this.showingStartIndex;
                    var tr = $('#com-chilipeppr-widget-gcode-tbl tbody tr').eq(indx);

                    // now that we have our correct row, update color of checkmark
                    this.updateRowQueueStatsEl(tr);

                },
                // pass in the row element as jquery obj
                updateRowQueueStatsEl: function(rowEl) {
                    // We will update the checkmark based on the underlying meta data for
                    // the line. Lines are stored in this.fileLines and meta data is in
                    // this.metaLines. They have equal indexes.

                    //console.group("gcode widget - updateRowQueueStatsEl");
                    // get index for this rowEl
                    var indx = rowEl.find('.indx').text();
                    //console.log("row index to update stats for:", indx, "rowEl:", rowEl);

                    // get meta data
                    var meta = this.metaLines[indx - 1];

                    if (meta != null) {

                        //console.log("meta was not null for this row, so updating checkmark colors. meta:", meta);
                        // get checkmark dom el
                        var check = rowEl.find('.glyphicon-ok');

                        // since we could get these events in differing order, normalize
                        // here such that meta.isCompleted has priority over earlier events
                        if (!meta.isSent && !meta.isQueued && !meta.isWritten && !meta.isCompleted)
                            check.css('color', '#dddddd').parent().css('background-color', 'none');
                        if (meta.isSent && !meta.isQueued && !meta.isWritten && !meta.isCompleted)
                            check.css('color', '#E6D8BB').parent().css('background-color', '#fcf8e3');
                        if (meta.isQueued && !meta.isWritten && !meta.isCompleted)
                            check.css('color', '#BED0D9').parent().css('background-color', '#d9edf7');
                        if (meta.isWritten && !meta.isCompleted)
                            check.css('color', '#BBCCAD').parent().css('background-color', '#dff0d8');
                        if (meta.isCompleted)
                            check.css('color', 'black').parent().css('background-color', 'none');
                        if (meta.isError)
                            check.css('color', 'black').parent().css('background-color', 'pink');
                        if (meta.isExecuted)
                            check.css('color', 'black').parent().css('background-color', 'silver');

                    }

                    //console.groupEnd();

                },
                prependRows: function(endIndx) {

                    var startIndx = endIndx - this.linesToShow;
                    if (startIndx < 1) startIndx = 1;
                    console.log("prependRows. startIndex:", startIndx, "endIndx:", endIndx);
                    if (endIndx < 1) endIndx = 1;

                    this.showingStartIndex = startIndx;
                    //this.showingEndIndex = endIndx;

                    // since we're adding rows, we have to destroy waypoints or things
                    // get whacky when DOM changes
                    this.infiniteScrollDestroy();

                    // ok, now that we know our global start and end
                    // figure out if we have too many rows showing
                    if (this.showingEndIndex - this.showingStartIndex > this.linesToShowMax) {
                        console.log("we are showing too many lines. will truncate at bottom");
                        this.removeRowsFromEnd();
                    }

                    this.showingStats();

                    for (var indxCtr = endIndx; indxCtr >= startIndx; indxCtr--) {

                        var line = this.fileLines[indxCtr - 1];
                        line = this.getFeedrateMarkup(line);
                        line = this.getCommentMarkup(line);
                        var cls = "g";
                        var newTrDom = $(
                            "<tr>" +
                            '<td><span class="glyphicon glyphicon-ok"/></td>' +
                            "<td class=\"indx\">" + indxCtr + "</td>" +
                            "<td class=\"" + cls + "\">" + line + "</td>" +
                            '<td class="gtools"></td>' +
                            "</tr>");
                        $('#com-chilipeppr-widget-gcode-tbl > tbody').prepend(newTrDom);

                        //console.log("newTrDom:", newTrDom);
                        // update the checkmark based on meta data of this line
                        this.updateRowQueueStatsEl(newTrDom);

                    }

                    var that = this;
                    setTimeout(function() {
                        that.setupInfiniteScroll(true);
                    }, 100);


                },
                appendRows: function(startIndx, skipWaypoint) {

                    var endIndx = startIndx + this.linesToShow - 1;
                    if (endIndx > this.fileLines.length) endIndx = this.fileLines.length;

                    if (this.showingStartIndex == 0) this.showingStartIndex = startIndx;
                    this.showingEndIndex = endIndx;

                    // since we're adding rows, we have to destroy waypoints or things
                    // get whacky when DOM changes
                    this.infiniteScrollDestroy();

                    // ok, now that we know our global start and end
                    // figure out if we have too many rows showing
                    if (this.showingEndIndex - this.showingStartIndex > this.linesToShowMax) {
                        console.log("we are showing too many lines. will truncate at top");
                        this.removeRowsFromStart();
                    }

                    this.showingStats();

                    for (var indxCtr = startIndx; indxCtr <= endIndx; indxCtr++) {

                        var line = this.fileLines[indxCtr - 1];
                        line = this.getFeedrateMarkup(line);
                        line = this.getCommentMarkup(line);
                        var cls = "g";
                        var newTrDom = $(
                            "<tr>" +
                            '<td><span class="glyphicon glyphicon-ok"/></td>' +
                            "<td class=\"indx\">" + indxCtr + "</td>" +
                            "<td class=\"" + cls + "\">" + line + "</td>" +
                            '<td class="gtools"></td>' +
                            "</tr>");
                        $('#com-chilipeppr-widget-gcode-tbl > tbody').append(newTrDom);

                        // update the checkmark based on meta data of this line
                        this.updateRowQueueStatsEl(newTrDom);

                        //console.log("newTrDom:", newTrDom);
                    }

                    if (!skipWaypoint) setTimeout(this.setupInfiniteScroll.bind(this), 100);
                },
                removeAllRows: function() {
                    $('#com-chilipeppr-widget-gcode-tbl > tbody > tr').remove();
                    this.showingStartIndex = 0;
                    this.showingEndIndex = 0;
                },
                removeRowsFromStart: function() {
                    console.log("removing rows from start.", this.linesToShow);
                    $('#com-chilipeppr-widget-gcode-tbl > tbody > tr:lt(' + (this.linesToShow) + ")").remove();
                    this.showingStartIndex = this.showingStartIndex + this.linesToShow;
                },
                removeRowsFromEnd: function() {
                    console.log("removing rows from end.", this.linesToShow);
                    $('#com-chilipeppr-widget-gcode-tbl > tbody > tr:gt(' + (this.showingEndIndex - this.linesToShow) + ")").remove();
                    this.showingEndIndex = this.showingEndIndex - this.linesToShow;
                },
                feedrateEl: null,
                getFeedrateMarkup: function(html, isJustGettingRaw) {
                    //console.log("getFeedrateMarkup");
                    if (html === undefined) {
                        //console.log("html was undefined. huh? ", html);
                        return;
                    }
                    // lazy cache the dom el cuz this is slow
                    if (this.feedrateEl == null) this.feedrateEl = $('#com-chilipeppr-widget-gcode-feedrate-val');
                    var frdom = this.feedrateEl;
                    var val = parseFloat(frdom.val());
                    if (val == 1.0) return html;
                    var origline = html;
                    var curF = origline.match(/(F)(\d+\.{0,1}\d*)/gi);
                    if (curF) {
                        //console.log("origline:", origline, "curF:", curF);
                        //console.log("original file line:", origline);
                        for (var i = 0; i < curF.length; i++) {
                            var item = curF[i];
                            var fval = parseFloat(item.replace(/F/i, ""));
                            //console.log("fval:", fval);
                            fval = val * fval;
                            //console.log("new fval:", fval);
                            if (isJustGettingRaw == true) {
                                origline = origline.replace(item, "F" + fval.toFixed(2) + "");
                            } else {
                                origline = origline.replace(item, "<span class=\"feedrate-adjust\">F" + fval.toFixed(2) + "</span>");
                            }
                        }
                        //tdDom.html(origline);
                    }
                    return origline;
                },
                getCommentMarkup: function(html) {
                    // check if comment, fade it out
                    //console.log("getCommentMarkup. html:", html);
                    if (html !== undefined && html.match(/\(.*\)|;/)) {
                        console.log("got comments match");



                        // ok, just swap a span around comment
                        html = html.replace(/(\(.*?\))/, '<span class="gcode-comment">$1</span>');
                        html = html.replace(/(;.*)/, '<span class="gcode-comment">$1</span>');
                        // also break really long words with no spaces so don't get rendering artifacts

                    }
                    return html;
                },
                getTooltipMarkup: function(txt) {
                    // see if gcode matches a dictionary of gcode definitions
                    // and swap in a popup to explain the defintion
                    if (txt === undefined) {
                        //console.error("txt was undefined. huh?");
                        return;
                    }

                    //console.log("applying tooltip");
                    var outtxt = "";
                    var tokensout = [];

                    // remove comments (put them back later)
                    //txt = txt.replace(/(<span class="gcode-comment".*?<\/span>)/, "");
                    //var comment = RegExp.$1;
                    //console.log("comment:", comment);

                    txt = txt.replace(/(\(.*\))/, "");
                    var comment = RegExp.$1;
                    //console.log("comment:", comment);

                    // for gcode without spaces, add it so we can parse into tokens
                    txt = txt.replace(/([gmxyzf])/gi, " $1");

                    var tokens = txt.split(/\s+/);
                    //console.log("tokens:", tokens);
                    var that = this;
                    $.each(tokens, function(index, gci) {

                        //console.log("working on token: " + gci);
                        var outgci = "";
                        var isFound = false;
                        // check that it's a G or M in gci, or else move on
                        if (gci.match(/^(M|G|%)/i)) {
                            //console.log("looks like we got an M or G", gci);
                            $.each(that.gcodeData, function(i, elem) {
                                //console.log("trying to see if this token: " + gci + " == gcode: " + elem.code);
                                //console.log(elem.re);
                                //outgci = "";
                                var m = elem.re.exec(gci);
                                //if (!isFound && gci.match(elem.re)) {
                                if (!isFound && m != null) {
                                    //if (m != null) {
                                    //console.log("found a match. gci: " + gci);
                                    outgci = gci.replace(
                                        elem.re,
                                        '<span class="com-chilipeppr-gcode-tip" data-toggle="popover" data-title="' + elem.desc + '" data-content="' + elem.info + ' <br/><br/>Source: Wikipedia">' + m[0] + '</span>');


                                    //return;
                                    isFound = true;
                                }
                            });
                        }
                        if (isFound) {
                            //console.log("found a match so using outgci: " + outgci);
                            tokensout.push(outgci + "");
                        } else {
                            //console.log("did not find match, so just using non-swapped gcode: " + gci);
                            tokensout.push(gci);
                        }

                    });
                    //console.log("final markup. tokensout[]:", tokensout);
                    var finalstr = tokensout.join(" ");
                    finalstr += comment;
                    return finalstr;
                    //return  + "<span class=\"gcode-comment\">" + comment + "</span>";
                },
                lastElemIndex: null,
                cleanupHilites: function() {
                    //console.log("cleanupHilites called.");

                    var that = this;
                    $('.com-chilipeppr-gcode-tip').each(function(i, elem) {
                        var el = $(elem);
                        var elp = $(el.context.parentNode);
                        //console.log(el);
                        //console.log(elp);

                        // instead of doing cleanup, let's just rebuild from scratch
                        //that.cleanupDomElem(elp);
                        // get indx
                        var indx = elp.parent().children('.indx').text();
                        indx = parseInt(indx);
                        var gcode = that.fileLines[indx - 1];
                        gcode = that.getFeedrateMarkup(gcode);
                        gcode = that.getCommentMarkup(gcode);

                        elp.html(gcode);
                        //that.parseGcodeForDomElem(elp, false);

                        /*
                         elp.html(elp.text());
                         // check if comment, fade it out
                         if (elp.text().match(/\(.*\)/)) {
                         elp.html(elp.text().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                         }
                         */
                        //that.parseGcodeForDomElem(elp, false);
                    });
                },
                cleanupDomElem: function(elem) {

                    console.log("cleanupDomElem:", elem);
                    var elems = elem.children(".com-chilipeppr-gcode-tip");
                    console.log("elements to cleanup:", elems);

                    //elem.children(".com-chilipeppr-gcode-tip").contents().unwrap();
                    //elem.children(".com-chilipeppr-gcode-tip").remove();

                    //elem.html(elem.text());
                    // check if comment, fade it out
                    /*
                     if (elem.text().match(/\(.*\)/)) {
                     elem.html(elem.text().replace(/(\(.*\))/g, '<span class="gcode-comment">$1</span>'));
                     }
                     */
                },
                parseGcodeForDomElem: function(elem, doTooltip) {

                    //console.log("inside parseGcodeForDomElem. lastRowIndex:", this.lastElemIndex, " curElemRowIndex:",  elem.context.rowIndex);
                    //console.log("elem:", elem);
                    // if we just got called again on same row due to mouseover causing multiple
                    // events, then just exit
                    if (this.lastElemIndex && this.lastElemIndex == elem.context.rowIndex) {
                        //console.log("lastElem = elem. exiting.");
                        return;
                    }

                    // cleanup other rows when we are rendering markup for a new row
                    this.cleanupHilites();

                    //$(".com-chilipeppr-widget-gcode .popover").remove();
                    if (doTooltip) {
                        // get original line
                        var indx = elem.parent().children('.indx').text();
                        indx = parseInt(indx);
                        var gcode = this.fileLines[indx - 1];

                        var newhtml = this.getTooltipMarkup(gcode);
                        //console.log("newhtml for td.g", newhtml);
                        //newhtml = that.getFeedrateMarkup(newhtml);
                        //newhtml = this.getCommentMarkup(newhtml);
                        //console.log("newhtml after comments", newhtml);

                        //this.cleanupHilites();

                        // check if comment, fade it out
                        //if (elem.text().match(/\(.*\)/)) {
                        //    elem.html(elem.html().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                        //}

                        // see if we can add tooltips
                        //this.cleanupDomElem(elem);
                        //var newhtml = (this.getTooltipMarkup(elem.html()));
                        // re-add feedrate and comment
                        //newhtml = this.getFeedrateMarkup(newhtml);
                        //newhtml = this.getCommentMarkup(newhtml);
                        elem.html(newhtml);

                        //console.log("elem after tooltips:", elem);

                        //console.log($this.html());
                        // turn on the popovers
                        elem.find('span').popover({
                            animation: true,
                            html: true,
                            placement: 'auto left',
                            trigger: 'hover',
                            delay: {
                                show: 20,
                                hide: 20
                            },
                            container: elem
                        });
                    }

                    // always append a span tip to trigger a cleanup
                    elem.append(' <span class="com-chilipeppr-gcode-tip hidden"></span>');

                    this.lastElemIndex = elem.context.rowIndex;
                },
                parseGcode: function() {
                    // this method attaches tooltips to gcode
                    // to help you understand what each cmd does
                    //console.log("Parsing Gcode...");
                    var that = this;
                    console.log(that);
                    $('#com-chilipeppr-widget-gcode-tbl .g').each(function(i, td) {
                        $this = $(this);
                        //console.log($this.text());

                        // do per dom element call
                        //that.parseGcodeForDomElem($this);

                        // check if comment, fade it out
                        if ($this.text().match(/\(.*\)/)) {
                            $this.html($this.text().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                            //$this.html('<span class="gcode-comment">' + $this.text() + '</span>');
                        }
                    });
                },
                createGcodeDesc: function() {

                    $.each(this.gcodeData, function(i, elem) {

                        elem.re = new RegExp("^(" + elem.code + ")$", "i");

                        // collapse leading zeroes
                        if (elem.code.match(/(G|M)0{1,}/i)) {
                            var code_collapsed = elem.code.replace(/(G|M)0{1,}/i, "$1");
                            if (code_collapsed == "G") code_collapsed = "G0";
                            if (code_collapsed == "G00") code_collapsed = "G0";
                            if (code_collapsed == "M") code_collapsed = "M0";
                            if (code_collapsed == "M00") code_collapsed = "M0";
                            elem.re2 = new RegExp(code_collapsed, "ig");
                            elem.code2 = code_collapsed;
                            elem.re = new RegExp("^(" + elem.code + "|" + elem.code2 + ")$", "i");
                        }


                        if (elem.desc) {

                            elem.desc = elem.desc.replace(/\<.*?\>/g, '');

                            elem.desc = elem.desc.replace(/"/g, '&quot;');
                        }
                        if (elem.info) {
                            elem.info = elem.info.replace(/\<.*?\>/g, '');

                            elem.info = elem.info.replace(/"/g, '&quot;');
                        }

                    });

                },
                gcodeIsLoaded: false,
                gcodeData: [],
                gcodeLoad: function(callback, context) {
                    var that = this;


                    cprequire(["inline:com-chilipeppr-elem-gcodedata"], function(gcd) {
                        console.log("in callback from chilipeppr.load() for gcodedata");
                        that.gcodeIsLoaded = true;
                        that.gcodeData = gcd.gcode;
                        that.createGcodeDesc();
                        if (callback) callback.apply(context, gcd);
                    });

                },
                obj3d: null, // gets the 3dviewer obj stored in here on callback
                obj3dmeta: null, // gets metadata for 3dviewer
                userCallbackForGet3dObj: null,
                get3dObj: function(callback) {
                    this.userCallbackForGet3dObj = callback;
                    chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this, this.get3dObjCallback);
                    chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", this.get3dObjCallback);
                },
                get3dObjCallback: function(data, meta) {
                    console.log("got 3d obj:", data, meta);
                    this.obj3d = data;
                    this.obj3dmeta = meta;
                    if (this.userCallbackForGet3dObj) {
                        this.userCallbackForGet3dObj();
                        this.userCallbackForGet3dObj = null;
                    }
                },
                calcEstimatedRemain: function(indexOfLineAt) {
                    if (this.obj3d && this.obj3d.userData && this.obj3d.userData.lines) {
                        var lastLine = this.obj3d.userData.lines[this.obj3d.userData.lines.length - 1];
                        if ('p2' in lastLine && 'timeMinsSum' in lastLine.p2) {
                            console.log("we got a timeMinsSum:", lastLine.p2.timeMinsSum);
                            var curEstDurMins = this.obj3d.userData.lines[indexOfLineAt].p2.timeMinsSum;
                            var estDurMins = lastLine.p2.timeMinsSum;
                            var remainMins = estDurMins - curEstDurMins;
                            var str = "-";
                            if (remainMins > 0) {
                                str = this.toHHMMSS(remainMins * 60); // expect seconds
                            }
                            $('#com-chilipeppr-widget-gcodeviewer #gcode-time-estremain').text(str);
                        }
                    }
                }
            }
        });
    </script>

</head>

<body>


    <div id="com-chilipeppr-widget-gcodeviewer" class="panel panel-default com-chilipeppr-widget-gcode ">
        <div class="panel-heading">

            <div class="" style="padding-bottom:10;"><span class="panel-title">Nycode</span></div>

            <div class="btn-toolbar" role="toolbar" style="position:absolute;right:0px;top:0px;padding:10px 15px;">
                <div class="btn-group plannerpause" data-toggle="popover" data-content="This indicator shows that we're being asked to pause our sending of commands to the CNC controller so we don't overfill the buffer.">
                    <span disabled="true" class="plannerpauseindicator glyphicon glyphicon glyphicon-time btn btn-sm"></span>
                </div>
                <div class="btn-group" style="margin-left:0px;">
                    <button type="button" id="com-chilipeppr-widget-gcode-play" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-play"></span>

                    </button>
                    <button type="button" id="com-chilipeppr-widget-gcode-pause" disabled class="btn btn-default btn-xs"><span class="glyphicon glyphicon-pause"></span>

                    </button>
                    <button type="button" id="com-chilipeppr-widget-gcode-stop" disabled class="btn btn-default btn-xs"><span class="glyphicon glyphicon-stop"></span>

                    </button>
                    <button type="button" id="com-chilipeppr-widget-gcode-stepback" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-step-backward"></span>

                    </button>
                    <button type="button" id="com-chilipeppr-widget-gcode-stepfwd" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-step-forward"></span></button>
                    <button type="button" id="com-chilipeppr-widget-gcode-jumptoline" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-plane"></span></button>

                    <button type="button" id="com-chilipeppr-widget-gcode-btnoptions" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-cog"></span></button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-xs btn-default hidebody"><span class="glyphicon glyphicon-chevron-up"></span></button>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown"> <span class="caret"></span>

                    </button>
                    <ul class="dropdown-menu dropdown-menu-right pubsub-dropdown-menu" role="menu">
                    </ul>
                </div>
            </div>
            <div>
                <button type="button" id="" style="display: none;" class="btn btn-default btn-xs com-chilipeppr-widget-gcode-showfr">
                    Feed Rate Override
                </button>
                <div class="btn-group">
                    <button type="button" id="" style="display: none;" class="btn btn-default btn-xs dropdown-toggle com-chilipeppr-widget-gcode-btnToolChange" data-toggle="dropdown"> 
                        Tool Changes
                        <span class="caret"></span>
                    </button>
                    <button type="button" id="salirpausa" style="background-color:gray" disabled> 
                        SALIR DE PAUSA 1
                    </button>
                    <button type="button" id="salirpausa2" style="background-color:gray" disabled> 
                        SALIR DE PAUSA 2
                    </button>
                    <ul class="dropdown-menu xdropdown-menu-right com-chilipeppr-widget-gcode-menuToolChange" role="menu">
                        <li role="presentation" class="dropdown-header com-chilipeppr-widget-gcode-toolchanges-hdr">(No Tool Changes in Gcode)</li>
                    </ul>
                </div>

            </div>
            <div id="com-chilipeppr-widget-gcode-feedrate" class="hidden" style="padding-top:5px;overflow:hidden;display: none;">
                <div class="input-group input-group-sm" style=" "> <span class="input-group-btn ">
                <button class="btn btn-default btn-xs" id="com-chilipeppr-widget-gcode-feedrate-adjust" type="button">Feedrate X</button></span>

                    <input id="com-chilipeppr-widget-gcode-feedrate-val" class="form-control" type="number" value="1.00" /> <span class="input-group-btn ">
                <button class="btn btn-default  btn-xs" id="com-chilipeppr-widget-gcode-feedrate-up" type="button"><span class="glyphicon glyphicon-arrow-up btn-xs "></span></button>
                    <button class="btn btn-default  btn-xs" id="com-chilipeppr-widget-gcode-feedrate-down" type="button"><span class="glyphicon glyphicon-arrow-down btn-xs"></span>

                    </button>
                    <button class="btn btn-default btn-xs" id="com-chilipeppr-widget-gcode-feedrate-reset" type="button">Reset</button>
                    </span>
                </div>
            </div>

        </div>
        <div class="alert alert-info alert-dismissible com-chilipeppr-widget-gcode-toolchange hidden" role="alert" style="margin:0;border-radius:0;">
            <button type="button" class="close" xdata-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <p style="font-size:smaller;padding-bottom:6px;">You are in tool change mode. Change to tool <b><span id="com-chilipeppr-widget-gcode-toolnumber1">T??</span></b>. You may jog to move the tool around and/or reset your Z zero position. Put your motors at full power if you don't want them to
                move while you change your tool. Make sure to issue the following Gcode to get back to the position just prior to your tool change "<span class="com-chilipeppr-widget-gcode-toolchange-reposition1">G0 X? Y? Z?</span>".
            </p>
            <div class="btn-group-vertical">
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-energize" xstyle="width:100%;">Motors Full Power</button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-unenergize" xstyle="width:100%;">Motors Previous Setting <span class="com-chilipeppr-widget-gcode-toolchange-motorsprev"></span></button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-spindlestop" xstyle="width:100%;">Stop Spindle (M5)</button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-spindlestart" xstyle="width:100%;">Start Spindle (M3)</button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-probe" xstyle="width:100%;">Run Probe Command</button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-g43" xstyle="width:100%;">Send "<span id="com-chilipeppr-widget-gcode-g43-cmd">G43 T-</span>"</button>
                <button class="btn btn-xs btn-default com-chilipeppr-widget-gcode-toolchange-sendgcode" xstyle="width:100%;">Send Reposition "<span class="com-chilipeppr-widget-gcode-toolchange-reposition2">G0 X- Y- Z-</span>"</button>
            </div>
        </div>
        <div id="com-chilipeppr-widget-gcode-body-wrapper">
            <!-- Need 2 col layout to get jumpscroller on right full height -->
            <table id="com-chilipeppr-widget-gcode-body-2col" xstyle="position:relative;">
                <tr>
                    <td class="com-chilipeppr-gcode-jumpscroll" style="border:0px solid red;position:relative;width:21px;">
                        <!--<div class="com-chilipeppr-gcode-jumpscroll" style="position:absolute;width:25px; top:0; height:100%; border:1px solid green;">-->
                        <div class="paginator" style="top:10%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:20%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:30%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:40%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:50%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:60%;">
                            <button type="button" class="btn btn-xs btn-default "> <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:70%;">
                            <button type="button" class="btn btn-xs btn-default "><span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator" style="top:80%;">
                            <button type="button" class="btn btn-xs btn-default "><span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                        <div class="paginator paginator-first">
                            <button type="button" class="btn btn-xs btn-default "><span class="glyphicon glyphicon-chevron-up"></span>
                            </button>
                        </div>
                        <div class="paginator paginator-last">
                            <button type="button" class="btn btn-xs btn-default "><span class="glyphicon glyphicon-chevron-down"></span>
                            </button>
                        </div>
                        <!--</div>-->
                    </td>
                    <td>
                        <div id="com-chilipeppr-widget-gcode-body" class="panel-body ">
                            <div id="com-chilipeppr-elem-gcodedata"></div>
                            <div id="dragdrop" class="hidden"></div>
                            <div id="com-chilipeppr-widget-gcode-tmparea" class="hidden"></div>
                            <div id="showstart">
                                <button class="btn btn-default btn-xs" style="width:100%;margin-bottom:0;"><span class="glyphicon glyphicon-chevron-up"></span></button>
                            </div>
                            <table id="com-chilipeppr-widget-gcode-tbl" class="table table-condensed" xstyle="width:100%;">
                                <thead>
                                    <tr>
                                        <th colspan="3" style="border:0;padding:0;margin:0">
                                            <div style="height:0px;">
                                                <!--This makes sure the table width is the full width of the container-->&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="glyphicon glyphicon-ok " style="color:black" />
                                        </td>
                                        <td>1</td>
                                        <td class="g">(Made using xxxx G90 )</td>
                                    </tr>
                                    <tr>
                                        <td><span class="glyphicon glyphicon-ok " />
                                        </td>
                                        <td>2</td>
                                        <td class="g "><span title="Go to absolute mode ">G21</span> G90 G64 G40</td>
                                    </tr>
                                    <tr>
                                        <td><span class="glyphicon glyphicon-ok " />
                                        </td>
                                        <td>3</td>
                                        <td class="g">(laser off)</td>
                                    </tr>
                                    <tr>
                                        <td><span class="glyphicon glyphicon-ok " />
                                        </td>
                                        <td>4</td>
                                        <td class="g">M3</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div id="showend">
                                <button class="btn btn-default btn-xs" style="width:100%;margin-bottom:0;"><span class="glyphicon glyphicon-chevron-down"></span></button>
                            </div>
                        </div>
                    </td>

                </tr>
            </table>
        </div>
        <!-- body wrapper com-chilipeppr-widget-gcode-body-wrapper -->
        <div id="com-chilipeppr-widget-gcode-footer" class="panel-footer " style="position:relative;">
            <div class="row ">
                <div class="col-xs-12 stats-hdr" style="margin-bottom:5px;" data-toggle="popover" data-container="body" data-placement="auto top" data-trigger="hover click" data-delay="500" data-html="true" data-title="Explaining Status Steps"><span class="glyphicon glyphicon-ok gcode-sent"></span> Sent <span class="glyphicon glyphicon-ok gcode-queued"></span> Queued <span class="glyphicon glyphicon-ok gcode-written"></span> Written <span class="glyphicon glyphicon-ok gcode-completed"></span>                    Completed <span class="glyphicon glyphicon-ok gcode-executed"></span> Executed
                    <!-- <span class="glyphicon glyphicon-ok gcode-error"></span> Error/Unsupported Command --></div>
            </div>
            <div class="row ">
                <div class="col-xs-3 stats-hdr ">Lines</div>
                <div class="col-xs-3 stats-hdr ">Showing</div>
                <div class="col-xs-3 stats-hdr ">Sent</div>
                <div class="col-xs-3 stats-hdr ">To Be Sent</div>
            </div>
            <div class="row ">
                <div id="gcode-lines" class="col-xs-3 stats-val">256,340</div>
                <div id="gcode-lines-showing" class="col-xs-3 stats-val">0</div>
                <div id="gcode-lines-sent" class="col-xs-3 stats-val">0</div>
                <div id="gcode-lines-remaining" class="col-xs-3 stats-val">256,340</div>
            </div>
            <div class="row " style="padding-top:10px;">
                <div class="col-xs-3 stats-hdr ">Time Start</div>
                <div class="col-xs-3 stats-hdr ">Est Time</div>
                <div class="col-xs-3 stats-hdr ">Est Remain</div>
                <div class="col-xs-3 stats-hdr ">Duration</div>
            </div>
            <div class="row ">
                <div id="gcode-time-start" class="col-xs-3 stats-val">-</div>
                <div id="gcode-time-est" class="col-xs-3 stats-val">-</div>
                <div id="gcode-time-estremain" class="col-xs-3 stats-val">-</div>
                <div id="gcode-time-dur" class="col-xs-3 stats-val">-</div>

            </div>

        </div>
        <div class="alert alert-info com-chilipeppr-widget-gcode-startindicator hidden" style="position:absolute;left:0;right:0;bottom:0;margin-bottom:0;">
            Starting play. Seeing if other widgets need to process anything...
        </div>
    </div>
    <div class="modal fade " id="com-chilipeppr-widget-gcode-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Gcode Sender Options</h4>
                </div>
                <div class="modal-body">

                    <form class="form-horizontal" role="form">
                        <p>The Gcode Sender widget will send a command to the serial port by default. You can optionally have it send the command to the 3D Viewer to have it move the toolhead in a simulation run. If you are going to run a real CNC job make
                            sure to send the commands to the serial port.</p>
                        <!-- <h4>Send Gcode Commands To</h4> -->
                        <p class="options-heading">When Playing <span class="glyphicon glyphicon-play"></span> or Stepping <span class="glyphicon glyphicon-step-backward"></span><span class="glyphicon glyphicon-step-forward"></span> Send Gcode Commands To</p>

                        <div class="form-group">
                            <div class="col-sm-10">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpWhenPlay" id="com-chilipeppr-widget-gcode-option-whenplay-serial" value="serial" checked="true"> Serial Port (Default)</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpWhenPlay" id="com-chilipeppr-widget-gcode-option-whenplay-3d" value="3d"> 3D Viewer</input>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p class="options-heading">When Clicking A Gcode Row
                            <!-- <span class="callout" style="border:1px solid black;border-radius:4px;"><span class="glyphicon glyphicon-ok" style="color:gray"></span>&nbsp; 7 &nbsp;N7 G0 Z4.000 </span> -->Send Gcode Commands To</p>

                        <div class="form-group">
                            <div class="col-sm-10">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpPerRow" id="com-chilipeppr-widget-gcode-option-perrow-serial" value="serial"> Serial Port</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpPerRow" id="com-chilipeppr-widget-gcode-option-perrow-3d" value="3d" checked> 3D Viewer (Default)</input>
                                    </label>
                                </div>
                                <div style="padding-left:30px;">
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="grpPerRow3dType" id="com-chilipeppr-widget-gcode-option-perrow-3d-goto" value="goto" checked> Just go to XYZA Position (Default)</input>
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="grpPerRow3dType" id="com-chilipeppr-widget-gcode-option-perrow-3d-anim" value="anim"> Go to XYZA Position and Animate Move</input>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <p class="options-heading">Pre-Upload Gcode to SPJS (Version 1.4 or higher of Serial Port JSON Server required)</p>
                        <p>Pre-Uploading gives the buffer a bunch of lines to work from to make sure you never starve your buffer. 100 lines is reasonable, but if you have a lot of small Gcode moves like in 3D printing a higher number may work. Up to 25,000
                            lines can be pre-loaded.</p>
                        <div class="form-group">
                            <div class="col-sm-10">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpUpload" id="com-chilipeppr-widget-gcode-option-upload-none" value="none" checked> No Pre-Uploading (Default)</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpUpload" id="com-chilipeppr-widget-gcode-option-upload-100" value="100"> Pre-Upload 100 Lines Into Buffer</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpUpload" id="com-chilipeppr-widget-gcode-option-upload-1000" value="1000"> Pre-Upload 1,000 Lines Into Buffer</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpUpload" id="com-chilipeppr-widget-gcode-option-upload-10000" value="10000"> Pre-Upload 10,000 Lines Into Buffer</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpUpload" id="com-chilipeppr-widget-gcode-option-upload-20000" value="20000"> Pre-Upload 20,000 Lines Into Buffer</input>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <p class="options-heading">Multi-Line Upload Mode</p>

                        <div class="form-group">
                            <div class="col-sm-10">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpMultiLineMode" id="com-chilipeppr-widget-gcode-option-multilinemode-no" value="yes"> Do Not Use Multi-Line Mode</input>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="grpMultiLineMode" id="com-chilipeppr-widget-gcode-option-multilinemode-yes" value="no" checked> Yes, Use Multi-Line Mode (Default)</input>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="input-group" style="width:160px;">
                            <input type="number" class="form-control" id="com-chilipeppr-widget-gcode-option-multiline" placeholder="Lines Per Send" value="50" />
                            <div class="input-group-addon">lines</div>
                        </div>
                        <p style="padding-top:6px;">How many lines to upload for each send to the Serial Port JSON Server. Since we're running in a browser and the user could be on a remote connection, sending 1 line at a time to the SPJS could be too slow based on your type of
                            Gcode and the speed of your network connection. 3D prints for example are 100's of 1,000's of lines of gcode with tiny movements. Since each send to the SPJS requires a receipt to ensure ordering, this roundtrip latency can
                            slow things down. One way to tackle this is to send multiple lines at a time. A good value is 50, but you can go up 20,000 if you'd like.</p>

                        <p class="options-heading">Delay Per Gcode Upload Event (i.e. per line)</p>

                        <div class="input-group" style="width:160px;">
                            <input type="number" class="form-control" id="com-chilipeppr-widget-gcode-option-delayPerLine" placeholder="milliseconds" value="1000" />
                            <div class="input-group-addon">ms</div>
                        </div>
                        <p style="padding-top:6px;">The default is now 1000 ms delay, i.e. 1 second and to use Multi-Line upload with roughly 50 lines. 100 lines is also fairly normal now. The reason this new default is recommended is that it seems to put the least load on the browser
                            so there are less round-trips to the Serial Port JSON Server. This setting also seems to stay ahead of the CNC controller nicely with most Gcode, so there's a constant set of available lines for the CNC controller to process.</p>
                        <p style="padding-top:6px;">If you are running version 1.4 or higher of the Serial Port JSON Server and you connected to your CNC controller with a buffer flow algorithm other than default (i.e. you chose the "tinyg" buffer algorithm when you connected to
                            your TinyG), you can set this value as low as 5ms. In practice, a setting such as 20ms seems to do the trick. The reason is, the SPJS can now queue up to 25,000 lines of Gcode (which can be higher if for some reason you want
                            1,000,000 lines to queue. Just download the Github project and compile.).</p>
                        <p>In version 1.4 and up, the server will directly manage the planner buffer rather than the browser. You may notice that significantly more lines of Gcode are sent in to the server than where your CNC controller is actually at. You
                            don't necessarily want too many lines sent in, but you want to make sure there's a really good buffer of lines as well. A good rule of thumb is to have the Serial Port JSON Server have 500 lines of Gcode in its buffer, i.e.
                            this Gcode widget is 500 lines ahead of where the CNC controller is actually at.</p>
                        <p>For controlling a serial port device without a buffer flow algorithm, you should use a setting like a 200ms delay between the sending of each Gcode line. However, if you are seeing that the CNC controller is being starved of commands,
                            and thus you are getting slow/choppy machining (especially on very small moves), you can lower this value by modifying this value here or forking this widget. The minimum value is 0. Be warned though, that by setting this value
                            too low you can overflow the buffer and lose lines of Gcode which of course will destroy your milling job.</p>
                        <p>You can also raise this value if you are finding your computer is too slow to process everything and you are seeing that commands are being sent too quickly and overflowing the planner buffer. The main method of flow control is
                            to get back a /plannerpause from the CNC controller widget. That makes the Gcode widget stop sending until it sees a /plannerresume. If there is contention in processing this command, increasing the delay per line gives time
                            for your CPU to process the command. Values like 200ms have been seen to work quite well for ensuring there is ample time on slower processors. However, a delay like 500ms can also result in very slow commands to your CNC controller
                            during small moves.</p>
                        <p>One final note, is that if you are running ChilPeppr on the same machine as your Serial Port JSON Server, you could find that you can run your job faster with less of a ms delay per line. Connecting over localhost is very fast
                            and no packet loss will occur.</p>

                        <p class="options-heading">Play/Pause/Stop Feedhold/Resume/Flush</p>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-ppsOnPlayFlush" value="ppsOnPlayFlush"> Send Queue Flush (%) on Play
                                <br/>
                                </input>
                            </label>
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-ppsOnStopFeedhold" value="ppsOnStopFeedhold"> Send Feedhold and Queue Flush (!%) on Stop
                                <br/>
                                </input>
                            </label>
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-ppsOnPauseFeedhold" value="ppsOnPauseFeedhold"> Send Feedhold (!) on Pause
                                <br/>
                                </input>
                            </label>
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-ppsOnUnpauseResume" value="ppsOnUnpauseResume"> Send Cycle Resume (~) on Unpause
                                <br/>
                                </input>
                            </label>
                        </div>

                        <p class="options-heading" style="padding-top:16px;">Tool Change (M6)</p>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-pauseOnM6" value="pauseOnM6"> Pause on M6 commands
                                <br/>
                                </input>
                            </label>
                        </div>

                        <p style="padding-top:6px;">To send Gcode after pausing, add it here. This can be for moving to a tool change position.</p>
                        <div class="input-group" style="width:300px;">
                            <textarea class="form-control" id="com-chilipeppr-widget-gcode-option-sendonM6" placeholder="Gcode"></textarea>
                        </div>
                        <p style="padding-top:6px;">To send Gcode before unpausing, add it here. This can be for moving back to the original position.</p>
                        <div class="input-group" style="width:300px;">
                            <textarea class="form-control" id="com-chilipeppr-widget-gcode-option-sendoffM6" placeholder="Gcode"></textarea>
                        </div>
                        <p style="padding-top:6px;">Definition of G-code to send as probe command in tool change dialog:</p>
                        <div class="input-group" style="width:300px;">
                            <textarea class="form-control" id="com-chilipeppr-widget-gcode-option-probe-cmd" placeholder="Gcode">G28.2 Z0</textarea>
                        </div>

                        <p class="options-heading" style="padding-top:16px;">Pre-Process Gcode</p>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-removeemptylines" value="removeemptylines"> Remove empty lines (Default On)
                                <br/>
                                </input>
                            </label>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-addlinenums" value="addlinenums"> Add line numbers <span class="com-chilipeppr-widget-gcode-option-addlinenums-default hidden">(Default is On)</span>
                                <br/>
                                </input>
                            </label>
                        </div>



                    </form>

                </div>

            </div>

        </div>

    </div>



    <div class="modal fade " id="com-chilipeppr-widget-gcode-toolchange-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="com-chilipeppr-widget-gcode-toolchange-heading">Tool Change (M6 <span id="com-chilipeppr-widget-gcode-toolnumber2">T??</span>)</h4>
                </div>
                <div class="modal-body">
                    <p>We reached a line in the Gcode that contains an M6 command. If you are manually changing tools then dismiss this dialog, change your tool, and hit the pause button to unpause your job.</p>

                    <div class="alert alert-info" role="alert">You must unpause after the tool change to resume your Gcode</div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="" id="com-chilipeppr-widget-gcode-option-pauseOnM6-alt" value="pauseOnM6"> Pause on M6 commands
                            <br/>(Can be changed later in options dialog for Gcode Widget)</input>
                        </label>
                    </div>
                    <span id="com-chilipeppr-widget-gcode-toolchange-debug"></span>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <!-- Modal for Out of Local Storage -->
    <div id="com-chilipeppr-widget-gcode-outofspace" class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel">Gcode Widget Out of Local Storage Space</h4>
                </div>
                <div class="modal-body">
                    <p>You are out of local storage space, so ChiliPeppr can't save your Gcode file. Please delete all of your local storage files for ChiliPeppr using the
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="hover" data-title="Drag and Drop" data-content="Drag a Gcode file onto your browser window to load it."><span class="glyphicon glyphicon-file"></span><span class="glyphicon glyphicon-share-alt" style="margin-left:-2px;color:#666666;"></span> <span class="caret"></span></button>                        in the workspace.</p>
                    <p>You can also ignore this error and proceed since ChiliPeppr will simply load your file into RAM and function perfectly fine. The only downside is if you reload ChiliPeppr, it won't have your most recent file loaded.</p>
                    <p>Browsers typically only allow for 5MB of local storage, which isn't much.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Units of Measurement Modal -->
    <div class="modal fade " id="com-chilipeppr-widget-gcode-uom-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                    <h4 class="modal-title">No Units Found in Your Gcode File</h4>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">ChiliPeppr was unable to automatically determine whether your file should run in inches (G20) or millimetres (G21).</div>
                    <p>This is important to ensure your job is cut at the proper size and to prevent your machine from trying to move further than it is capable and running into the end of an axis.</p>
                    <p>Please choose one of the units options below. The proper gcode command will be added as the first line of your gcode file.</p>

                    <div class="button">
                        <button type="button" class="btn btn-primary" id="inches-button" aria-hidden="true">Inches (G20)</button>&nbsp;&nbsp;
                        <button type="button" class="btn btn-primary" id="mm-button" aria-hidden="true">Millimetres (G21)</button>
                    </div>

                </div>
                <div class="modal-footer">
                    <!--<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>-->
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->


</body>

</html>